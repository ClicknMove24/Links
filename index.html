<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª ×–×™×”×•×™ ×‘×•×˜×™× ××ª×§×“××ª - ×¢×¦×××™×ª ×œ×—×œ×•×˜×™×Ÿ</title>
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
            padding: 40px 20px;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        
        .visitor-info {
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: right;
        }
        
        .visitor-info h3 {
            margin-top: 0;
            color: #ffd700;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .info-label {
            font-weight: bold;
            color: #ffd700;
        }
        
        .info-value {
            color: #e0e0e0;
            max-width: 60%;
            word-break: break-word;
        }
        
        .advanced-detection {
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .detection-score {
            font-size: 1.8em;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .confidence-bar {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .confidence-fill {
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .high-confidence { background: linear-gradient(90deg, #4CAF50, #81C784); }
        .medium-confidence { background: linear-gradient(90deg, #ff9800, #ffb74d); }
        .low-confidence { background: linear-gradient(90deg, #f44336, #ef5350); }
        
        .bot-indicator {
            font-size: 1.3em;
            font-weight: bold;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .human {
            background: rgba(0, 255, 0, 0.2);
            border: 2px solid #00ff00;
        }
        
        .suspicious {
            background: rgba(255, 165, 0, 0.2);
            border: 2px solid #ffa500;
        }
        
        .bot {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #ff0000;
        }
        
        .analytics-section {
            text-align: right;
            font-size: 0.9em;
            color: #b8d4f0;
            margin: 10px 0;
        }
        
        .real-time-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #ffd700;
        }
        
        .stat-label {
            font-size: 0.9em;
            margin-top: 5px;
            color: #e0e0e0;
        }
        
        .button {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.3s ease;
        }
        
        .button:hover {
            transform: scale(1.05);
        }
        
        .source-analysis {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: right;
        }
        
        .source-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .source-name {
            font-weight: bold;
            color: #ffd700;
        }
        
        .source-count {
            color: #4CAF50;
        }
        
        .session-timeline {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .timeline-item {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            font-size: 0.9em;
            text-align: right;
        }
        
        .timeline-time {
            color: #ffd700;
            font-weight: bold;
        }
        
        .warning {
            background: rgba(255, 152, 0, 0.2);
            border: 2px solid #ff9800;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #fff;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .real-time-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›¡ï¸ ××¢×¨×›×ª ×–×™×”×•×™ ×‘×•×˜×™× ××ª×§×“××ª</h1>
        <p style="font-size: 1.1em; margin-bottom: 20px; color: #b8d4f0;">
            ××¢×¨×›×ª ×–×™×”×•×™ ×¢×¦×××™×ª ×•××ª×§×“××ª - ×œ×œ× ×ª×œ×•×ª ×‘×¡×¤×¨×™×•×ª ×—×™×¦×•× ×™×•×ª
        </p>
        
        <div class="dashboard-grid">
            <!-- ××™×“×¢ ×¢×œ ×”××‘×§×¨ -->
            <div class="card">
                <div class="visitor-info">
                    <h3>ğŸ•µï¸ ××™×“×¢ ××‘×§×¨ × ×•×›×—×™</h3>
                    <div class="info-row">
                        <span class="info-label">×–××Ÿ ×›× ×™×¡×”:</span>
                        <span class="info-value" id="visit-time"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">××–×”×” ××‘×§×¨:</span>
                        <span class="info-value" id="visitor-id">×™×•×¦×¨...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">××–×”×” ×¡×©×Ÿ:</span>
                        <span class="info-value" id="session-id"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">×˜×‘×™×¢×ª ××¦×‘×¢:</span>
                        <span class="info-value" id="device-fingerprint">×™×•×¦×¨...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">×“×¤×“×¤×Ÿ:</span>
                        <span class="info-value" id="browser-info">××–×”×”...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">××§×•×¨ ×”×’×¢×”:</span>
                        <span class="info-value" id="referrer-info">×‘×•×“×§...</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">×’×•×“×œ ××¡×š:</span>
                        <span class="info-value" id="screen-size"></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">×–××Ÿ ×¢×œ ×”×“×£:</span>
                        <span class="info-value" id="time-on-page">0 ×©× ×™×•×ª</span>
                    </div>
                </div>
            </div>
            
            <!-- ×–×™×”×•×™ ×‘×•×˜×™× ××ª×§×“× -->
            <div class="card">
                <div class="advanced-detection">
                    <h3 style="color: #ffd700; margin-bottom: 15px;">ğŸ¤– ×ª×•×¦××•×ª ×–×™×”×•×™</h3>
                    
                    <div id="bot-detection" class="bot-indicator">
                        ğŸ” ××¨×™×¥ ×‘×“×™×§×•×ª ××ª×§×“××•×ª...
                    </div>
                    
                    <div class="detection-score">
                        <span>×¨××ª ×××™× ×•×ª: </span>
                        <span id="confidence-score" style="color: #4CAF50;">×—×•×©×‘...</span>
                    </div>
                    
                    <div class="confidence-bar">
                        <div id="confidence-fill" class="confidence-fill high-confidence" style="width: 0%"></div>
                    </div>
                    
                    <div id="advanced-results">
                        <div class="analytics-section">ğŸ”¬ ××¨×™×¥ ×‘×“×™×§×•×ª ××ª×§×“××•×ª...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª ×–××Ÿ ×××ª -->
        <div class="card">
            <h3 style="color: #ffd700; margin-bottom: 20px;">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª ×–××Ÿ ×××ª</h3>
            <div class="real-time-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-visitors">1</div>
                    <div class="stat-label">××‘×§×¨×™× ×‘×¡×©×Ÿ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="active-visitors" style="color: #4CAF50;">1</div>
                    <div class="stat-label">ğŸŸ¢ ×¤×¢×™×œ×™× ×›×¢×ª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="bot-detections">0</div>
                    <div class="stat-label">×‘×•×˜×™× ×–×•×”×•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="suspicious-activities">0</div>
                    <div class="stat-label">×¤×¢×™×œ×•×™×•×ª ×—×©×•×“×•×ª</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="button-clicks">0</div>
                    <div class="stat-label">×œ×—×™×¦×•×ª ×›×¤×ª×•×¨×™×</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="mouse-movements">0</div>
                    <div class="stat-label">×ª× ×•×¢×•×ª ×¢×›×‘×¨</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="page-interactions">0</div>
                    <div class="stat-label">××™× ×˜×¨××§×¦×™×•×ª</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" id="ml-samples" style="color: #9C27B0;">0</div>
                    <div class="stat-label">ğŸ§  ML ×“×’×™××•×ª</div>
                </div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <!-- ××©×ª××©×™× ×¤×¢×™×œ×™× -->
            <div class="card">
                <h3 style="color: #ffd700; margin-bottom: 15px;">ğŸ‘¥ ××©×ª××©×™× ×¤×¢×™×œ×™×</h3>
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; line-height: 1.4;">
                    ğŸ“± <strong>××™×š ×œ×‘×“×•×§ ×–×™×”×•×™ ×‘×–××Ÿ ×××ª:</strong><br>
                    1. ×©×œ×— ××ª ×”×§×™×©×•×¨ ×œ×˜×œ×¤×•×Ÿ/××›×©×™×¨ ××—×¨<br>
                    2. ××• ×¤×ª×— ×˜××‘ ×—×“×© ×‘××¦×‘ ×× ×•× ×™××™<br>
                    3. ×ª×¨××” ×”×ª×¨××” ×›×©××™×©×”×• × ×›× ×¡! ğŸ””
                </div>
                <div id="visitors-list" style="max-height: 200px; overflow-y: auto; text-align: right;">
                    <div class="visitor-item" style="padding: 8px; margin: 5px 0; background: rgba(255,255,255,0.1); border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                        <small style="opacity: 0.7;" id="current-user-time">×¢×›×©×™×•</small>
                        <span><span style="color: #4CAF50;">ğŸŸ¢</span> ××ª×” (××©×ª××© ×–×”)</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 style="color: #ffd700; margin-bottom: 15px;">ğŸŒ × ×™×ª×•×— ××§×•×¨×•×ª ×ª× ×•×¢×”</h3>
                <div class="source-analysis" id="source-analysis">
                    <div class="source-item">
                        <span class="source-name">×˜×•×¢×Ÿ × ×ª×•× ×™×...</span>
                        <span class="source-count">-</span>
                    </div>
                </div>
            </div>
            
            <!-- ×¦×™×¨ ×–××Ÿ ×©×œ ×”×¡×©×Ÿ -->
            <div class="card">
                <h3 style="color: #ffd700; margin-bottom: 15px;">â±ï¸ ×¦×™×¨ ×–××Ÿ ×”×¡×©×Ÿ</h3>
                <div class="session-timeline" id="session-timeline">
                    <div class="timeline-item">
                        <span class="timeline-time">×”×ª×—×œ×ª ×¡×©×Ÿ</span> - ××¢×¨×›×ª ××ª×—×™×œ×”
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ×¤×¨××˜×¨×™ UTM -->
        <div class="card">
            <h3 style="color: #ffd700; margin-bottom: 15px;">ğŸ”— ×¤×¨××˜×¨×™ ××¢×§×‘ (UTM)</h3>
            <div id="utm-params" style="text-align: right; font-family: monospace; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px;"></div>
        </div>
        
        <!-- ×‘×“×™×§×•×ª ××™× ×˜×¨××§×¦×™×” -->
        <div class="card">
            <h3 style="color: #ffd700; margin-bottom: 15px;">ğŸ”¬ ×‘×“×™×§×•×ª ××™× ×˜×¨××§×¦×™×”</h3>
            <button class="button" onclick="trackButtonClick('test_button_1')">ğŸ–±ï¸ ×‘×“×™×§×ª ×œ×—×™×¦×”</button>
            <button class="button" onclick="trackMouseMovement()">ğŸ­ ××¢×§×‘ ×¢×›×‘×¨</button>
            <button class="button" onclick="trackScrollBehavior()">ğŸ“œ ×‘×“×™×§×ª ×’×œ×™×œ×”</button>
            <button class="button" onclick="startAdvancedBehaviorTest()">ğŸ§ª ×‘×“×™×§×” ××ª×§×“××ª</button>
        </div>
        
        <!-- × ×™×”×•×œ × ×ª×•× ×™× -->
        <div class="card">
            <h3 style="color: #ffd700; margin-bottom: 15px;">ğŸ“ × ×™×”×•×œ × ×ª×•× ×™×</h3>
            <button class="button" onclick="downloadReport()" style="background: linear-gradient(45deg, #4CAF50, #66BB6A);">ğŸ“¥ ×”×•×¨×“ ×“×•×— JSON</button>
            <button class="button" onclick="downloadCSVReport()" style="background: linear-gradient(45deg, #2196F3, #42A5F5);">ğŸ“Š ×”×•×¨×“ ×“×•×— CSV</button>
            <button class="button" onclick="clearAllData()" style="background: linear-gradient(45deg, #f44336, #ef5350);">ğŸ—‘ï¸ × ×§×” × ×ª×•× ×™×</button>
            <button class="button" onclick="showDataSummary()" style="background: linear-gradient(45deg, #FF9800, #FFB74D);">ğŸ“‹ ×¡×™×›×•× × ×ª×•× ×™×</button>
            
            <!-- ×”×¢×œ××ª ×§×•×‘×¥ ×œ×•×’×™× -->
            <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 10px;">
                <h4 style="color: #ffd700; margin-bottom: 10px;">ğŸ“‚ × ×™×ª×•×— ×œ×•×’×™×</h4>
                <input type="file" id="logsFileInput" accept=".json" style="display: none;" onchange="handleLogsUpload(event)">
                <button class="button" onclick="document.getElementById('logsFileInput').click()" style="background: linear-gradient(45deg, #9C27B0, #BA68C8);">ğŸ“¤ ×”×¢×œ×” ×§×•×‘×¥ JSON</button>
                <button class="button" onclick="analyzeUploadedLogs()" style="background: linear-gradient(45deg, #607D8B, #78909C);" id="analyzeBtn" disabled>ğŸ” × ×ª×— ×œ×•×’×™×</button>
                <div id="uploadStatus" style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;"></div>
            </div>
        </div>
        
        <!-- ××–×”×¨×•×ª -->
        <div id="warnings-container"></div>
        
        <!-- ×ª×•×¦××•×ª × ×™×ª×•×— ×œ×•×’×™× -->
        <div id="logsAnalysisResults" style="display: none; margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 15px;">
            <h3 style="color: #ffd700; margin-bottom: 20px;">ğŸ“Š ×ª×•×¦××•×ª × ×™×ª×•×— ×”×œ×•×’×™×</h3>
            <div id="analysisContent"></div>
        </div>
    </div>

    <script>
        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        let sessionId = generateSessionId();
        let visitorId = getOrCreateVisitorId();
        let deviceFingerprint = null;
        let analyticsData = [];
        let realTimeStats = {
            totalVisitors: 1,
            botDetections: 0,
            suspiciousActivities: 0,
            buttonClicks: 0,
            mouseMovements: 0,
            pageInteractions: 0,
            activeVisitors: 1
        };
        
        // ××¢×¨×›×ª ××¢×§×‘ ××©×ª××©×™× ×‘×–××Ÿ ×××ª
        let activeVisitors = new Map();
        let lastHeartbeat = Date.now();
        
        // × ×ª×•× ×™ ×œ×•×’×™× ×©×”×•×¢×œ×•
        let uploadedLogs = null;
        let behaviorAnalysis = {
            mouseMovements: [],
            clicks: [],
            scrollEvents: [],
            keystrokes: []
        };
        let sourceTracking = {};
        let sessionTimeline = [];
        let startTime = Date.now();
        
        // ×™×¦×™×¨×ª ××–×”×” ×¡×©×Ÿ ×™×™×—×•×“×™
        function generateSessionId() {
            return 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        // ×§×‘×œ×ª ××• ×™×¦×™×¨×ª ××–×”×” ××‘×§×¨
        function getOrCreateVisitorId() {
            let vid = localStorage.getItem('visitor_id');
            if (!vid) {
                vid = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('visitor_id', vid);
            }
            return vid;
        }
        
        // ×™×¦×™×¨×ª ×˜×‘×™×¢×ª ××¦×‘×¢ ×¢×¦×××™×ª
        function createDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('ğŸ¤– Bot Detection Test', 2, 2);
            
            const fingerprint = [
                navigator.userAgent,
                navigator.language,
                screen.width + 'x' + screen.height,
                screen.colorDepth,
                new Date().getTimezoneOffset(),
                navigator.platform,
                navigator.cookieEnabled,
                typeof(Worker),
                canvas.toDataURL()
            ].join('|');
            
            // ×™×¦×™×¨×ª hash ×¤×©×•×˜
            let hash = 0;
            for (let i = 0; i < fingerprint.length; i++) {
                const char = fingerprint.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            
            return 'fp_' + Math.abs(hash).toString(36);
        }
        
        // ××¢×¨×›×ª Analytics ××•×ª×××ª - ×¢×¦×××™×ª ×œ×—×œ×•×˜×™×Ÿ
        function logAnalyticsEvent(eventType, data) {
            const event = {
                type: eventType,
                timestamp: Date.now(),
                session_id: sessionId,
                visitor_id: visitorId,
                url: window.location.href,
                referrer: document.referrer,
                user_agent: navigator.userAgent,
                screen_resolution: screen.width + 'x' + screen.height,
                device_fingerprint: deviceFingerprint,
                ...data
            };
            
            // ×©××™×¨×” ×‘-localStorage
            analyticsData.push(event);
            if (analyticsData.length > 1000) {
                analyticsData.shift();
            }
            localStorage.setItem('custom_analytics', JSON.stringify(analyticsData));
            
            // ×¢×“×›×•×Ÿ ×¦×™×¨ ×”×–××Ÿ
            addToTimeline(eventType, data);
            
            // ×¢×™×‘×•×“ × ×ª×•× ×™×
            processAnalyticsData(event);
            
            console.log('ğŸ“Š Analytics Event:', event);
        }
        
        // ×”×•×¡×¤×” ×œ×¦×™×¨ ×”×–××Ÿ
        function addToTimeline(eventType, data) {
            const time = new Date().toLocaleTimeString('he-IL');
            let description = '';
            
            switch(eventType) {
                case 'page_view':
                    description = '×›× ×™×¡×” ×œ×“×£';
                    break;
                case 'button_click':
                    description = `×œ×—×™×¦×” ×¢×œ ×›×¤×ª×•×¨: ${data.button_name}`;
                    realTimeStats.pageInteractions++;
                    break;
                case 'mouse_movement':
                    description = `×ª× ×•×¢×ª ×¢×›×‘×¨ (${data.move_count})`;
                    if (data.move_count % 50 === 0) {
                        realTimeStats.mouseMovements += 50;
                    }
                    break;
                case 'suspicious_behavior':
                    description = `×”×ª× ×”×’×•×ª ×—×©×•×“×”: ${data.patterns}`;
                    realTimeStats.suspiciousActivities++;
                    break;
                case 'bot_detection':
                    if (data.bot_score > 50) {
                        description = `×–×•×”×” ×‘×•×˜ (×¦×™×•×Ÿ: ${data.bot_score})`;
                        realTimeStats.botDetections++;
                    } else {
                        description = `×–×•×”×” ××©×ª××© ×××™×ª×™ (×¦×™×•×Ÿ: ${data.bot_score})`;
                    }
                    break;
                default:
                    description = eventType;
            }
            
            sessionTimeline.push({
                time: time,
                event: eventType,
                description: description,
                timestamp: Date.now()
            });
            
            if (sessionTimeline.length > 20) {
                sessionTimeline.shift();
            }
            
            updateTimelineDisplay();
            updateRealTimeStatsDisplay();
        }
        
        // ×¢×“×›×•×Ÿ ×ª×¦×•×’×ª ×¦×™×¨ ×”×–××Ÿ
        function updateTimelineDisplay() {
            const timelineElement = document.getElementById('session-timeline');
            timelineElement.innerHTML = '';
            
            sessionTimeline.slice().reverse().forEach(item => {
                const div = document.createElement('div');
                div.className = 'timeline-item';
                div.innerHTML = `<span class="timeline-time">${item.time}</span> - ${item.description}`;
                timelineElement.appendChild(div);
            });
        }
        
        // ×¢×“×›×•×Ÿ ×ª×¦×•×’×ª ×¡×˜×˜×™×¡×˜×™×§×•×ª
        function updateRealTimeStatsDisplay() {
            Object.keys(realTimeStats).forEach(key => {
                const elementId = key.replace(/([A-Z])/g, '-$1').toLowerCase();
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = realTimeStats[key];
                }
            });
            
            // ×¢×“×›×•×Ÿ ML samples
            const mlSamplesElement = document.getElementById('ml-samples');
            if (mlSamplesElement) {
                const mlStats = getMLModelStats();
                mlSamplesElement.textContent = mlStats.samples_count;
                
                // ×©×™× ×•×™ ×¦×‘×¢ ×œ×¤×™ ××¡×¤×¨ ×”×“×’×™××•×ª
                if (mlStats.samples_count >= 100) {
                    mlSamplesElement.style.color = '#4CAF50'; // ×™×¨×•×§ - ××¡×¤×™×§ ×“×’×™××•×ª
                } else if (mlStats.samples_count >= 50) {
                    mlSamplesElement.style.color = '#FF9800'; // ×›×ª×•× - ×‘×™× ×•× ×™
                } else {
                    mlSamplesElement.style.color = '#9C27B0'; // ×¡×’×•×œ - ××¢×˜
                }
            }
        }
        
        // ×¢×™×‘×•×“ × ×ª×•× ×™×
        function processAnalyticsData(event) {
            analyzeTrafficSources(event);
            detectSuspiciousPatterns();
        }
        
        // × ×™×ª×•×— ××§×•×¨×•×ª ×ª× ×•×¢×”
        function analyzeTrafficSources(event) {
            let source = 'direct';
            
            if (event.referrer) {
                try {
                    const referrerDomain = new URL(event.referrer).hostname;
                    if (referrerDomain.includes('google')) source = 'google';
                    else if (referrerDomain.includes('facebook')) source = 'facebook';
                    else if (referrerDomain.includes('instagram')) source = 'instagram';
                    else if (referrerDomain.includes('twitter')) source = 'twitter';
                    else if (referrerDomain.includes('linkedin')) source = 'linkedin';
                    else if (referrerDomain.includes('whatsapp')) source = 'whatsapp';
                    else if (referrerDomain.includes('telegram')) source = 'telegram';
                    else source = referrerDomain;
                } catch (e) {
                    source = 'unknown';
                }
            }
            
            const utmSource = new URLSearchParams(window.location.search).get('utm_source');
            if (utmSource) {
                source = utmSource;
            }
            
            if (!sourceTracking[source]) {
                sourceTracking[source] = 0;
            }
            sourceTracking[source]++;
            
            updateSourceDisplay();
        }
        
        // ×¢×“×›×•×Ÿ ×ª×¦×•×’×ª ××§×•×¨×•×ª
        function updateSourceDisplay() {
            const sourceElement = document.getElementById('source-analysis');
            sourceElement.innerHTML = '';
            
            Object.entries(sourceTracking)
                .sort((a, b) => b[1] - a[1])
                .forEach(([source, count]) => {
                    const div = document.createElement('div');
                    div.className = 'source-item';
                    div.innerHTML = `
                        <span class="source-name">${getSourceDisplayName(source)}</span>
                        <span class="source-count">${count}</span>
                    `;
                    sourceElement.appendChild(div);
                });
        }
        
        // ×©××•×ª ×ª×¦×•×’×” ×œ××§×•×¨×•×ª
        function getSourceDisplayName(source) {
            const names = {
                'direct': 'ğŸ”— ×’×™×©×” ×™×©×™×¨×”',
                'google': 'ğŸ” ×’×•×’×œ',
                'facebook': 'ğŸ“˜ ×¤×™×™×¡×‘×•×§',
                'instagram': 'ğŸ“· ××™× ×¡×˜×’×¨×',
                'twitter': 'ğŸ¦ ×˜×•×•×™×˜×¨',
                'linkedin': 'ğŸ’¼ ×œ×™× ×§×“××™×Ÿ',
                'whatsapp': 'ğŸ’¬ ×•×•×˜×¡××¤',
                'telegram': 'âœˆï¸ ×˜×œ×’×¨×',
                'unknown': 'â“ ×œ× ×™×“×•×¢'
            };
            return names[source] || `ğŸŒ ${source}`;
        }
        
        // ×–×™×”×•×™ ×“×¤×•×¡×™× ×—×©×•×“×™×
        function detectSuspiciousPatterns() {
            const recentEvents = analyticsData.filter(e => Date.now() - e.timestamp < 60000);
            const warnings = [];
            
            const clicks = recentEvents.filter(e => e.type === 'button_click');
            if (clicks.length > 10) {
                warnings.push('ğŸš¨ ×™×•×ª×¨ ××“×™ ×œ×—×™×¦×•×ª ×‘×“×§×” ××—×¨×•× ×”');
            }
            
            const interactions = recentEvents.filter(e => 
                ['button_click', 'mouse_movement', 'scroll_behavior'].includes(e.type)
            );
            if (recentEvents.length > 5 && interactions.length === 0) {
                warnings.push('âš ï¸ ×¤×¢×™×œ×•×ª ×œ×œ× ××™× ×˜×¨××§×¦×™×•×ª ××©×ª××©');
            }
            
            displayWarnings(warnings);
        }
        
        // ×”×¦×’×ª ××–×”×¨×•×ª
        function displayWarnings(warnings) {
            const warningsContainer = document.getElementById('warnings-container');
            warningsContainer.innerHTML = '';
            
            warnings.forEach(warning => {
                const div = document.createElement('div');
                div.className = 'warning';
                div.textContent = warning;
                warningsContainer.appendChild(div);
            });
        }
        
        // ×–×™×”×•×™ ×‘×•×˜×™× ×¢×¦×××™ ×•××ª×§×“×
        function detectAdvancedBot() {
            let botScore = 0;
            let confidence = 100;
            let reasons = [];
            let detectionMethods = [];
            
            // 1. × ×™×ª×•×— User Agent ××ª×§×“×
            const ua = navigator.userAgent;
            const botKeywords = [
                'bot', 'crawler', 'spider', 'scraper', 'headless', 'phantom',
                'selenium', 'webdriver', 'automation', 'puppeteer', 'playwright',
                'googlebot', 'bingbot', 'slurp', 'duckduckbot', 'baiduspider'
            ];
            
            const foundBotKeywords = botKeywords.filter(keyword => ua.toLowerCase().includes(keyword));
            if (foundBotKeywords.length > 0) {
                botScore += 60;
                reasons.push(`ğŸ•µï¸ User Agent ×—×©×•×“: ${foundBotKeywords.join(', ')}`);
                detectionMethods.push('UA Analysis');
            }
            
            // 2. ×‘×“×™×§×ª WebDriver
            if (navigator.webdriver) {
                botScore += 50;
                reasons.push('ğŸš— WebDriver ×–×•×”×”');
                detectionMethods.push('WebDriver Detection');
            }
            
            // 3. ×‘×“×™×§×ª window properties ×—×©×•×“×™×
            const suspiciousProps = ['webdriver', '_phantom', 'callPhantom', '_selenium', 'selenium', 'domAutomation'];
            suspiciousProps.forEach(prop => {
                if (window[prop]) {
                    botScore += 20;
                    reasons.push(`âš ï¸ × ××¦× ${prop}`);
                    detectionMethods.push('Environment Check');
                }
            });
            
            // 4. ×‘×“×™×§×ª plugins
            if (navigator.plugins.length === 0) {
                botScore += 15;
                reasons.push('ğŸ”Œ ××™×Ÿ plugins ×‘×“×¤×“×¤×Ÿ');
                detectionMethods.push('Plugin Check');
            }
            
            // 5. ×‘×“×™×§×ª languages
            if (!navigator.languages || navigator.languages.length === 0) {
                botScore += 10;
                reasons.push('ğŸŒ ×—×¡×¨ ××™×“×¢ ×©×¤×•×ª');
                detectionMethods.push('Language Check');
            }
            
            // 6. ×‘×“×™×§×ª ×¨×–×•×œ×•×¦×™×”
            if (screen.width === 0 || screen.height === 0) {
                botScore += 25;
                reasons.push('ğŸ“º ×¨×–×•×œ×•×¦×™×™×ª ××¡×š ×œ× ×ª×§×™× ×”');
                detectionMethods.push('Screen Check');
            }
            
            // 7. ×‘×“×™×§×ª timezone
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            if (!timezone || timezone === 'UTC') {
                botScore += 10;
                reasons.push('ğŸŒ ××–×•×¨ ×–××Ÿ ×—×©×•×“');
                detectionMethods.push('Timezone Check');
            }
            
            // 8. ×‘×“×™×§×ª Canvas
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillText('Bot Detection Test ğŸ¤–', 2, 2);
                const canvasData = canvas.toDataURL();
                
                if (canvasData.length < 100) {
                    botScore += 30;
                    reasons.push('ğŸ–¼ï¸ Canvas ×¨×™×§ ××• ×—×¡×•×');
                    detectionMethods.push('Canvas Check');
                }
            } catch (e) {
                botScore += 25;
                reasons.push('ğŸ–¼ï¸ ×©×’×™××” ×‘-Canvas');
                detectionMethods.push('Canvas Error');
            }
            
            // 9. ×‘×“×™×§×ª WebGL
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (!gl) {
                    botScore += 15;
                    reasons.push('ğŸ® ××™×Ÿ ×ª××™×›×” ×‘-WebGL');
                    detectionMethods.push('WebGL Check');
                }
            } catch (e) {
                botScore += 10;
                reasons.push('ğŸ® ×©×’×™××” ×‘-WebGL');
                detectionMethods.push('WebGL Error');
            }
            
            // 10. ×‘×“×™×§×ª ×–×× ×™ ×˜×¢×™× ×”
            if (performance && performance.timing) {
                const loadTime = performance.timing.loadEventEnd - performance.timing.navigationStart;
                if (loadTime < 100) {
                    botScore += 20;
                    reasons.push(`âš¡ ×˜×¢×™× ×” ××”×™×¨×” ×—×¨×™×’×”: ${loadTime}ms`);
                    detectionMethods.push('Timing Analysis');
                }
            }

            // 11. ×‘×“×™×§×ª ×××¤×™×™× ×™ ×“×¤×“×¤×Ÿ ××ª×§×“××™×
            if (navigator.hardwareConcurrency > 16) {
                botScore += 10;
                reasons.push(`ğŸ’» ××¢×‘×“×™× ×¨×‘×™× ×—×¨×™×’×™×: ${navigator.hardwareConcurrency}`);
                detectionMethods.push('Hardware Check');
            }

            // 12. ×‘×“×™×§×ª DeviceMemory
            if (navigator.deviceMemory && navigator.deviceMemory > 32) {
                botScore += 5;
                reasons.push(`ğŸ’¾ ×–×™×›×¨×•×Ÿ ×’×“×•×œ ×—×¨×™×’: ${navigator.deviceMemory}GB`);
                detectionMethods.push('Memory Check');
            }

            // 13. ×‘×“×™×§×ª Headless ×“×¤×“×¤×Ÿ
            if (window.outerWidth === 0 || window.outerHeight === 0) {
                botScore += 30;
                reasons.push('ğŸ–¥ï¸ ×—×œ×•×Ÿ ×œ×œ× ×’×•×“×œ (Headless)');
                detectionMethods.push('Headless Check');
            }

            // 14. ×‘×“×™×§×ª ××”×™×¨×•×ª ×¢×™×‘×•×“ JavaScript
            const startTime = performance.now();
            for (let i = 0; i < 100000; i++) { /* empty loop */ }
            const endTime = performance.now();
            const jsSpeed = endTime - startTime;
            
            if (jsSpeed < 1) {
                botScore += 15;
                reasons.push(`âš¡ JavaScript ××”×™×¨ ××“×™: ${jsSpeed.toFixed(2)}ms`);
                detectionMethods.push('JS Speed Test');
            }

            // 15. ×‘×“×™×§×ª ×—×ª×™××” ×“×™×’×™×˜×œ×™×ª ×©×œ ×“×¤×“×¤×Ÿ
            const browserFingerprint = [
                navigator.userAgent,
                navigator.platform,
                navigator.language,
                screen.colorDepth,
                new Date().getTimezoneOffset(),
                navigator.cookieEnabled
            ].join('|');
            
            // ×‘×“×™×§×” ×¤×©×•×˜×” ×©×œ ×—×ª×™××•×ª ×™×“×•×¢×•×ª ×©×œ ×‘×•×˜×™×
            const knownBotFingerprints = [
                'headless', 'phantomjs', 'selenium', 'webdriver'
            ];
            
            if (knownBotFingerprints.some(fp => browserFingerprint.toLowerCase().includes(fp))) {
                botScore += 25;
                reasons.push('ğŸ” ×—×ª×™××” ×“×™×’×™×˜×œ×™×ª ×—×©×•×“×”');
                detectionMethods.push('Fingerprint Analysis');
            }

            // 16. ×‘×“×™×§×ª ×¨×›×™×‘×™ CSS ××ª×§×“××ª
            try {
                const testElement = document.createElement('div');
                testElement.style.cssText = 'position:absolute;left:-9999px;width:1px;height:1px;';
                document.body.appendChild(testElement);
                
                const computedStyle = window.getComputedStyle(testElement);
                if (!computedStyle || computedStyle.width !== '1px') {
                    botScore += 15;
                    reasons.push('ğŸ’… CSS rendering ×—×¨×™×’');
                    detectionMethods.push('CSS Test');
                }
                
                document.body.removeChild(testElement);
            } catch (e) {
                botScore += 10;
                reasons.push('ğŸ’… ×©×’×™××ª CSS');
                detectionMethods.push('CSS Error');
            }

            // 17. ×‘×“×™×§×ª Event Handling
            let eventTestScore = 0;
            const events = ['click', 'mousemove', 'keydown', 'scroll'];
            events.forEach(eventType => {
                try {
                    const event = new Event(eventType);
                    if (!event || typeof event.isTrusted === 'undefined') {
                        eventTestScore += 5;
                    }
                } catch (e) {
                    eventTestScore += 10;
                }
            });
            
            if (eventTestScore > 0) {
                botScore += eventTestScore;
                reasons.push('âš¡ Event handling ×—×¨×™×’');
                detectionMethods.push('Event Test');
            }

            // 18. ×‘×“×™×§×ª Audio Context (Web Audio API)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                
                if (!oscillator || !audioContext.sampleRate) {
                    botScore += 15;
                    reasons.push('ğŸ”Š Audio API ×—×¨×™×’');
                    detectionMethods.push('Audio Test');
                }
                
                audioContext.close();
            } catch (e) {
                botScore += 10;
                reasons.push('ğŸ”Š ×©×’×™××ª Audio');
                detectionMethods.push('Audio Error');
            }

            // 19. ×‘×“×™×§×ª Battery API (×× ×–××™×Ÿ)
            if (navigator.getBattery) {
                try {
                    navigator.getBattery().then(battery => {
                        if (!battery || typeof battery.level === 'undefined') {
                            botScore += 5;
                            reasons.push('ğŸ”‹ Battery API ×—×¨×™×’');
                            detectionMethods.push('Battery Test');
                        }
                    }).catch(() => {
                        // ×œ× ×§×¨×™×˜×™
                    });
                } catch (e) {
                    // ×œ× ×§×¨×™×˜×™
                }
            }

            // 20. ×‘×“×™×§×ª Notification API
            if ('Notification' in window) {
                try {
                    if (Notification.permission !== 'default' && 
                        Notification.permission !== 'granted' && 
                        Notification.permission !== 'denied') {
                        botScore += 10;
                        reasons.push('ğŸ”” Notification API ×—×¨×™×’');
                        detectionMethods.push('Notification Test');
                    }
                } catch (e) {
                    botScore += 5;
                    reasons.push('ğŸ”” ×©×’×™××ª Notification');
                    detectionMethods.push('Notification Error');
                }
            }
            
            // ML Ensemble Detection (××‘×•×¡×¡ ××—×§×¨ 2024)
            const ensembleResult = ensembleDetection();
            const mlWeight = 0.4; // 40% ××©×§×œ ×œ××•×“×œ ML
            const classicWeight = 0.6; // 60% ××©×§×œ ×œ×‘×“×™×§×•×ª ×§×œ××¡×™×•×ª
            
            // ×©×™×œ×•×‘ ×¦×™×•×Ÿ ×§×œ××¡×™ ×¢× ML
            const combinedScore = (botScore * classicWeight) + (ensembleResult.score * mlWeight);
            
            // ×‘×“×™×§×ª ×¤×¢×™×œ×•×ª ××©×ª××© ×××™×ª×™×ª
            const humanActivityScore = calculateHumanActivity();
            if (humanActivityScore > 0) {
                botScore = Math.max(0, combinedScore - humanActivityScore);
                reasons.push(`âœ… ×¤×¢×™×œ×•×ª ×× ×•×©×™×ª ×–×•×”×ª×” (×”× ×—×”: ${humanActivityScore})`);
                detectionMethods.push('Human Activity');
            } else {
                botScore = combinedScore;
            }
            
            // ×”×•×¡×¤×ª ML methods ×œ×¨×©×™××”
            detectionMethods.push(...ensembleResult.methods.map(m => `ML-${m}`));
            reasons.push(`ğŸ§  ML Ensemble Score: ${ensembleResult.score.toFixed(1)}`);
            
            // ×¢×“×›×•×Ÿ confidence ×‘×”×ª×× ×œ××•×“×œ ML
            confidence = Math.min(confidence, ensembleResult.confidence);

            // ×—×™×©×•×‘ ×¦×™×•×Ÿ ×¡×•×¤×™ ×•×¨××ª ×‘×™×˜×—×•×Ÿ
            botScore = Math.min(botScore, 100);
            
            if (botScore >= 70) {
                confidence = 95;
            } else if (botScore >= 40) {
                confidence = 75;
            } else if (botScore >= 20) {
                confidence = 60;
            } else {
                confidence = 90;
            }
            
            // ×¢×“×›×•×Ÿ ×××©×§ ×”××©×ª××©
            updateBotDetectionUI(botScore, confidence, reasons, detectionMethods);
            
            // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×‘×•×˜ ×‘××¢×¨×›×ª ××©×ª××©×™× ×¤×¢×™×œ×™×
            const isBot = botScore >= 70;
            updateVisitorBotStatus(isBot);
            
            // ×œ×•×’ ×œ×§×•× ×¡×•×œ
            console.log(`ğŸ¤– ×¢×“×›×•×Ÿ ×¦×™×•×Ÿ ×‘×•×˜: ${botScore}/100 | ×××™× ×•×ª: ${confidence}%`);
            console.log(`ğŸ“Š ×¤×¢×™×œ×•×ª ×× ×•×©×™×ª: ${humanActivityScore} × ×§×•×“×•×ª`);
            console.log(`ğŸ” ×©×™×˜×•×ª ×–×™×”×•×™: ${detectionMethods.join(', ')}`);
            
            // ××™×¡×•×£ × ×ª×•× ×™ training ×œ××•×“×œ ML
            collectTrainingData(botScore, detectionMethods, humanActivityScore);
            
            // ×©×œ×™×—×” ×œ××¢×¨×›×ª Analytics
            logAnalyticsEvent('bot_detection', {
                'bot_score': botScore,
                'confidence': confidence,
                'human_activity_score': humanActivityScore,
                'is_bot': isBot,
                'ml_ensemble_score': ensembleResult.score,
                'detection_methods': detectionMethods.join(','),
                'reasons': reasons.join(';')
            });
        }
        
        // ML Score Calculation - Machine Learning ××•×ª×× ×œ×“×¤×“×¤×Ÿ
        function calculateMLBotScore(features) {
            // ××©×§×œ×™× ×©× ×•×¦×¨×• ×¢×œ ×‘×¡×™×¡ ××—×§×¨ 2024
            const weights = {
                userAgent: 0.15,
                webdriver: 0.20,
                canvas: 0.12,
                timing: 0.10,
                behavior: 0.25,
                apis: 0.08,
                fingerprint: 0.10
            };
            
            let mlScore = 0;
            
            // Feature engineering ××‘×•×¡×¡ ××—×§×¨
            if (features.userAgentSuspicious) mlScore += weights.userAgent * 100;
            if (features.webdriverDetected) mlScore += weights.webdriver * 100;
            if (features.canvasBlocked) mlScore += weights.canvas * 100;
            if (features.suspiciousTiming) mlScore += weights.timing * 100;
            if (features.behaviorScore < 0.3) mlScore += weights.behavior * 100;
            if (features.apisBlocked) mlScore += weights.apis * 100;
            if (features.fingerprintMatch) mlScore += weights.fingerprint * 100;
            
            return Math.min(mlScore, 100);
        }

        // Advanced Ensemble Detection (××‘×•×¡×¡ ××—×§×¨ 2024)
        function ensembleDetection() {
            const detectionResults = [];
            
            // Decision Tree approach
            const dtScore = calculateDecisionTreeScore();
            detectionResults.push({ method: 'DecisionTree', score: dtScore, weight: 0.3 });
            
            // Random Forest approach  
            const rfScore = calculateRandomForestScore();
            detectionResults.push({ method: 'RandomForest', score: rfScore, weight: 0.4 });
            
            // Neural Network approach (simplified)
            const nnScore = calculateNeuralNetworkScore();
            detectionResults.push({ method: 'NeuralNetwork', score: nnScore, weight: 0.3 });
            
            // Ensemble voting
            const finalScore = detectionResults.reduce((sum, result) => 
                sum + (result.score * result.weight), 0);
            
            return {
                score: finalScore,
                confidence: calculateEnsembleConfidence(detectionResults),
                methods: detectionResults.map(r => r.method)
            };
        }

        function calculateDecisionTreeScore() {
            // Decision tree logic ××‘×•×¡×¡ ××—×§×¨
            if (navigator.webdriver) return 95;
            if (navigator.plugins.length === 0 && !('ontouchstart' in window)) return 85;
            if (window.outerWidth === 0 || window.outerHeight === 0) return 90;
            
            // Canvas test
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.fillText('test', 10, 10);
            if (canvas.toDataURL().length < 100) return 80;
            
            return 20; // Likely human
        }

        function calculateRandomForestScore() {
            // Random Forest approach ×¢× multiple trees
            const trees = [];
            
            // Tree 1: User Agent Analysis
            let tree1Score = 0;
            const ua = navigator.userAgent.toLowerCase();
            if (ua.includes('headless')) tree1Score = 90;
            else if (ua.includes('automation')) tree1Score = 80;
            else if (ua.includes('bot')) tree1Score = 85;
            else tree1Score = 15;
            trees.push(tree1Score);
            
            // Tree 2: API Availability
            let tree2Score = 0;
            const apis = ['WebGL', 'AudioContext', 'Notification'];
            const availableApis = apis.filter(api => window[api]).length;
            tree2Score = availableApis < 2 ? 70 : 10;
            trees.push(tree2Score);
            
            // Tree 3: Timing Analysis
            let tree3Score = 0;
            const startTime = performance.now();
            for(let i = 0; i < 10000; i++) {} // Simple computation
            const endTime = performance.now();
            tree3Score = (endTime - startTime) < 1 ? 75 : 20;
            trees.push(tree3Score);
            
            // Average of trees
            return trees.reduce((a, b) => a + b, 0) / trees.length;
        }

        function calculateNeuralNetworkScore() {
            // Simplified Neural Network (3 layers)
            const inputs = [
                navigator.hardwareConcurrency / 16, // Normalized
                navigator.plugins.length / 10, // Normalized
                window.outerWidth / 2000, // Normalized
                (navigator.languages || []).length / 5, // Normalized
                screen.colorDepth / 32 // Normalized
            ];
            
            // Hidden layer weights (××‘×•×¡×¡ ×¢×œ ××—×§×¨)
            const weights1 = [
                [0.5, -0.8, 0.3, 0.7, -0.4],
                [-0.6, 0.9, -0.2, 0.1, 0.8],
                [0.4, -0.3, 0.6, -0.5, 0.2]
            ];
            
            // Hidden layer calculation
            const hidden = weights1.map(neuronWeights => {
                const sum = inputs.reduce((acc, input, i) => acc + input * neuronWeights[i], 0);
                return 1 / (1 + Math.exp(-sum)); // Sigmoid activation
            });
            
            // Output weights
            const outputWeights = [0.8, -0.6, 0.4];
            const output = hidden.reduce((acc, val, i) => acc + val * outputWeights[i], 0);
            
            // Convert to bot score (0-100)
            return Math.max(0, Math.min(100, output * 100));
        }

        function calculateEnsembleConfidence(results) {
            const scores = results.map(r => r.score);
            const mean = scores.reduce((a, b) => a + b) / scores.length;
            const variance = scores.reduce((sum, score) => sum + Math.pow(score - mean, 2), 0) / scores.length;
            
            // Lower variance = higher confidence
            return Math.max(70, Math.min(99, 100 - Math.sqrt(variance)));
        }

        // ×—×™×©×•×‘ ×¤×¢×™×œ×•×ª ×× ×•×©×™×ª ××ª×§×“×
        function calculateHumanActivity() {
            let humanScore = 0;
            const now = Date.now();
            
            // 1. × ×™×ª×•×— ×“×¤×•×¡×™ ×œ×—×™×¦×”
            if (behaviorAnalysis.clicks.length > 0) {
                const clickPattern = analyzeClickPattern(behaviorAnalysis.clicks);
                humanScore += clickPattern.humanLikeScore;
            }
            
            // 2. × ×™×ª×•×— ×ª× ×•×¢×ª ×¢×›×‘×¨
            if (behaviorAnalysis.mouseMovements.length > 10) {
                const mousePattern = analyzeMouseMovement(behaviorAnalysis.mouseMovements);
                humanScore += mousePattern.humanLikeScore;
            }
            
            // 3. × ×™×ª×•×— ×“×¤×•×¡×™ ×’×œ×™×œ×”
            if (behaviorAnalysis.scrollEvents.length > 0) {
                const scrollPattern = analyzeScrollBehavior(behaviorAnalysis.scrollEvents);
                humanScore += scrollPattern.humanLikeScore;
            }
            
            // 4. ×‘×“×™×§×ª ×–××Ÿ ×©×”×™×™×” ×‘×“×£
            const timeOnPage = now - startTime;
            if (timeOnPage > 5000) { // ×™×•×ª×¨ ×-5 ×©× ×™×•×ª
                humanScore += Math.min(timeOnPage / 1000, 15); // ×¢×“ 15 × ×§×•×“×•×ª
            }
            
            // 5. ×‘×“×™×§×ª ××’×•×•×Ÿ ×¤×¢×™×œ×•×™×•×ª
            const activityTypes = [];
            if (realTimeStats.buttonClicks > 0) activityTypes.push('clicks');
            if (realTimeStats.mouseMovements > 50) activityTypes.push('mouse');
            if (realTimeStats.pageInteractions > 0) activityTypes.push('interactions');
            
            if (activityTypes.length >= 2) {
                humanScore += 10; // ×‘×•× ×•×¡ ×œ××’×•×•×Ÿ ×¤×¢×™×œ×•×™×•×ª
            }
            
            return Math.min(humanScore, 60); // ××§×¡×™××•× 60 × ×§×•×“×•×ª ×”× ×—×”
        }

        // × ×™×ª×•×— ×“×¤×•×¡×™ ×œ×—×™×¦×”
        function analyzeClickPattern(clicks) {
            if (clicks.length === 0) return { humanLikeScore: 0 };
            
            let score = 0;
            
            // ×‘×“×™×§×ª ××¨×•×•×—×™ ×–××Ÿ ×‘×™×Ÿ ×œ×—×™×¦×•×ª
            if (clicks.length > 1) {
                const intervals = [];
                for (let i = 1; i < clicks.length; i++) {
                    intervals.push(clicks[i].timestamp - clicks[i-1].timestamp);
                }
                
                const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                
                // ××¨×•×•×— ×× ×•×©×™ ×¨×’×™×œ: 300ms - 2000ms
                if (avgInterval >= 300 && avgInterval <= 2000) {
                    score += 15;
                } else if (avgInterval < 100) {
                    score -= 10; // ×œ×—×™×¦×•×ª ××”×™×¨×•×ª ××“×™ (×‘×•×˜)
                }
                
                // ×•×¨×™××¦×™×” ×‘××¨×•×•×—×™× (×× ×©×™× ×œ× ××“×•×™×§×™×)
                const variance = intervals.reduce((sum, interval) => {
                    return sum + Math.pow(interval - avgInterval, 2);
                }, 0) / intervals.length;
                
                if (variance > 10000) { // ×™×© ×•×¨×™××¦×™×”
                    score += 10;
                }
            }
            
            // ×‘×“×™×§×ª ××™×§×•××™ ×œ×—×™×¦×”
            const positions = clicks.map(click => ({ x: click.x, y: click.y }));
            if (positions.length > 1) {
                const distances = [];
                for (let i = 1; i < positions.length; i++) {
                    const dx = positions[i].x - positions[i-1].x;
                    const dy = positions[i].y - positions[i-1].y;
                    distances.push(Math.sqrt(dx*dx + dy*dy));
                }
                
                const avgDistance = distances.reduce((a, b) => a + b, 0) / distances.length;
                if (avgDistance > 50) { // ×œ×—×™×¦×•×ª ×‘××§×•××•×ª ×©×•× ×™×
                    score += 8;
                }
            }
            
            return { humanLikeScore: Math.min(score, 25) };
        }

        // × ×™×ª×•×— ×ª× ×•×¢×ª ×¢×›×‘×¨
        function analyzeMouseMovement(movements) {
            if (movements.length < 10) return { humanLikeScore: 0 };
            
            let score = 0;
            
            // ×‘×“×™×§×ª ×¨×¦×™×¤×•×ª ×”×ª× ×•×¢×”
            const recentMoves = movements.slice(-50); // 50 ×ª× ×•×¢×•×ª ××—×¨×•× ×•×ª
            
            // ×—×™×©×•×‘ ××”×™×¨×•×ª ×××•×¦×¢×ª
            let totalDistance = 0;
            let totalTime = 0;
            
            for (let i = 1; i < recentMoves.length; i++) {
                const dx = recentMoves[i].x - recentMoves[i-1].x;
                const dy = recentMoves[i].y - recentMoves[i-1].y;
                const distance = Math.sqrt(dx*dx + dy*dy);
                const timeDiff = recentMoves[i].timestamp - recentMoves[i-1].timestamp;
                
                totalDistance += distance;
                totalTime += timeDiff;
            }
            
            const avgSpeed = totalDistance / totalTime; // ×¤×™×§×¡×œ×™× ×œ×©× ×™×™×”
            
            // ××”×™×¨×•×ª ×× ×•×©×™×ª ×˜×™×¤×•×¡×™×ª: 0.5-5 ×¤×™×§×¡×œ/ms
            if (avgSpeed >= 0.5 && avgSpeed <= 5) {
                score += 15;
            } else if (avgSpeed > 10) {
                score -= 5; // ××”×™×¨ ××“×™
            }
            
            // ×‘×“×™×§×ª ×¢×§×•××•×ª ×˜×‘×¢×™×•×ª (×œ× ×§×•×•×™× ×™×©×¨×™×)
            let curves = 0;
            for (let i = 2; i < Math.min(recentMoves.length, 20); i++) {
                const angle1 = Math.atan2(
                    recentMoves[i-1].y - recentMoves[i-2].y,
                    recentMoves[i-1].x - recentMoves[i-2].x
                );
                const angle2 = Math.atan2(
                    recentMoves[i].y - recentMoves[i-1].y,
                    recentMoves[i].x - recentMoves[i-1].x
                );
                
                const angleDiff = Math.abs(angle1 - angle2);
                if (angleDiff > 0.1) curves++;
            }
            
            if (curves > 5) {
                score += 10; // ×ª× ×•×¢×” ×¢×§×•××” ×˜×‘×¢×™×ª
            }
            
            return { humanLikeScore: Math.min(score, 20) };
        }

        // × ×™×ª×•×— ×”×ª× ×”×’×•×ª ×’×œ×™×œ×”
        function analyzeScrollBehavior(scrollEvents) {
            if (scrollEvents.length === 0) return { humanLikeScore: 0 };
            
            let score = 0;
            
            // ×‘×“×™×§×ª ××¨×•×•×—×™ ×’×œ×™×œ×”
            if (scrollEvents.length > 1) {
                const intervals = [];
                for (let i = 1; i < scrollEvents.length; i++) {
                    intervals.push(scrollEvents[i].timestamp - scrollEvents[i-1].timestamp);
                }
                
                const avgInterval = intervals.reduce((a, b) => a + b, 0) / intervals.length;
                
                // ×’×œ×™×œ×” ×× ×•×©×™×ª: 200ms - 1000ms
                if (avgInterval >= 200 && avgInterval <= 1000) {
                    score += 8;
                }
            }
            
            // ×‘×“×™×§×ª ×›×™×•×•×Ÿ ×’×œ×™×œ×” (×œ××¢×œ×” ×•×œ××˜×”)
            const directions = [];
            for (let i = 1; i < scrollEvents.length; i++) {
                const diff = scrollEvents[i].scrollY - scrollEvents[i-1].scrollY;
                if (diff > 0) directions.push('down');
                else if (diff < 0) directions.push('up');
            }
            
            const hasVariedScrolling = directions.includes('up') && directions.includes('down');
            if (hasVariedScrolling) {
                score += 7; // ×’×œ×™×œ×” ×˜×‘×¢×™×ª ×‘×©× ×™ ×›×™×•×•× ×™×
            }
            
            return { humanLikeScore: Math.min(score, 15) };
        }

        // ×¢×“×›×•×Ÿ ×××©×§ ×–×™×”×•×™ ×‘×•×˜×™×
        function updateBotDetectionUI(botScore, confidence, reasons, methods) {
            const confidenceElement = document.getElementById('confidence-score');
            const confidenceFill = document.getElementById('confidence-fill');
            const resultsElement = document.getElementById('advanced-results');
            const detectionElement = document.getElementById('bot-detection');
            
            confidenceElement.textContent = `${confidence}%`;
            confidenceFill.style.width = `${confidence}%`;
            
            // ×¦×‘×¢×™× ×œ×¤×™ ×¦×™×•×Ÿ
            if (botScore >= 70) {
                confidenceElement.style.color = '#f44336';
                confidenceFill.className = 'confidence-fill low-confidence';
                detectionElement.className = 'bot-indicator bot';
                detectionElement.innerHTML = `ğŸ¤– ×–×•×”×” ×›×‘×•×˜ (×¦×™×•×Ÿ: ${botScore}/100)`;
            } else if (botScore >= 40) {
                confidenceElement.style.color = '#ff9800';
                confidenceFill.className = 'confidence-fill medium-confidence';
                detectionElement.className = 'bot-indicator suspicious';
                detectionElement.innerHTML = `âš ï¸ ×”×ª× ×”×’×•×ª ×—×©×•×“×” (×¦×™×•×Ÿ: ${botScore}/100)`;
            } else {
                confidenceElement.style.color = '#4CAF50';
                confidenceFill.className = 'confidence-fill high-confidence';
                detectionElement.className = 'bot-indicator human';
                detectionElement.innerHTML = `ğŸ‘¤ ××©×ª××© ×××™×ª×™ (×¦×™×•×Ÿ: ${botScore}/100)`;
            }
            
            // ×ª×•×¦××•×ª ××¤×•×¨×˜×•×ª
            let resultsHTML = `
                <div class="analytics-section">ğŸ“Š × ×™×§×•×“ ×‘×•×˜: <strong>${botScore}/100</strong></div>
                <div class="analytics-section">ğŸ”¬ ×©×™×˜×•×ª ×–×™×”×•×™: ${methods.join(', ')}</div>
                <div class="analytics-section">ğŸ†” ××–×”×” ××›×©×™×¨: ${deviceFingerprint}</div>
                <div class="analytics-section">ğŸ• ×–××Ÿ ×–×™×”×•×™: ${new Date().toLocaleTimeString('he-IL')}</div>
            `;
            
            if (reasons.length > 0) {
                resultsHTML += '<div style="margin-top: 15px; text-align: right;"><strong>ğŸ” ×¡×™×‘×•×ª ×œ×—×©×“:</strong></div>';
                reasons.forEach(reason => {
                    resultsHTML += `<div class="analytics-section">${reason}</div>`;
                });
            }
            
            resultsElement.innerHTML = resultsHTML;
        }
        
        // ×§×¨×™××ª ×¤×¨××˜×¨×™ UTM
        function parseUTMParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const utmParams = {};
            
            ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'].forEach(param => {
                if (urlParams.has(param)) {
                    utmParams[param] = urlParams.get(param);
                }
            });
            
            const utmElement = document.getElementById('utm-params');
            if (Object.keys(utmParams).length > 0) {
                utmElement.innerHTML = Object.entries(utmParams)
                    .map(([key, value]) => `<strong style="color: #ffd700;">${key}:</strong> ${value}`)
                    .join('<br>');
            } else {
                utmElement.innerHTML = '<span style="color: #ff9800;">âŒ ×œ× ×”×ª×§×‘×œ×• ×¤×¨××˜×¨×™ UTM</span>';
            }
            
            return utmParams;
        }
        
        // × ×™×ª×•×— ××§×•×¨ ×”×’×¢×”
        function analyzeReferrer() {
            const referrer = document.referrer;
            let referrerInfo = '×’×™×©×” ×™×©×™×¨×”';
            
            if (referrer) {
                try {
                    const url = new URL(referrer);
                    referrerInfo = url.hostname;
                } catch (e) {
                    referrerInfo = '××§×•×¨ ×œ× ×™×“×•×¢';
                }
            }
            
            document.getElementById('referrer-info').textContent = referrerInfo;
            return referrerInfo;
        }
        
        // ×–×™×”×•×™ ×“×¤×“×¤×Ÿ ×‘×¡×™×¡×™
        function detectBrowser() {
            const ua = navigator.userAgent;
            let browser = '×œ× ×™×“×•×¢';
            
            if (ua.includes('Edg/')) browser = 'Microsoft Edge';
            else if (ua.includes('Chrome/') && !ua.includes('Edg/')) browser = 'Google Chrome';
            else if (ua.includes('Firefox/')) browser = 'Mozilla Firefox';
            else if (ua.includes('Safari/') && !ua.includes('Chrome/')) browser = 'Safari';
            else if (ua.includes('Opera/') || ua.includes('OPR/')) browser = 'Opera';
            
            document.getElementById('browser-info').textContent = browser;
        }
        
        // ×¤×•× ×§×¦×™×•×ª ××™× ×˜×¨××§×¦×™×”
        function trackButtonClick(buttonName) {
            logAnalyticsEvent('button_click', {
                'button_name': buttonName,
                'page_url': window.location.href
            });
            
            realTimeStats.buttonClicks++;
            updateRealTimeStatsDisplay();
            
            // ×‘×“×™×§×” ××—×“×© ×©×œ ×¦×™×•×Ÿ ×‘×•×˜ ××—×¨×™ ×¤×¢×™×œ×•×ª
            setTimeout(() => {
                detectAdvancedBot();
            }, 100);
            
            showClosablePopup('ğŸ–±ï¸ ×œ×—×™×¦×” × ×¨×©××”! ×‘×•×“×§ ××—×“×© ×¦×™×•×Ÿ ×‘×•×˜...');
        }
        
        function trackMouseMovement() {
            let mouseMoveCount = 0;
            const handler = (e) => {
                mouseMoveCount++;
                if (mouseMoveCount % 10 === 0) {
                    logAnalyticsEvent('mouse_movement', {
                        'move_count': mouseMoveCount,
                        'x': e.clientX,
                        'y': e.clientY
                    });
                }
            };
            
            document.addEventListener('mousemove', handler);
            showClosablePopup('××¢×§×‘ ××—×¨×™ ×”×¢×›×‘×¨ ×”×•×¤×¢×œ! ×–×•×– ××ª ×”×¢×›×‘×¨ ×•×¨××” ×©×–×” × ×¨×©× ×‘××¢×¨×›×ª ×©×œ× ×•');
            
            setTimeout(() => {
                document.removeEventListener('mousemove', handler);
                
                // ×‘×“×™×§×” ××—×“×© ×©×œ ×¦×™×•×Ÿ ×‘×•×˜ ××—×¨×™ ×¤×¢×™×œ×•×ª ×¢×›×‘×¨
                detectAdvancedBot();
                
                showClosablePopup(`× ×¨×©××• ${mouseMoveCount} ×ª× ×•×¢×•×ª ×¢×›×‘×¨! ××¢×“×›×Ÿ ×¦×™×•×Ÿ ×‘×•×˜...`);
            }, 10000);
        }
        
        function trackScrollBehavior() {
            let scrollCount = 0;
            const handler = () => {
                scrollCount++;
                if (scrollCount % 5 === 0) {
                    logAnalyticsEvent('scroll_behavior', {
                        'scroll_count': scrollCount,
                        'scroll_position': window.pageYOffset
                    });
                }
            };
            
            window.addEventListener('scroll', handler);
            showClosablePopup('××¢×§×‘ ××—×¨×™ ×”×’×œ×™×œ×” ×”×•×¤×¢×œ! ×ª×’×œ×•×œ ×›×“×™ ×œ×¨××•×ª ×©×–×” × ×¨×©×');
            
            setTimeout(() => {
                window.removeEventListener('scroll', handler);
                showClosablePopup(`× ×¨×©××• ${scrollCount} ×’×œ×™×œ×•×ª ×‘××¢×¨×›×ª ×©×œ× ×•`);
            }, 10000);
        }
        
        function startAdvancedBehaviorTest() {
            showClosablePopup('ğŸ§ª ××ª×—×™×œ ×‘×“×™×§×ª ×”×ª× ×”×’×•×ª ××ª×§×“××ª...<br><br>×‘×¦×¢ ××ª ×”×¤×¢×•×œ×•×ª ×”×‘××•×ª:<br>â€¢ ×–×•×– ××ª ×”×¢×›×‘×¨ ×‘×“×¤×•×¡ ×˜×‘×¢×™<br>â€¢ ×œ×—×¥ ×¢×œ ××§×•××•×ª ×©×•× ×™× ×‘×“×£<br>â€¢ ×’×œ×•×œ ×œ××¢×œ×” ×•×œ××˜×”<br><br>×”×‘×“×™×§×” ×ª×™××©×š 15 ×©× ×™×•×ª...');
            
            // ××™×¤×•×¡ × ×ª×•× ×™ ×”×‘×“×™×§×”
            behaviorAnalysis.mouseMovements = [];
            behaviorAnalysis.clicks = [];
            behaviorAnalysis.scrollEvents = [];
            
            const testDuration = 15000;
            
            // ×”×•×¡×¤×ª ×××–×™× ×™× ××™×•×—×“×™× ×œ×‘×“×™×§×”
            const testMouseHandler = (e) => {
                behaviorAnalysis.mouseMovements.push({
                    x: e.clientX,
                    y: e.clientY,
                    timestamp: Date.now()
                });
            };
            
            const testClickHandler = (e) => {
                behaviorAnalysis.clicks.push({
                    x: e.clientX,
                    y: e.clientY,
                    timestamp: Date.now()
                });
            };
            
            const testScrollHandler = () => {
                behaviorAnalysis.scrollEvents.push({
                    scrollY: window.scrollY,
                    timestamp: Date.now()
                });
            };
            
            document.addEventListener('mousemove', testMouseHandler);
            document.addEventListener('click', testClickHandler);
            window.addEventListener('scroll', testScrollHandler);
            
            setTimeout(() => {
                // ×”×¡×¨×ª ×”×××–×™× ×™×
                document.removeEventListener('mousemove', testMouseHandler);
                document.removeEventListener('click', testClickHandler);
                window.removeEventListener('scroll', testScrollHandler);
                
                // × ×™×ª×•×— ×ª×•×¦××•×ª
                const clickPattern = analyzeClickPattern(behaviorAnalysis.clicks);
                const mousePattern = analyzeMouseMovement(behaviorAnalysis.mouseMovements);
                const scrollPattern = analyzeScrollBehavior(behaviorAnalysis.scrollEvents);
                const totalHumanScore = calculateHumanActivity();
                
                let message = 'ğŸ§ª ×ª×•×¦××•×ª ×‘×“×™×§×” ××ª×§×“××ª:\n';
                message += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n`;
                message += `ğŸ¯ ×¦×™×•×Ÿ ×× ×•×©×™×•×ª ×›×œ×œ×™: ${totalHumanScore}/60\n`;
                message += `ğŸ‘† ×¦×™×•×Ÿ ×œ×—×™×¦×•×ª: ${clickPattern.humanLikeScore}/25\n`;
                message += `ğŸ–±ï¸ ×¦×™×•×Ÿ ×ª× ×•×¢×ª ×¢×›×‘×¨: ${mousePattern.humanLikeScore}/20\n`;
                message += `ğŸ“œ ×¦×™×•×Ÿ ×’×œ×™×œ×”: ${scrollPattern.humanLikeScore}/15\n\n`;
                
                message += `ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª:\n`;
                message += `â€¢ ×ª× ×•×¢×•×ª ×¢×›×‘×¨: ${behaviorAnalysis.mouseMovements.length}\n`;
                message += `â€¢ ×œ×—×™×¦×•×ª: ${behaviorAnalysis.clicks.length}\n`;
                message += `â€¢ ×’×œ×™×œ×•×ª: ${behaviorAnalysis.scrollEvents.length}\n\n`;
                
                // ×”×¢×¨×›×” ×›×œ×œ×™×ª
                if (totalHumanScore > 45) {
                    message += `âœ… ×”×ª× ×”×’×•×ª ×× ×•×©×™×ª ××•×‘×”×§×ª!\n`;
                    message += `×”×“×¤×•×¡×™× ×©×œ×š ×˜×‘×¢×™×™× ×•×× ×•×©×™×™×.`;
                } else if (totalHumanScore > 25) {
                    message += `âš ï¸ ×”×ª× ×”×’×•×ª ×—×œ×§×™×ª ×× ×•×©×™×ª\n`;
                    message += `×™×© ×¡×™×× ×™× ×× ×•×©×™×™× ××‘×œ ×œ× ××¡×¤×™×§ ×‘×¨×•×¨.`;
                } else if (totalHumanScore > 10) {
                    message += `ğŸ¤” ×”×ª× ×”×’×•×ª ×œ× ×‘×¨×•×¨×”\n`;
                    message += `×§×©×” ×œ×§×‘×•×¢ ×× ××“× ××• ×‘×•×˜.`;
                } else {
                    message += `âŒ ×”×ª× ×”×’×•×ª ×—×©×•×“×” ×××•×“!\n`;
                    message += `×”×“×¤×•×¡×™× ×“×•××™× ×œ×‘×•×˜.`;
                }
                
                // ×¨×™×©×•× ×‘×× ×œ×™×˜×™×§×¡
                logAnalyticsEvent('advanced_behavior_test', {
                    'total_human_score': totalHumanScore,
                    'click_score': clickPattern.humanLikeScore,
                    'mouse_score': mousePattern.humanLikeScore,
                    'scroll_score': scrollPattern.humanLikeScore,
                    'mouse_movements': behaviorAnalysis.mouseMovements.length,
                    'clicks': behaviorAnalysis.clicks.length,
                    'scrolls': behaviorAnalysis.scrollEvents.length
                });
                
                showClosablePopup(message);
                
                // ×¢×“×›×•×Ÿ ×¦×™×•×Ÿ ×”×‘×•×˜ ×¢× ×”×ª×•×¦××•×ª ×”×—×“×©×•×ª
                setTimeout(() => {
                    detectAdvancedBot();
                }, 100);
            }, testDuration);
        }
        
        // ×¤×•× ×§×¦×™×•×ª ×”×•×¨×“×ª ×“×•×—×•×ª
        function downloadReport() {
            const data = localStorage.getItem('custom_analytics');
            const analyticsData = data ? JSON.parse(data) : [];
            
            const report = {
                generated_at: new Date().toISOString(),
                generated_by: visitorId,
                total_events: analyticsData.length,
                summary: {
                    page_views: analyticsData.filter(e => e.type === 'page_view').length,
                    button_clicks: analyticsData.filter(e => e.type === 'button_click').length,
                    bot_detections: analyticsData.filter(e => e.type === 'bot_detection').length,
                    suspicious_behaviors: analyticsData.filter(e => e.type === 'suspicious_behavior').length,
                    unique_sessions: [...new Set(analyticsData.map(e => e.session_id))].length,
                    unique_visitors: [...new Set(analyticsData.map(e => e.visitor_id))].length
                },
                sources: getSourcesSummary(),
                utm_campaigns: getUTMSummary(),
                bot_analysis: getBotAnalysis(),
                events: analyticsData
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], {
                type: 'application/json;charset=utf-8'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bot_detection_report_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showClosablePopup('ğŸ“¥ ×“×•×— JSON ×”×•×¨×“ ×‘×”×¦×œ×—×”!');
        }
        
        function downloadCSVReport() {
            const data = localStorage.getItem('custom_analytics');
            const analyticsData = data ? JSON.parse(data) : [];
            
            if (analyticsData.length === 0) {
                showClosablePopup('âŒ ××™×Ÿ × ×ª×•× ×™× ×œ×”×•×¨×“×”');
                return;
            }
            
            const headers = ['×–××Ÿ', '×¡×•×’ ××™×¨×•×¢', '××–×”×” ××‘×§×¨', '××–×”×” ×¡×©×Ÿ', '××§×•×¨', 'URL', '×¦×™×•×Ÿ ×‘×•×˜'];
            
            const csvRows = [
                headers.join(','),
                ...analyticsData.map(event => [
                    new Date(event.timestamp).toLocaleString('he-IL'),
                    event.type,
                    event.visitor_id?.substring(0, 12) + '...',
                    event.session_id?.substring(0, 12) + '...',
                    getSourceFromEvent(event),
                    event.url || '',
                    event.bot_score || 0
                ].join(','))
            ];
            
            const csvContent = csvRows.join('\n');
            const blob = new Blob(['\uFEFF' + csvContent], {
                type: 'text/csv;charset=utf-8'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bot_detection_data_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showClosablePopup('ğŸ“Š ×“×•×— CSV ×”×•×¨×“ ×‘×”×¦×œ×—×”!');
        }
        
        // Original getSourceFromEvent function removed - duplicate
        
        function clearAllData() {
            if (confirm('âš ï¸ ×”×× ××ª×” ×‘×˜×•×— ×©×ª×¨×¦×” ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™×?')) {
                localStorage.removeItem('custom_analytics');
                localStorage.removeItem('visitor_id');
                
                analyticsData = [];
                sourceTracking = {};
                sessionTimeline = [];
                realTimeStats = {
                    totalVisitors: 1,
                    botDetections: 0,
                    suspiciousActivities: 0,
                    buttonClicks: 0,
                    mouseMovements: 0,
                    pageInteractions: 0
                };
                
                updateRealTimeStatsDisplay();
                updateSourceDisplay();
                updateTimelineDisplay();
                
                showClosablePopup('ğŸ—‘ï¸ ×›×œ ×”× ×ª×•× ×™× × ××—×§×• ×‘×”×¦×œ×—×”!');
                setTimeout(() => window.location.reload(), 1000);
            }
        }
        
        function showDataSummary() {
            const data = localStorage.getItem('custom_analytics');
            const analyticsData = data ? JSON.parse(data) : [];
            
            if (analyticsData.length === 0) {
                showClosablePopup('ğŸ“‹ ××™×Ÿ × ×ª×•× ×™× ×œ×¡×™×›×•×');
                return;
            }
            
            const sources = getSourcesSummary();
            const campaigns = getUTMSummary();
            const botAnalysis = getBotAnalysis();
            
            let summary = 'ğŸ“‹ ×¡×™×›×•× × ×ª×•× ×™×:\n';
            summary += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
            
            summary += `ğŸ“Š ×¡×š ×”×›×œ ××™×¨×•×¢×™×: ${analyticsData.length}\n`;
            summary += `ğŸ‘¥ ××‘×§×¨×™× ×™×™×—×•×“×™×™×: ${[...new Set(analyticsData.map(e => e.visitor_id))].length}\n`;
            summary += `ğŸ”— ×¡×©× ×™× ×™×™×—×•×“×™×™×: ${[...new Set(analyticsData.map(e => e.session_id))].length}\n\n`;
            
            summary += 'ğŸ¤– × ×™×ª×•×— ×‘×•×˜×™×:\n';
            summary += `â€¢ ×–×™×”×•×™×™× ×›×•×œ×œ×™×: ${botAnalysis.total_detections}\n`;
            summary += `â€¢ ×‘×•×˜×™× ×××•×©×¨×™×: ${botAnalysis.confirmed_bots}\n`;
            summary += `â€¢ ×—×©×•×“×™×: ${botAnalysis.suspicious}\n`;
            summary += `â€¢ ×›× ×¨××” ×× ×©×™×: ${botAnalysis.likely_humans}\n`;
            summary += `â€¢ ×¦×™×•×Ÿ ×××•×¦×¢: ${botAnalysis.avg_bot_score}\n\n`;
            
            summary += 'ğŸŒ ××§×•×¨×•×ª ××•×‘×™×œ×™×:\n';
            Object.entries(sources)
                .sort((a, b) => b[1].visits - a[1].visits)
                .slice(0, 5)
                .forEach(([source, data]) => {
                    summary += `â€¢ ${source}: ${data.visits} (${data.bots} ×‘×•×˜×™×)\n`;
                });
            
            if (Object.keys(campaigns).length > 0) {
                summary += '\nğŸ¯ ×§××¤×™×™× ×™× ××•×‘×™×œ×™×:\n';
                Object.entries(campaigns)
                    .sort((a, b) => b[1].visits - a[1].visits)
                    .slice(0, 5)
                    .forEach(([campaign, data]) => {
                        summary += `â€¢ ${campaign}: ${data.visits} ×‘×™×§×•×¨×™×\n`;
                    });
            }
            
            summary += '\nğŸ’¾ × ×ª×•× ×™× × ×©××¨×• ×‘-localStorage';
            
            showClosablePopup(summary);
        }

        // ×§×‘×œ×ª ××§×•×¨ ×××™×¨×•×¢
        // ×¡×™×›×•× ××§×•×¨×•×ª ×”×ª× ×•×¢×”
        function getSourcesSummary() {
            const data = localStorage.getItem('custom_analytics');
            const analyticsData = data ? JSON.parse(data) : [];
            const sources = {};
            
            analyticsData.forEach(event => {
                const source = getSourceFromEvent(event);
                if (!sources[source]) {
                    sources[source] = { visits: 0, bots: 0 };
                }
                sources[source].visits++;
                if (event.bot_score && event.bot_score > 50) {
                    sources[source].bots++;
                }
            });
            
            return sources;
        }

        function getSourceFromEvent(event) {
            if (event.utm_params && event.utm_params.utm_source) {
                return event.utm_params.utm_source;
            }
            if (event.url) {
                try {
                    const url = new URL(event.url);
                    const utmSource = url.searchParams.get('utm_source');
                    if (utmSource) return utmSource;
                } catch (e) {
                    // Handle invalid URL
                }
            }
            if (event.referrer && event.referrer !== '') {
                try {
                    return new URL(event.referrer).hostname;
                } catch (e) {
                    return '×¨×¤×¨×¨ ×œ× ×™×“×•×¢';
                }
            }
            return '×’×™×©×” ×™×©×™×¨×”';
        }

        // ×§×‘×œ×ª UTM ×××™×¨×•×¢
        function getUTMFromEvent(event) {
            if (event.utm_params && event.utm_params.utm_campaign) {
                return event.utm_params.utm_campaign;
            }
            if (event.url) {
                const url = new URL(event.url);
                const utmCampaign = url.searchParams.get('utm_campaign');
                if (utmCampaign) return utmCampaign;
            }
            return '×œ×œ× UTM';
        }

        // ×¡×™×›×•× UTM
        function getUTMSummary() {
            const data = localStorage.getItem('custom_analytics');
            const analyticsData = data ? JSON.parse(data) : [];
            const campaigns = {};
            
            analyticsData.forEach(event => {
                const campaign = getUTMFromEvent(event);
                if (campaign && campaign !== '×œ×œ× UTM') {
                    if (!campaigns[campaign]) {
                        campaigns[campaign] = { visits: 0, bots: 0 };
                    }
                    campaigns[campaign].visits++;
                    if (event.bot_score > 50) {
                        campaigns[campaign].bots++;
                    }
                }
            });
            
            return campaigns;
        }

        // × ×™×ª×•×— ×‘×•×˜×™×
        function getBotAnalysis() {
            const data = localStorage.getItem('custom_analytics');
            const analyticsData = data ? JSON.parse(data) : [];
            
            const botEvents = analyticsData.filter(e => 
                e.type === 'bot_detection' && e.bot_score !== undefined
            );
            
            const analysis = {
                total_detections: botEvents.length,
                confirmed_bots: botEvents.filter(e => e.bot_score >= 70).length,
                suspicious: botEvents.filter(e => e.bot_score >= 40 && e.bot_score < 70).length,
                likely_humans: botEvents.filter(e => e.bot_score < 40).length,
                avg_bot_score: botEvents.length > 0 
                    ? Math.round(botEvents.reduce((sum, e) => sum + e.bot_score, 0) / botEvents.length)
                    : 0
            };
            
            return analysis;
        }

        // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×”
        function updateStatistic(statType) {
            if (realTimeStats[statType] !== undefined) {
                realTimeStats[statType]++;
                updateRealTimeStatsDisplay();
            }
        }

        // ××¢×§×‘ ×”×ª× ×”×’×•×ª
        function initBehaviorTracking() {
            document.addEventListener('mousemove', (e) => {
                behaviorAnalysis.mouseMovements.push({
                    x: e.clientX,
                    y: e.clientY,
                    timestamp: Date.now()
                });
                
                if (behaviorAnalysis.mouseMovements.length > 100) {
                    behaviorAnalysis.mouseMovements.shift();
                }
                updateStatistic('mouseMovements');
            });
            
            document.addEventListener('click', (e) => {
                behaviorAnalysis.clicks.push({
                    x: e.clientX,
                    y: e.clientY,
                    timestamp: Date.now()
                });
                updateStatistic('pageInteractions');
            });
            
            document.addEventListener('scroll', () => {
                behaviorAnalysis.scrollEvents.push({
                    scrollY: window.scrollY,
                    timestamp: Date.now()
                });
                updateStatistic('pageInteractions');
            });
            
            document.addEventListener('keydown', (e) => {
                behaviorAnalysis.keystrokes.push({
                    key: e.key,
                    timestamp: Date.now()
                });
            });
            
            // ×‘×“×™×§×” ×ª×§×•×¤×ª×™×ª ×œ×”×ª× ×”×’×•×ª ×—×©×•×“×”
            setInterval(() => {
                const now = Date.now();
                const recentMovements = behaviorAnalysis.mouseMovements.filter(m => now - m.timestamp < 10000);
                
                if (recentMovements.length === 0 && behaviorAnalysis.clicks.length > 0) {
                    logAnalyticsEvent('suspicious_behavior', {
                        'patterns': '×œ×—×™×¦×•×ª ×œ×œ× ×ª× ×•×¢×ª ×¢×›×‘×¨',
                        'mouse_movements': recentMovements.length,
                        'clicks': behaviorAnalysis.clicks.length,
                        'risk_score': 50
                    });
                    updateStatistic('suspiciousActivities');
                }
            }, 30000);
        }

        // ××¢×¨×›×ª ××¢×§×‘ ××©×ª××©×™× ×‘×–××Ÿ ×××ª
        function initRealTimeVisitorTracking() {
            // ×¨×™×©×•× ××©×ª××© × ×•×›×—×™
            registerCurrentVisitor();
            
            // heartbeat ×›×œ 5 ×©× ×™×•×ª ×•×‘×“×™×§×ª ×©×™× ×•×™×™×
            let lastVisitorCount = Object.keys(getActiveVisitors()).length;
            setInterval(() => {
                sendHeartbeat();
                
                // ×‘×“×™×§×ª ×©×™× ×•×™×™× ×‘××¡×¤×¨ ×”×’×•×œ×©×™×
                const visitors = getActiveVisitors();
                const currentCount = Object.keys(visitors).length;
                
                if (currentCount > lastVisitorCount) {
                    showNewVisitorNotification();
                    console.log(`ğŸ”” ×–×•×”×” ××©×ª××© ×—×“×©! ×¡×š ×”×›×œ: ${currentCount} ××©×ª××©×™× ×¤×¢×™×œ×™×`);
                }
                
                lastVisitorCount = currentCount;
                updateActiveVisitorsList();
                cleanupInactiveVisitors();
            }, 5000);
            
            // ××¢×§×‘ ××—×¨×™ ×¢×–×™×‘×ª ×”×“×£
            window.addEventListener('beforeunload', () => {
                removeCurrentVisitor();
            });
            
            // ××¢×§×‘ ××—×¨×™ ×©×™× ×•×™×™× ×‘-localStorage (×¢×•×‘×“ ×¨×§ ×‘×™×Ÿ ×—×œ×•× ×•×ª/×˜××‘×™× ×©×•× ×™×)
            window.addEventListener('storage', (e) => {
                if (e.key === 'active_visitors') {
                    const visitors = getActiveVisitors();
                    const currentCount = Object.keys(visitors).length;
                    
                    if (currentCount > lastVisitorCount) {
                        showNewVisitorNotification();
                        console.log(`ğŸ“± ××©×ª××© ×—×“×© ×–×•×”×” ××—×œ×•×Ÿ ××—×¨! ×¡×š ×”×›×œ: ${currentCount}`);
                    }
                    
                    lastVisitorCount = currentCount;
                    updateActiveVisitorsList();
                }
            });
            
            // ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ×œ×‘×“×™×§×ª ×”×’×œ×™×©×” ×”×—×™×”
            addTestingButtons();
        }

        function registerCurrentVisitor() {
            const visitors = getActiveVisitors();
            visitors[visitorId] = {
                sessionId: sessionId,
                joinTime: Date.now(),
                lastSeen: Date.now(),
                userAgent: navigator.userAgent.substring(0, 50),
                deviceType: getDeviceType(),
                isBot: false // ×™×¢×•×“×›×Ÿ ××—×¨ ×›×š
            };
            saveActiveVisitors(visitors);
            
            // ×”×•×“×¢×” ×¢×œ ×›× ×™×¡×”
            logAnalyticsEvent('visitor_joined', {
                visitor_id: visitorId,
                session_id: sessionId,
                join_time: new Date().toISOString()
            });
            
            console.log(`ğŸ‘‹ ××©×ª××© ×—×“×© × ×›× ×¡: ${visitorId.substring(0, 8)}...`);
        }

        function sendHeartbeat() {
            const visitors = getActiveVisitors();
            if (visitors[visitorId]) {
                visitors[visitorId].lastSeen = Date.now();
                saveActiveVisitors(visitors);
            }
        }

        function removeCurrentVisitor() {
            const visitors = getActiveVisitors();
            delete visitors[visitorId];
            saveActiveVisitors(visitors);
            
            logAnalyticsEvent('visitor_left', {
                visitor_id: visitorId,
                session_id: sessionId,
                leave_time: new Date().toISOString()
            });
        }

        function getActiveVisitors() {
            const stored = localStorage.getItem('active_visitors');
            return stored ? JSON.parse(stored) : {};
        }

        function saveActiveVisitors(visitors) {
            localStorage.setItem('active_visitors', JSON.stringify(visitors));
        }

        function cleanupInactiveVisitors() {
            const visitors = getActiveVisitors();
            const now = Date.now();
            const timeout = 30000; // 30 ×©× ×™×•×ª timeout
            
            let changed = false;
            Object.keys(visitors).forEach(id => {
                if (now - visitors[id].lastSeen > timeout) {
                    delete visitors[id];
                    changed = true;
                }
            });
            
            if (changed) {
                saveActiveVisitors(visitors);
            }
        }

        function updateActiveVisitorsList() {
            const visitors = getActiveVisitors();
            const visitorsList = document.getElementById('visitors-list');
            const activeCount = Object.keys(visitors).length;
            
            // ×¢×“×›×•×Ÿ ××¡×¤×¨ ×¤×¢×™×œ×™×
            document.getElementById('active-visitors').textContent = activeCount;
            realTimeStats.activeVisitors = activeCount;
            
            // ×¢×“×›×•×Ÿ ×¨×©×™××”
            visitorsList.innerHTML = '';
            
            Object.entries(visitors)
                .sort((a, b) => b[1].joinTime - a[1].joinTime)
                .forEach(([id, visitor]) => {
                    const isCurrentUser = id === visitorId;
                    const timeAgo = getTimeAgo(visitor.lastSeen);
                    const deviceIcon = getDeviceIcon(visitor.deviceType);
                    
                    const visitorDiv = document.createElement('div');
                    visitorDiv.className = 'visitor-item';
                    visitorDiv.style.cssText = `
                        padding: 8px; 
                        margin: 5px 0; 
                        background: rgba(255,255,255,0.1); 
                        border-radius: 5px; 
                        display: flex; 
                        justify-content: space-between; 
                        align-items: center;
                        ${isCurrentUser ? 'border: 1px solid #4CAF50;' : ''}
                    `;
                    
                    visitorDiv.innerHTML = `
                        <small style="opacity: 0.7;">${timeAgo}</small>
                        <span>
                            <span style="color: #4CAF50;">ğŸŸ¢</span> 
                            ${deviceIcon} 
                            ${isCurrentUser ? '××ª×”' : `××©×ª××© ${id.substring(8, 12)}`}
                            ${visitor.isBot ? 'ğŸ¤–' : ''}
                        </span>
                    `;
                    
                    visitorsList.appendChild(visitorDiv);
                });
        }

        function getDeviceType() {
            const ua = navigator.userAgent;
            if (/mobile/i.test(ua)) return 'mobile';
            if (/tablet/i.test(ua)) return 'tablet';
            return 'desktop';
        }

        function getDeviceIcon(type) {
            switch(type) {
                case 'mobile': return 'ğŸ“±';
                case 'tablet': return 'ğŸ“”';
                default: return 'ğŸ’»';
            }
        }

        function getTimeAgo(timestamp) {
            const diff = Date.now() - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            
            if (seconds < 10) return '×¢×›×©×™×•';
            if (seconds < 60) return `${seconds}×©`;
            if (minutes < 60) return `${minutes}×“`;
            return `${Math.floor(minutes / 60)}×©`;
        }

        // ×¢×“×›×•×Ÿ ×¦×™×•×Ÿ ×‘×•×˜ ×‘××¢×¨×›×ª ×”×¤×¢×™×œ×™×
        function updateVisitorBotStatus(isBot) {
            const visitors = getActiveVisitors();
            if (visitors[visitorId]) {
                visitors[visitorId].isBot = isBot;
                saveActiveVisitors(visitors);
            }
        }

        // Machine Learning Training Data Collection (×œ××™×“×” ×¨×¦×™×¤×”)
        function collectTrainingData(botScore, detectionMethods, humanActivityScore) {
            const trainingData = getTrainingData();
            const features = extractFeatures();
            
            const dataPoint = {
                timestamp: Date.now(),
                visitor_id: visitorId,
                features: features,
                bot_score: botScore,
                human_activity: humanActivityScore,
                detection_methods: detectionMethods,
                is_bot: botScore >= 70,
                session_duration: Date.now() - startTime,
                device_type: getDeviceType(),
                browser_info: getBrowserInfo()
            };
            
            trainingData.push(dataPoint);
            
            // ×©××™×¨×ª ××§×¡×™××•× 1000 ×“×’×™××•×ª
            if (trainingData.length > 1000) {
                trainingData.shift();
            }
            
            localStorage.setItem('ml_training_data', JSON.stringify(trainingData));
            
            // ×¢×“×›×•×Ÿ ××•×“×œ ×× ×™×© ××¡×¤×™×§ ×“×’×™××•×ª
            if (trainingData.length >= 50) {
                updateMLModel(trainingData);
            }
        }

        function getTrainingData() {
            const stored = localStorage.getItem('ml_training_data');
            return stored ? JSON.parse(stored) : [];
        }

        function extractFeatures() {
            return {
                plugins_count: navigator.plugins.length,
                languages_count: (navigator.languages || []).length,
                webdriver: !!navigator.webdriver,
                screen_width: screen.width,
                screen_height: screen.height,
                hardware_concurrency: navigator.hardwareConcurrency || 0,
                device_memory: navigator.deviceMemory || 0,
                timezone_offset: new Date().getTimezoneOffset(),
                canvas_supported: !!document.createElement('canvas').getContext('2d'),
                webgl_supported: !!document.createElement('canvas').getContext('webgl'),
                touch_supported: 'ontouchstart' in window,
                cookies_enabled: navigator.cookieEnabled
            };
        }

        function getBrowserInfo() {
            return {
                user_agent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                online: navigator.onLine,
                java_enabled: navigator.javaEnabled ? navigator.javaEnabled() : false
            };
        }

        // ×¢×“×›×•×Ÿ ××•×“×œ ML ×‘×”×ª×‘×¡×¡ ×¢×œ × ×ª×•× ×™× ×—×“×©×™×
        function updateMLModel(trainingData) {
            try {
                // ×—×™×©×•×‘ statistics ×—×“×©×™×
                const botSamples = trainingData.filter(d => d.is_bot);
                const humanSamples = trainingData.filter(d => !d.is_bot);
                
                const modelStats = {
                    bot_ratio: botSamples.length / trainingData.length,
                    avg_bot_score: botSamples.reduce((sum, d) => sum + d.bot_score, 0) / (botSamples.length || 1),
                    avg_human_activity: humanSamples.reduce((sum, d) => sum + d.human_activity, 0) / (humanSamples.length || 1),
                    updated_at: Date.now(),
                    samples_count: trainingData.length
                };
                
                localStorage.setItem('ml_model_stats', JSON.stringify(modelStats));
                
                console.log('ğŸ“Š ML Model updated with', trainingData.length, 'samples');
                console.log('ğŸ¤– Bot ratio:', (modelStats.bot_ratio * 100).toFixed(1) + '%');
                
            } catch (e) {
                console.warn('ML Model update failed:', e);
            }
        }

        // ×§×‘×œ×ª statistics ×©×œ ×”××•×“×œ
        function getMLModelStats() {
            const stored = localStorage.getItem('ml_model_stats');
            return stored ? JSON.parse(stored) : {
                bot_ratio: 0.1,
                avg_bot_score: 50,
                avg_human_activity: 30,
                samples_count: 0
            };
        }

        // ×”×ª×¨××” ×¢×œ ××©×ª××© ×—×“×©
        function showNewVisitorNotification() {
            // ×™×¦×™×¨×ª ×”×ª×¨××” ×•×™×–×•××œ×™×ª
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(45deg, #4CAF50, #81C784);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 1000;
                font-weight: bold;
                animation: slideIn 0.5s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2em;">ğŸ‘‹</span>
                    <div>
                        <div>××©×ª××© ×—×“×© × ×›× ×¡!</div>
                        <small style="opacity: 0.8;">×¢×›×©×™×• ×™×© ${Object.keys(getActiveVisitors()).length} ××©×ª××©×™× ×¤×¢×™×œ×™×</small>
                    </div>
                </div>
            `;
            
            // ×”×•×¡×¤×ª ×× ×™××¦×™×”
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(notification);
            
            // ×”×¡×¨×ª ×”×”×ª×¨××” ××—×¨×™ 5 ×©× ×™×•×ª
            setTimeout(() => {
                notification.style.animation = 'slideIn 0.5s ease-out reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 500);
            }, 5000);
            
            // ×¦×œ×™×œ ×”×ª×¨××” (×× ×”×“×¤×“×¤×Ÿ ×××¤×©×¨)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                // ×× ××™×Ÿ ×ª××™×›×” ×‘×¦×œ×™×œ, ×œ× × ×•×¨×
            }
            
            console.log('ğŸ‰ ××©×ª××© ×—×“×© × ×›× ×¡ ×œ××ª×¨!');
        }

        // ×”×•×¡×¤×ª ×›×¤×ª×•×¨×™ ×‘×“×™×§×” ×œ×¤×™×ª×•×—
        function addTestingButtons() {
            // ×™×¦×™×¨×ª ×¤×× ×œ ×‘×“×™×§×”
            const testPanel = document.createElement('div');
            testPanel.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 15px;
                border-radius: 10px;
                z-index: 999;
                font-size: 12px;
                border: 1px solid #444;
            `;
            
            testPanel.innerHTML = `
                <div style="margin-bottom: 10px; font-weight: bold;">ğŸ§ª ×›×œ×™ ×‘×“×™×§×”</div>
                <button id="simulate-visitor" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; background: #4CAF50; color: white;">×”×“××”: ××©×ª××© ×—×“×©</button><br>
                <button id="clear-visitors" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; background: #f44336; color: white;">× ×§×” ×›×œ ×”×’×•×œ×©×™×</button><br>
                <button id="show-visitors" style="margin: 2px; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; background: #2196F3; color: white;">×”×¦×’ ×’×•×œ×©×™×</button><br>
                <small style="opacity: 0.7;">×œ×‘×“×™×§×” ×××™×ª×™×ª: ×¤×ª×— ×§×™×©×•×¨ ×‘×˜×œ×¤×•×Ÿ ××• ×˜××‘ ×—×“×©</small>
            `;
            
            document.body.appendChild(testPanel);
            
            // ×”×•×¡×¤×ª ×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×œ×›×¤×ª×•×¨×™×
            document.getElementById('simulate-visitor').addEventListener('click', () => {
                simulateNewVisitor();
            });
            
            document.getElementById('clear-visitors').addEventListener('click', () => {
                clearAllVisitors();
            });
            
            document.getElementById('show-visitors').addEventListener('click', () => {
                showCurrentVisitors();
            });
        }

        // ×”×“××™×™×ª ××©×ª××© ×—×“×© ×œ×‘×“×™×§×”
        function simulateNewVisitor() {
            const visitors = getActiveVisitors();
            const fakeId = 'test_visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
            
            visitors[fakeId] = {
                sessionId: 'test_session_' + Date.now(),
                joinTime: Date.now(),
                lastSeen: Date.now(),
                userAgent: 'Test User Agent (Simulated)',
                deviceType: '×‘×“×™×§×”',
                isBot: Math.random() > 0.7 // 30% ×¡×™×›×•×™ ×œ×”×™×•×ª ×‘×•×˜
            };
            
            saveActiveVisitors(visitors);
            
            console.log(`ğŸ§ª ×”×“××™×™×ª ××©×ª××© ×—×“×©: ${fakeId.substring(0, 20)}...`);
            console.log('ğŸ“Š ×¡×š ×”×›×œ ×’×•×œ×©×™× ×¤×¢×™×œ×™×:', Object.keys(visitors).length);
            
            // ×¢×“×›×•×Ÿ ××™×“×™ ×©×œ ×”×¨×©×™××”
            updateActiveVisitorsList();
        }

        // × ×™×§×•×™ ×›×œ ×”×’×•×œ×©×™×
        function clearAllVisitors() {
            localStorage.removeItem('active_visitors');
            console.log('ğŸ§¹ ×›×œ ×”×’×•×œ×©×™× × ×•×§×•');
            
            // ×¨×™×©×•× ××—×“×© ×©×œ ×”××©×ª××© ×”× ×•×›×—×™
            setTimeout(() => {
                registerCurrentVisitor();
                updateActiveVisitorsList();
            }, 100);
        }

        // ×”×¦×’×ª ×’×•×œ×©×™× × ×•×›×—×™×™×
        function showCurrentVisitors() {
            const visitors = getActiveVisitors();
            console.log('ğŸ‘¥ ×’×•×œ×©×™× ×¤×¢×™×œ×™× × ×•×›×—×™×™×:', visitors);
            console.log('ğŸ“ˆ ××¡×¤×¨ ×’×•×œ×©×™×:', Object.keys(visitors).length);
            
            Object.entries(visitors).forEach(([id, visitor], index) => {
                console.log(`${index + 1}. ${id.substring(0, 15)}... - ${visitor.deviceType} - ${visitor.isBot ? 'ğŸ¤– ×‘×•×˜' : 'ğŸ‘¤ ×× ×•×©×™'}`);
            });
        }

        // ×”×¦×’×ª ××™×“×¢ ×¨××©×•× ×™
        function displayInitialInfo() {
            // ×”×¦×’×ª ××™×“×¢ ×‘×¡×™×¡×™
            document.getElementById('visit-time').textContent = new Date().toLocaleString('he-IL');
            document.getElementById('session-id').textContent = sessionId.substring(0, 16) + '...';
            document.getElementById('visitor-id').textContent = visitorId.substring(0, 16) + '...';
            document.getElementById('screen-size').textContent = screen.width + 'x' + screen.height;
            
            // ×™×¦×™×¨×ª ×˜×‘×™×¢×ª ××¦×‘×¢
            deviceFingerprint = createDeviceFingerprint();
            document.getElementById('device-fingerprint').textContent = deviceFingerprint;
        }

        // ×”×¤×¢×œ×” ××•×˜×•××˜×™×ª
        window.onload = async () => {
            // ×”×¦×’×ª ××™×“×¢ ×¨××©×•× ×™
            displayInitialInfo();
            
            // ×”×¤×¢×œ×ª ××¢×¨×›×ª ××¢×§×‘ ××©×ª××©×™× ×‘×–××Ÿ ×××ª
            initRealTimeVisitorTracking();
            
            // × ×™×ª×•×— ××§×•×¨ ×”×’×¢×”
            analyzeReferrer();
            
            // ×§×¨×™××ª ×¤×¨××˜×¨×™ UTM
            parseUTMParams();
            
            // ×”×¤×¢×œ×ª ×–×™×”×•×™ ××ª×§×“×
            detectAdvancedBot();
            
            // ×”×¤×¢×œ×ª ××¢×§×‘ ×”×ª× ×”×’×•×ª
            initBehaviorTracking();
            
            // ×©×œ×™×—×ª ××™×¨×•×¢ ×¢××•×“ × ×˜×¢×Ÿ ×œ××¢×¨×›×ª ×©×œ× ×•
            logAnalyticsEvent('page_view', {
                'page_title': document.title,
                'user_agent': navigator.userAgent,
                'screen_resolution': screen.width + 'x' + screen.height,
                'device_fingerprint': deviceFingerprint,
                'referrer': document.referrer,
                'utm_params': parseUTMParams()
            });
            
            // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×¨××©×•× ×™
            updateRealTimeStatsDisplay();
            
            // ×”×•×¡×¤×” ×¨××©×•× ×™×ª ×œ×¦×™×¨ ×”×–××Ÿ
            addToTimeline('page_view', {page_title: document.title});
            
            console.log('ğŸš€ ××¢×¨×›×ª ×–×™×”×•×™ ×‘×•×˜×™× ××ª×§×“××ª ×”×•×¤×¢×œ×” ×‘×”×¦×œ×—×”!');
        };

        // =========== ×¤×•× ×§×¦×™×•×ª × ×™×ª×•×— ×œ×•×’×™× ===========

        // ×˜×™×¤×•×œ ×‘×”×¢×œ××ª ×§×•×‘×¥
        function handleLogsUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = 'ğŸ“¤ ××¢×œ×” ×§×•×‘×¥...';

            if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                statusDiv.innerHTML = 'âŒ ×©×’×™××”: ×™×© ×œ×”×¢×œ×•×ª ×§×•×‘×¥ JSON ×‘×œ×‘×“';
                statusDiv.style.color = '#f44336';
                return;
            }

            if (file.size > 50 * 1024 * 1024) { // 50MB limit
                statusDiv.innerHTML = 'âŒ ×©×’×™××”: ×§×•×‘×¥ ×’×“×•×œ ××“×™ (××§×¡×™××•× 50MB)';
                statusDiv.style.color = '#f44336';
                return;
            }

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    uploadedLogs = jsonData;
                    
                    statusDiv.innerHTML = `âœ… ×”×•×¢×œ×” ×‘×”×¦×œ×—×”: ${file.name} (${formatFileSize(file.size)})`;
                    statusDiv.style.color = '#4CAF50';
                    
                    // ×”×¤×¢×œ×ª ×›×¤×ª×•×¨ ×”× ×™×ª×•×—
                    document.getElementById('analyzeBtn').disabled = false;
                    
                    console.log('ğŸ“‚ Logs uploaded:', Object.keys(jsonData).length, 'entries');
                    
                } catch (error) {
                    statusDiv.innerHTML = 'âŒ ×©×’×™××”: ×§×•×‘×¥ JSON ×œ× ×ª×§×™×Ÿ';
                    statusDiv.style.color = '#f44336';
                    console.error('JSON parse error:', error);
                }
            };
            
            reader.onerror = function() {
                statusDiv.innerHTML = 'âŒ ×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥';
                statusDiv.style.color = '#f44336';
            };
            
            reader.readAsText(file);
        }

        // ×¤×•×¨××˜ ×’×•×“×œ ×§×•×‘×¥
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // × ×™×ª×•×— ×”×œ×•×’×™× ×©×”×•×¢×œ×•
        function analyzeUploadedLogs() {
            if (!uploadedLogs) {
                showClosablePopup('âŒ ×œ× ×”×•×¢×œ×” ×§×•×‘×¥ ×œ× ×™×ª×•×—');
                return;
            }

            const analysisDiv = document.getElementById('logsAnalysisResults');
            const contentDiv = document.getElementById('analysisContent');
            
            analysisDiv.style.display = 'block';
            contentDiv.innerHTML = 'ğŸ”„ ×× ×ª×— × ×ª×•× ×™×...';

            // ×”××ª× ×” ×§×¦×¨×” ×œ××¤×§×˜ ×•×™×–×•××œ×™
            setTimeout(() => {
                try {
                    const analysisResults = performLogsAnalysis(uploadedLogs);
                    displayAnalysisResults(analysisResults);
                } catch (error) {
                    contentDiv.innerHTML = `âŒ ×©×’×™××” ×‘× ×™×ª×•×—: ${error.message}`;
                    console.error('Analysis error:', error);
                }
            }, 500);
        }

        // ×‘×™×¦×•×¢ ×”× ×™×ª×•×—
        function performLogsAnalysis(logs) {
            console.log('ğŸ” Starting logs analysis...');
            
            // ×–×™×”×•×™ ××‘× ×” ×”× ×ª×•× ×™×
            const dataStructure = identifyDataStructure(logs);
            
            // × ×™×ª×•×— ×¢×œ ×¤×™ ××‘× ×” ×”× ×ª×•× ×™×
            if (dataStructure.type === 'complex_phone_logs') {
                return analyzeComplexPhoneLogs(logs, dataStructure);
            } else if (dataStructure.type === 'simple_array') {
                return analyzeArrayLogs(logs, dataStructure);
            } else if (dataStructure.type === 'object') {
                return analyzeObjectLogs(logs, dataStructure);
            } else {
                throw new Error(`××‘× ×” × ×ª×•× ×™× ×œ× × ×ª××š: ${dataStructure.type}`);
            }
        }

        // ×–×™×”×•×™ ××‘× ×” ×”× ×ª×•× ×™× ×”××ª×§×“×
        function identifyDataStructure(data) {
            console.log('ğŸ” Analyzing data structure:', data);
            
            if (Array.isArray(data)) {
                // ×‘×“×™×§×” ×× ×–×” ××¢×¨×š ×©×œ ××•×‘×™×™×§×˜×™× ××•×¨×›×‘×™× (×›××• ×”×“×•×’××” ×©×œ×š)
                if (data.length > 0) {
                    const sample = data[0];
                    const hasClicks = sample.clicks && Array.isArray(sample.clicks);
                    const hasNonClickRequests = sample.non_click_requests && Array.isArray(sample.non_click_requests);
                    const hasPhoneNumber = sample.phone_number;
                    
                    if (hasClicks || hasNonClickRequests || hasPhoneNumber) {
                        return {
                            type: 'complex_phone_logs',
                            sampleKeys: Object.keys(sample),
                            length: data.length,
                            hasClicks: hasClicks,
                            hasNonClickRequests: hasNonClickRequests,
                            hasPhoneNumber: hasPhoneNumber
                        };
                    }
                    
                    return {
                        type: 'simple_array',
                        sampleKeys: Object.keys(sample),
                        length: data.length
                    };
                }
                return { type: 'empty_array', length: 0 };
            } else if (typeof data === 'object' && data !== null) {
                const keys = Object.keys(data);
                return {
                    type: 'object',
                    keys: keys,
                    hasEvents: data.events && Array.isArray(data.events),
                    hasClicks: data.clicks && Array.isArray(data.clicks),
                    hasNonClickRequests: data.non_click_requests && Array.isArray(data.non_click_requests)
                };
            }
            return { type: 'unknown' };
        }

        // × ×™×ª×•×— × ×ª×•× ×™ array
        function analyzeArrayLogs(logs, structure) {
            let botCount = 0;
            let humanCount = 0;
            let unknownCount = 0;
            let totalClicks = 0;
            let suspiciousActivities = 0;

            const deviceTypes = {};
            const userAgents = {};
            const ipAddresses = {};
            const timeDistribution = {};
            const sources = {};
            const detectionMethods = {};

            logs.forEach((entry, index) => {
                try {
                    const analysis = analyzeLogEntry(entry, index);
                    
                    if (analysis.isBot) {
                        botCount++;
                    } else if (analysis.isHuman) {
                        humanCount++;
                    } else {
                        unknownCount++;
                    }

                    if (analysis.isClick) totalClicks++;
                    if (analysis.isSuspicious) suspiciousActivities++;

                    // ××™×¡×•×£ ×¡×˜×˜×™×¡×˜×™×§×•×ª
                    if (analysis.deviceType) {
                        deviceTypes[analysis.deviceType] = (deviceTypes[analysis.deviceType] || 0) + 1;
                    }
                    
                    if (analysis.userAgent) {
                        const shortUA = analysis.userAgent.substring(0, 50);
                        userAgents[shortUA] = (userAgents[shortUA] || 0) + 1;
                    }
                    
                    if (analysis.ip) {
                        ipAddresses[analysis.ip] = (ipAddresses[analysis.ip] || 0) + 1;
                    }
                    
                    if (analysis.timestamp) {
                        const hour = new Date(analysis.timestamp).getHours();
                        timeDistribution[hour] = (timeDistribution[hour] || 0) + 1;
                    }
                    
                    if (analysis.source) {
                        sources[analysis.source] = (sources[analysis.source] || 0) + 1;
                    }

                    if (analysis.detectionMethods) {
                        analysis.detectionMethods.forEach(method => {
                            detectionMethods[method] = (detectionMethods[method] || 0) + 1;
                        });
                    }

                } catch (error) {
                    console.warn(`Error analyzing entry ${index}:`, error);
                    unknownCount++;
                }
            });

            const totalEntries = logs.length;
            const botPercentage = ((botCount / totalEntries) * 100).toFixed(1);
            const humanPercentage = ((humanCount / totalEntries) * 100).toFixed(1);

            return {
                summary: {
                    totalEntries,
                    botCount,
                    humanCount,
                    unknownCount,
                    totalClicks,
                    suspiciousActivities,
                    botPercentage,
                    humanPercentage,
                    botToHumanRatio: humanCount > 0 ? (botCount / humanCount).toFixed(2) : 'N/A'
                },
                distributions: {
                    deviceTypes,
                    userAgents,
                    ipAddresses,
                    timeDistribution,
                    sources,
                    detectionMethods
                },
                recommendations: generateRecommendations(botCount, humanCount, totalEntries)
            };
        }

        // × ×™×ª×•×— × ×ª×•× ×™ object
        function analyzeObjectLogs(logs, structure) {
            if (structure.hasEvents) {
                return analyzeArrayLogs(logs.events, { type: 'array', length: logs.events.length });
            }
            
            // × ×™×ª×•×— object ×›×œ×œ×™
            const keys = Object.keys(logs);
            return {
                summary: {
                    totalEntries: keys.length,
                    dataType: 'object',
                    mainKeys: keys.slice(0, 10)
                },
                message: '××‘× ×” × ×ª×•× ×™× ×œ× ×¡×˜× ×“×¨×˜×™ - × ×“×¨×© × ×™×ª×•×— ×™×“× ×™'
            };
        }

        // × ×™×ª×•×— ×¨×©×•××” ×‘×•×“×“×ª
        function analyzeLogEntry(entry, index) {
            const result = {
                isBot: false,
                isHuman: false,
                isClick: false,
                isSuspicious: false,
                botScore: 0,
                deviceType: null,
                userAgent: null,
                ip: null,
                timestamp: null,
                source: null,
                detectionMethods: []
            };

            // ×–×™×”×•×™ ×©×“×•×ª × ×¤×•×¦×™×
            const possibleFields = {
                userAgent: ['user_agent', 'userAgent', 'ua', 'User-Agent'],
                ip: ['ip', 'ip_address', 'client_ip', 'remote_addr'],
                timestamp: ['timestamp', 'time', 'date', 'created_at'],
                botScore: ['bot_score', 'botScore', 'bot_detection_score'],
                isBot: ['is_bot', 'isBot', 'bot'],
                source: ['source', 'referrer', 'utm_source'],
                type: ['type', 'event_type', 'action']
            };

            // ×—×™×œ×•×¥ × ×ª×•× ×™×
            for (const [key, possibleNames] of Object.entries(possibleFields)) {
                for (const name of possibleNames) {
                    if (entry[name] !== undefined) {
                        result[key] = entry[name];
                        break;
                    }
                }
            }

            // ×”×¡×§×ª ××¡×§× ×•×ª
            if (result.isBot === true || result.botScore > 70) {
                result.isBot = true;
                result.detectionMethods.push('Explicit Bot Flag');
            } else if (result.isBot === false || result.botScore < 30) {
                result.isHuman = true;
                result.detectionMethods.push('Explicit Human Flag');
            }

            // × ×™×ª×•×— User Agent
            if (result.userAgent) {
                const ua = result.userAgent.toLowerCase();
                const botKeywords = ['bot', 'crawler', 'spider', 'scraper', 'headless'];
                if (botKeywords.some(keyword => ua.includes(keyword))) {
                    result.isBot = true;
                    result.detectionMethods.push('User Agent Analysis');
                }
            }

            // ×–×™×”×•×™ ×¡×•×’ ××™×¨×•×¢
            if (result.type) {
                const type = result.type.toLowerCase();
                if (type.includes('click')) {
                    result.isClick = true;
                }
                if (type.includes('suspicious') || type.includes('warning')) {
                    result.isSuspicious = true;
                }
            }

            // × ×™×ª×•×— ×–××Ÿ
            if (result.timestamp) {
                try {
                    const date = new Date(result.timestamp);
                    result.timestamp = date.toISOString();
                } catch (e) {
                    // × ×™×¡×•×™ ×¤×¨×¡ timestamp ×›××¡×¤×¨
                    if (typeof result.timestamp === 'number') {
                        result.timestamp = new Date(result.timestamp).toISOString();
                    }
                }
            }

            return result;
        }

        // × ×™×ª×•×— ×œ×•×’×™× ××•×¨×›×‘×™× ×œ×¤×™ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ
        function analyzeComplexPhoneLogs(logs, structure) {
            console.log('ğŸ“± Analyzing complex phone logs...', logs);
            
            let totalBots = 0;
            let totalHumans = 0; 
            let totalClicks = 0;
            let humanClicks = 0;
            let botClicks = 0;
            let totalNonClicks = 0;
            let phoneNumbers = new Set();
            let suspiciousActivities = 0;
            
            const ipAnalysis = {};
            const timeDistribution = {};
            const sourceAnalysis = {};
            const phoneNumberStats = {};
            const clickDestinations = {};
            
            logs.forEach((phoneEntry, phoneIndex) => {
                try {
                    const phoneNumber = phoneEntry.phone_number;
                    if (phoneNumber) {
                        phoneNumbers.add(phoneNumber);
                    }
                    
                    phoneNumberStats[phoneNumber] = {
                        clicks: phoneEntry.clicks ? phoneEntry.clicks.length : 0,
                        nonClicks: phoneEntry.non_click_requests ? phoneEntry.non_click_requests.length : 0,
                        bots: 0,
                        humans: 0,
                        suspicious: 0
                    };
                    
                    // × ×™×ª×•×— ×œ×—×™×¦×•×ª
                    if (phoneEntry.clicks && Array.isArray(phoneEntry.clicks)) {
                        phoneEntry.clicks.forEach(click => {
                            totalClicks++;
                            
                            // × ×™×ª×•×— ××ª×§×“× ×¢× ×”×ª× ×”×’×•×ª
                            const analysis = analyzeComplexLogEntry(click, 'click', phoneNumber);
                            const behaviorAnalysis = analyzeBehaviorPatterns(
                                click, 'click', phoneNumber, 
                                [...(phoneEntry.clicks || []), ...(phoneEntry.non_click_requests || [])]
                            );
                            
                            // ××©×œ×‘ ×ª×•×¦××•×ª ×”× ×™×ª×•×—
                            const finalResult = combineAnalysisResults(analysis, behaviorAnalysis);
                            
                            if (finalResult.isBot) {
                                totalBots++;
                                botClicks++;
                                phoneNumberStats[phoneNumber].bots++;
                            } else if (finalResult.isHuman) {
                                totalHumans++;
                                humanClicks++;
                                phoneNumberStats[phoneNumber].humans++;
                            }
                            
                            if (finalResult.isSuspicious) {
                                suspiciousActivities++;
                                phoneNumberStats[phoneNumber].suspicious++;
                            }
                            
                            // ××™×¡×•×£ ×¡×˜×˜×™×¡×˜×™×§×•×ª
                            if (click.destination) {
                                clickDestinations[click.destination] = (clickDestinations[click.destination] || 0) + 1;
                            }
                            
                            collectAdvancedStats(finalResult, ipAnalysis, timeDistribution, sourceAnalysis);
                        });
                    }
                    
                    // × ×™×ª×•×— ×‘×§×©×•×ª ×œ×œ× ×œ×—×™×¦×”
                    if (phoneEntry.non_click_requests && Array.isArray(phoneEntry.non_click_requests)) {
                        phoneEntry.non_click_requests.forEach(request => {
                            totalNonClicks++;
                            
                            // × ×™×ª×•×— ××ª×§×“× ×¢× ×”×ª× ×”×’×•×ª
                            const analysis = analyzeComplexLogEntry(request, 'non_click', phoneNumber);
                            const behaviorAnalysis = analyzeBehaviorPatterns(
                                request, 'non_click', phoneNumber, 
                                [...(phoneEntry.clicks || []), ...(phoneEntry.non_click_requests || [])]
                            );
                            
                            // ××©×œ×‘ ×ª×•×¦××•×ª ×”× ×™×ª×•×—
                            const finalResult = combineAnalysisResults(analysis, behaviorAnalysis);
                            
                            if (finalResult.isBot) {
                                totalBots++;
                                phoneNumberStats[phoneNumber].bots++;
                            } else if (finalResult.isHuman) {
                                totalHumans++;
                                phoneNumberStats[phoneNumber].humans++;
                            }
                            
                            if (finalResult.isSuspicious) {
                                suspiciousActivities++;
                                phoneNumberStats[phoneNumber].suspicious++;
                            }
                            
                            collectAdvancedStats(finalResult, ipAnalysis, timeDistribution, sourceAnalysis);
                        });
                    }
                    
                } catch (error) {
                    console.warn(`Error analyzing phone entry ${phoneIndex}:`, error);
                }
            });
            
            const totalEntries = totalClicks + totalNonClicks;
            const botRatio = totalEntries > 0 ? (totalBots / totalEntries * 100).toFixed(2) : 0;
            const humanRatio = totalEntries > 0 ? (totalHumans / totalEntries * 100).toFixed(2) : 0;
            
            return {
                summary: {
                    totalPhoneNumbers: phoneNumbers.size,
                    totalEntries: totalEntries,
                    totalClicks: totalClicks,
                    humanClicks: humanClicks,
                    botClicks: botClicks,
                    totalNonClicks: totalNonClicks,
                    botCount: totalBots,
                    humanCount: totalHumans,
                    unknownCount: totalEntries - totalBots - totalHumans,
                    botRatio: parseFloat(botRatio),
                    humanRatio: parseFloat(humanRatio),
                    suspiciousActivities: suspiciousActivities
                },
                phoneNumberStats: phoneNumberStats,
                clickDestinations: clickDestinations,
                ipAnalysis: ipAnalysis,
                timeDistribution: timeDistribution,
                sourceAnalysis: sourceAnalysis,
                recommendations: generateAdvancedRecommendations(totalBots, totalHumans, totalEntries, phoneNumberStats)
            };
        }
        
        // × ×™×ª×•×— ×¨×©×•××ª ×œ×•×’ ××•×¨×›×‘×ª
        function analyzeComplexLogEntry(entry, type, phoneNumber) {
            const result = {
                type: type,
                phoneNumber: phoneNumber,
                isBot: false,
                isHuman: false,
                isSuspicious: false,
                detectionMethods: [],
                confidence: 0,
                ip: entry.ip_address,
                timestamp: entry.timestamp,
                source: null,
                userAgent: null
            };
            
            const ip = entry.ip_address;
            let score = 0;
            
            // ×–×™×”×•×™ ×‘×•×˜×™× ××ª×§×“× ×•×¨×—×‘
            if (ip) {
                const ipAnalysis = analyzeIPAddress(ip);
                
                if (ipAnalysis.isBot) {
                    result.isBot = true;
                    result.detectionMethods.push(ipAnalysis.reason);
                    score += ipAnalysis.confidence;
                } else if (ipAnalysis.isHuman) {
                    result.isHuman = true;
                    result.detectionMethods.push(ipAnalysis.reason);
                    score += ipAnalysis.confidence;
                } else if (ipAnalysis.isSuspicious) {
                    result.isSuspicious = true;
                    result.detectionMethods.push(ipAnalysis.reason);
                    score += ipAnalysis.confidence;
                }
            }
            
            // ×‘×“×™×§×ª referrer ×•-fbclid - ×ª××™×›×” ×‘×©××•×ª ×©×“×•×ª ×©×•× ×™×
            const referrer = entry.referrer || entry.ref || entry.referer || entry.source || entry.from;
            
            if (referrer) {
                result.source = referrer;
                if (entry.query_params && entry.query_params.fbclid) {
                    result.detectionMethods.push('Facebook Click ID');
                    if (!result.isBot) {
                        result.isHuman = true;
                        score += 60;
                    }
                }
            } else if (entry.query_params && (entry.query_params.utm_source || entry.query_params.ref)) {
                // ×× ××™×Ÿ referrer ××‘×œ ×™×© UTM ××• ref - × ×©×ª××© ×‘×”×
                result.source = entry.query_params.utm_source || entry.query_params.ref || 'Unknown Source';
            } else if (entry.utm_source || entry.campaign_source || entry.traffic_source) {
                // ×× ×™×© ×©×“×” ××§×•×¨ ×‘×©×•×¨×© ×”××•×‘×™×™×§×˜
                result.source = entry.utm_source || entry.campaign_source || entry.traffic_source;
            } else if (!referrer && !entry.query_params) {
                // ×’×™×©×” ×œ×œ× referrer ×•×œ×œ× ×¤×¨××˜×¨×™× - ×—×©×•×“
                result.isSuspicious = true;
                result.detectionMethods.push('No Referrer/Params');
                result.source = 'Direct/Unknown';
            } else {
                result.source = 'Direct/Unknown';
            }
            
            // ×‘×“×™×§×ª ×“×¤×•×¡ ×œ×—×™×¦×•×ª
            if (type === 'click' && entry.destination) {
                result.detectionMethods.push(`Click to ${entry.destination}`);
                if (!result.isBot) {
                    result.isHuman = true;
                    score += 50;
                }
            }
            
            result.confidence = Math.min(score, 100);
            
            return result;
        }
        
        // ××™×¡×•×£ ×¡×˜×˜×™×¡×˜×™×§×•×ª ××ª×§×“××•×ª
        function collectAdvancedStats(analysis, ipAnalysis, timeDistribution, sourceAnalysis) {
            // × ×™×ª×•×— IP
            if (analysis.ip) {
                if (!ipAnalysis[analysis.ip]) {
                    ipAnalysis[analysis.ip] = { count: 0, isBot: analysis.isBot, isHuman: analysis.isHuman };
                }
                ipAnalysis[analysis.ip].count++;
            }
            
            // ×”×ª×¤×œ×’×•×ª ×–×× ×™×
            if (analysis.timestamp) {
                try {
                    const date = new Date(analysis.timestamp);
                    const hour = date.getHours();
                    timeDistribution[hour] = (timeDistribution[hour] || 0) + 1;
                } catch (e) {
                    console.warn('Invalid timestamp:', analysis.timestamp);
                }
            }
            
            // × ×™×ª×•×— ××§×•×¨×•×ª - ×¢× debug
            if (analysis.source && analysis.source !== 'Direct/Unknown') {
                console.log('ğŸ“Š Adding source to analysis:', analysis.source);
                sourceAnalysis[analysis.source] = (sourceAnalysis[analysis.source] || 0) + 1;
            } else if (!analysis.source) {
                console.warn('âš ï¸ No source found in analysis:', analysis);
                sourceAnalysis['No Source Detected'] = (sourceAnalysis['No Source Detected'] || 0) + 1;
            } else {
                sourceAnalysis[analysis.source] = (sourceAnalysis[analysis.source] || 0) + 1;
            }
        }
        
        // ×–×™×”×•×™ IP ××ª×§×“× ×•×¨×—×‘
        function analyzeIPAddress(ip) {
            const result = {
                isBot: false,
                isHuman: false,
                isSuspicious: false,
                reason: '',
                confidence: 0
            };
            
            // ×–×™×”×•×™ ×‘×•×˜×™ ×’×•×’×œ (××•×¨×—×‘)
            const googleRanges = [
                /^66\.249\./, /^66\.102\./, /^72\.14\./, /^209\.85\./, /^216\.239\./,
                /^64\.233\./, /^74\.125\./, /^142\.250\./, /^172\.217\./, /^108\.177\./,
                /^35\.186\./, /^35\.190\./, /^35\.201\./, /^35\.244\./
            ];
            
            for (let pattern of googleRanges) {
                if (ip.match(pattern)) {
                    result.isBot = true;
                    result.reason = 'Google Bot/Crawler';
                    result.confidence = 100;
                    return result;
                }
            }
            
            // ×–×™×”×•×™ ×‘×•×˜×™ ×¤×™×™×¡×‘×•×§/××˜× (××•×¨×—×‘ ××©××¢×•×ª×™×ª)
            const facebookRanges = [
                // ×¨×©×ª×•×ª ×¤×™×™×¡×‘×•×§ ×¢×™×§×¨×™×•×ª
                /^173\.252\./, /^69\.171\./, /^31\.13\./, /^66\.220\.149\./,
                /^69\.63\./, /^157\.240\./, /^185\.60\./, /^204\.15\./,
                
                // ×¨×©×ª×•×ª ××˜× × ×•×¡×¤×•×ª
                /^129\.134\./, /^179\.60\./, /^185\.89\./, /^199\.201\./,
                /^104\.244\./, /^107\.178\./, /^108\.177\./, /^173\.252\./,
                
                // ×¨×©×ª×•×ª ××™×¨×•×¤××™×•×ª ×•××¡×™×”-×¤×¡×™×¤×™×§ ×©×œ ×¤×™×™×¡×‘×•×§
                /^31\.13\./, /^66\.220\./, /^69\.171\./, /^173\.252\./,
                /^185\.60\./, /^204\.15\./, /^31\.13\.24\./, /^31\.13\.25\./,
                /^31\.13\.64\./, /^31\.13\.65\./, /^31\.13\.66\./, /^31\.13\.67\./,
                /^31\.13\.68\./, /^31\.13\.69\./, /^31\.13\.70\./, /^31\.13\.71\./,
                /^31\.13\.72\./, /^31\.13\.73\./, /^31\.13\.74\./, /^31\.13\.75\./,
                /^31\.13\.76\./, /^31\.13\.77\./, /^31\.13\.78\./, /^31\.13\.79\./,
                /^31\.13\.80\./, /^31\.13\.81\./, /^31\.13\.82\./, /^31\.13\.83\./,
                /^31\.13\.84\./, /^31\.13\.85\./, /^31\.13\.86\./, /^31\.13\.87\./,
                
                // ×¨×©×ª×•×ª WhatsApp Business API
                /^31\.13\.103\./, /^31\.13\.115\./, /^31\.13\.127\./,
                /^69\.171\.230\./, /^69\.171\.231\./, /^69\.171\.234\./,
                /^69\.171\.249\./, /^69\.63\.184\./, /^69\.63\.189\./,
                /^173\.252\.69\./, /^173\.252\.70\./, /^173\.252\.79\./,
                /^173\.252\.82\./, /^173\.252\.83\./, /^173\.252\.87\./,
                /^173\.252\.95\./, /^173\.252\.107\./, /^173\.252\.127\./,
                
                // ×¨×©×ª×•×ª CDN ×•××˜××•×Ÿ ×©×œ ×¤×™×™×¡×‘×•×§
                /^66\.220\.149\./, /^66\.220\.144\./, /^66\.220\.145\./,
                /^66\.220\.146\./, /^66\.220\.147\./, /^66\.220\.148\./,
                
                // ×¨×©×ª×•×ª Instagram
                /^54\.230\./, /^52\.84\./, /^54\.192\./, /^99\.86\./,
                
                // ×¨×©×ª×•×ª ×—×“×©×•×ª ×©×œ Meta
                /^162\.125\./, /^199\.96\./, /^208\.43\./, /^69\.147\./,
                /^74\.119\./, /^103\.4\./, /^129\.134\./, /^157\.240\./,
                /^163\.70\./, /^179\.60\./, /^185\.89\./, /^204\.15\./
            ];
            
            for (let pattern of facebookRanges) {
                if (ip.match(pattern)) {
                    result.isBot = true;
                    result.reason = 'Facebook/Meta/WhatsApp Bot';
                    result.confidence = 98;
                    return result;
                }
            }
            
            // ×–×™×”×•×™ ×‘×•×˜×™ WhatsApp ×¡×¤×¦×™×¤×™×™×
            const whatsappRanges = [
                /^157\.240\./, /^31\.13\./, /^169\.45\./, /^158\.85\./,
                /^169\.47\./, /^169\.48\./, /^169\.53\./, /^169\.54\./,
                /^169\.55\./, /^169\.56\./, /^169\.57\./, /^169\.58\./,
                /^169\.59\./, /^169\.60\./, /^169\.61\./, /^169\.62\./,
                /^75\.126\./, /^108\.168\./, /^18\.194\./, /^18\.195\./
            ];
            
            for (let pattern of whatsappRanges) {
                if (ip.match(pattern)) {
                    result.isBot = true;
                    result.reason = 'WhatsApp Business Bot';
                    result.confidence = 96;
                    return result;
                }
            }
            
            // ×–×™×”×•×™ ×‘×•×˜×™× × ×•×¡×¤×™×
            // Microsoft/Bing
            if (ip.match(/^(40\.|52\.|13\.|20\.|65\.52\.|207\.46\.)/)) {
                result.isBot = true;
                result.reason = 'Microsoft/Bing Bot';
                result.confidence = 95;
                return result;
            }
            
            // Amazon/AWS (×—×©×•×“ ×œ×”×™×•×ª ×‘×•×˜)
            if (ip.match(/^(54\.|3\.|52\.|18\.|34\.|13\.)/)) {
                result.isSuspicious = true;
                result.reason = 'AWS/Cloud Server (Suspicious)';
                result.confidence = 70;
                return result;
            }
            
            // WhatsApp Business API servers
            if (ip.match(/^(31\.13\.|173\.252\.|69\.171\.|102\.132\.|157\.240\.)/) &&
                entry && entry.query_params && entry.query_params.ref && 
                entry.query_params.ref.includes('whatsapp')) {
                result.isBot = true;
                result.reason = 'WhatsApp Business Bot';
                result.confidence = 90;
                return result;
            }
            
            // ×–×™×”×•×™ IP ×¡×¤×¦×™×¤×™×™× ×©×©×’×•×™×™× ×‘× ×™×ª×•×— ×”×§×•×“× - ×¢×“×›×•×Ÿ ×§×¨×™×˜×™
            // IPs ×©× ×“××• ××™×¨×•×¤××™×™× ××š ×œ××¢×©×” ×—×©×•×“×™× ×›×‘×•×˜×™×
            const suspiciousEuropeanBotRanges = [
                /^2\.54\.1\./, /^46\.210\.188\./, /^77\.127\.172\./,  // ×‘×•×˜×™× ×©×–×•×”×• ×›×××™×ª×™×™× ×‘×˜×¢×•×ª
                /^2\.54\.23\./, /^2\.54\.29\./, /^2\.54\.32\./,    // ×¨×›×™×‘×™× ×©×œ ×¨×©×ª ×‘×•×˜×™×
                /^5\.28\.180\./, /^5\.28\.182\./, /^5\.29\.44\./,   // ×¨×©×ª×•×ª ×—×©×•×“×•×ª × ×•×¡×¤×•×ª
                /^46\.[0-9]+\.1[0-9]+\./, /^77\.12[0-9]\./,      // ×“×¤×•×¡×™ ×‘×•×˜×™× ××™×¨×•×¤××™×™×
                /^82\.80\./, /^85\.250\.83\./, /^87\.70\.31\./,    // ×¨×©×ª×•×ª ×‘×•×˜×™× ××–×•×”×•×ª
                /^147\.235\.216\./, /^192\.114\.52\./,           // ×¨×©×ª×•×ª ×—×©×•×“×•×ª × ×•×¡×¤×•×ª
                /^212\.179\.93\./, /^213\.57\.103\./             // ×‘×•×˜×™× ×©×–×•×”×• ×‘× ×™×ª×•×—
            ];
            
            for (let pattern of suspiciousEuropeanBotRanges) {
                if (ip.match(pattern)) {
                    result.isBot = true;
                    result.reason = 'European Bot Network (Updated Detection)';
                    result.confidence = 95;
                    return result;
                }
            }
            
            // ×–×™×”×•×™ ×¡×¤×§×™ ××™× ×˜×¨× ×˜ ×™×©×¨××œ×™×™× ×××™×ª×™×™× (××¢×•×“×›×Ÿ ×•××“×•×™×§ ×™×•×ª×¨)
            const israeliISPs = [
                /^79\.177\.135\./, // ×”×•×˜ - ×™×©×¨××œ×™ ×××™×ª×™ (×××•××ª)
                /^188\.64\./, /^195\.123\./, /^217\.194\./,  // ×¡×¤×§×™ ××™× ×˜×¨× ×˜ ×™×©×¨××œ×™×™× ×××•××ª×™×
                /^141\.226\./, /^149\.106\./,                // ×¨×©×ª×•×ª ××§×“××™×•×ª ×™×©×¨××œ×™×•×ª
                /^176\.228\./, /^185\.164\./                 // ×¡×¤×§×™× × ×•×¡×¤×™× ×××•××ª×™×
            ];
            
            for (let pattern of israeliISPs) {
                if (ip.match(pattern)) {
                    result.isHuman = true;
                    result.reason = 'Israeli ISP';
                    result.confidence = 75;
                    return result;
                }
            }
            
            // ×”×¢×¨×”: ×‘×“×™×§×•×ª ×–××Ÿ ×•-fbclid ××ª×‘×¦×¢×•×ª ×‘×¤×•× ×§×¦×™×” analyzeComplexLogEntry
            
            // ×“×¤×•×¡×™ IP ×—×©×•×“×™× × ×•×¡×¤×™×
            // IP ×¢× ×™×•×ª×¨ ××“×™ zeros (×“×¤×•×¡ ×‘×•×˜×™×)
            if (ip.match(/\.0\.0\./) || ip.match(/\.0\.\d{1,3}\.0$/)) {
                result.isSuspicious = true;
                result.reason = 'Suspicious IP Pattern (Zeros)';
                result.confidence = 60;
                return result;
            }
            
            // IP ×¢× ×“×¤×•×¡×™× ×—×•×–×¨×™×
            const parts = ip.split('.');
            if (parts.length === 4) {
                const uniqueParts = [...new Set(parts)];
                if (uniqueParts.length <= 2) {
                    result.isSuspicious = true;
                    result.reason = 'Repetitive IP Pattern';
                    result.confidence = 50;
                    return result;
                }
            }
            
            // ×–×™×”×•×™ ×¡×¤×§×™ VPN/Proxy × ×¤×•×¦×™×
            const vpnRanges = [
                /^46\.246\./, /^91\.207\./, /^178\.62\./, /^134\.195\./,
                /^199\.180\./, /^208\.167\./, /^162\.213\./, /^104\.168\./
            ];
            
            for (let pattern of vpnRanges) {
                if (ip.match(pattern)) {
                    result.isSuspicious = true;
                    result.reason = 'VPN/Proxy Service';
                    result.confidence = 65;
                    return result;
                }
            }
            
            // IP ×œ× ××–×•×”×” - × ×™×ª×•×— × ×•×¡×£
            result.reason = 'Unknown IP Origin';
            result.confidence = 30;
            return result;
        }
        
        // ×¤×•×¤-××¤ × ×¡×’×¨
        function showClosablePopup(message) {
            // ×”×¡×¨×ª ×¤×•×¤-××¤ ×§×™×™× ×× ×™×©
            const existingPopup = document.querySelector('.closeable-popup');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            const popup = document.createElement('div');
            popup.className = 'closeable-popup';
            popup.innerHTML = `
                <button class="close-btn" onclick="this.parentElement.remove()">Ã—</button>
                <div>${message}</div>
            `;
            
            document.body.appendChild(popup);
            
            // ×¡×’×™×¨×” ××•×˜×•××˜×™×ª ××—×¨×™ 5 ×©× ×™×•×ª ×× ×œ× × ×¡×’×¨ ×™×“× ×™×ª
            setTimeout(() => {
                if (popup && popup.parentElement) {
                    popup.remove();
                }
            }, 5000);
        }
        
        // ×©×™×œ×•×‘ ×ª×•×¦××•×ª × ×™×ª×•×— IP ×•×”×ª× ×”×’×•×ª
        function combineAnalysisResults(ipAnalysis, behaviorAnalysis) {
            const combined = {
                isBot: false,
                isHuman: false,
                isSuspicious: false,
                detectionMethods: [...ipAnalysis.detectionMethods],
                confidence: ipAnalysis.confidence,
                ip: ipAnalysis.ip,
                timestamp: ipAnalysis.timestamp,
                source: ipAnalysis.source
            };
            
            // ×”×•×¡×¤×ª ×ª×•×¦××•×ª × ×™×ª×•×— ×”×”×ª× ×”×’×•×ª
            if (behaviorAnalysis.reasons) {
                combined.detectionMethods.push(...behaviorAnalysis.reasons);
            }
            
            // ×œ×•×’×™×§×ª ×”×—×œ×˜×” ××©×•×œ×‘×ª
            if (ipAnalysis.isBot || behaviorAnalysis.isBot) {
                combined.isBot = true;
                combined.confidence = Math.max(ipAnalysis.confidence, behaviorAnalysis.confidence);
            } else if (ipAnalysis.isHuman || behaviorAnalysis.isHuman) {
                // ×× ×™×© ×¡×™××Ÿ ×œ×‘×•×˜ ×‘×”×ª× ×”×’×•×ª ××‘×œ IP ×× ×•×©×™ - × ×•×ª×Ÿ ×¦×™×•×Ÿ × ××•×š ×™×•×ª×¨
                if (behaviorAnalysis.isBot) {
                    combined.isSuspicious = true;
                    combined.confidence = 60;
                } else {
                    combined.isHuman = true;
                    combined.confidence = Math.max(ipAnalysis.confidence, behaviorAnalysis.confidence);
                }
            } else {
                combined.isSuspicious = true;
                combined.confidence = Math.max(ipAnalysis.confidence, behaviorAnalysis.confidence);
            }
            
            return combined;
        }

        // ×‘×“×™×§×” ××ª×§×“××ª ×©×œ ×”×ª× ×”×’×•×ª
        function analyzeBehaviorPatterns(entry, type, phoneNumber, allEntriesForPhone) {
            const behaviorScore = {
                isBot: false,
                isHuman: false,
                reasons: [],
                confidence: 0
            };
            
            // ×‘×“×™×§×ª ×ª×“×™×¨×•×ª ×’×™×©×•×ª ×××•×ª×• IP
            if (allEntriesForPhone) {
                const sameIPCount = allEntriesForPhone.filter(e => 
                    e.ip_address === entry.ip_address
                ).length;
                
                if (sameIPCount > 10) {
                    behaviorScore.isBot = true;
                    behaviorScore.reasons.push(`Multiple requests from same IP (${sameIPCount})`);
                    behaviorScore.confidence += 80;
                }
            }
            
            // ×‘×“×™×§×ª ×“×¤×•×¡ ×–×× ×™×
            if (entry.timestamp) {
                const date = new Date(entry.timestamp);
                const hour = date.getHours();
                const minute = date.getMinutes();
                const second = date.getSeconds();
                
                // ×‘×•×˜×™× ×œ×¢×™×ª×™× ×¤×•×¢×œ×™× ×‘×–×× ×™× ×¢×’×•×œ×™×
                if (minute === 0 && second === 0) {
                    behaviorScore.isBot = true;
                    behaviorScore.reasons.push('Exact hour timing (Bot pattern)');
                    behaviorScore.confidence += 40;
                }
                
                // ×‘×•×˜×™× ×¤×•×¢×œ×™× ×œ×¢×™×ª×™× ×‘×©×¢×•×ª ×œ× ×˜×‘×¢×™×•×ª
                if (hour >= 2 && hour <= 5) {
                    behaviorScore.isBot = true;
                    behaviorScore.reasons.push('Night hours activity (Bot pattern)');
                    behaviorScore.confidence += 30;
                }
            }
            
            // × ×™×ª×•×— ××ª×§×“× ×©×œ fbclid ×•×¤×¨××˜×¨×™ ×¤×™×™×¡×‘×•×§
            const fbAnalysis = analyzeFacebookParameters(entry);
            if (fbAnalysis.isBot) {
                behaviorScore.isBot = true;
                behaviorScore.reasons.push(...fbAnalysis.reasons);
                behaviorScore.confidence += fbAnalysis.confidence;
            } else if (fbAnalysis.isHuman) {
                behaviorScore.isHuman = true;
                behaviorScore.reasons.push(...fbAnalysis.reasons);
                behaviorScore.confidence += fbAnalysis.confidence;
            }
            
            // × ×™×ª×•×— referrer ××ª×§×“×
            const referrerAnalysis = analyzeReferrerPatterns(entry);
            if (referrerAnalysis.isBot) {
                behaviorScore.isBot = true;
                behaviorScore.reasons.push(...referrerAnalysis.reasons);
                behaviorScore.confidence += referrerAnalysis.confidence;
            } else if (referrerAnalysis.isHuman) {
                behaviorScore.isHuman = true;
                behaviorScore.reasons.push(...referrerAnalysis.reasons);
                behaviorScore.confidence += referrerAnalysis.confidence;
            }
            
            // × ×™×ª×•×— ××ª×§×“× ×©×œ ×œ×—×™×¦×•×ª WhatsApp
            const whatsappAnalysis = analyzeWhatsAppPatterns(entry, type, allEntriesForPhone);
            if (whatsappAnalysis.isBot) {
                behaviorScore.isBot = true;
                behaviorScore.reasons.push(...whatsappAnalysis.reasons);
                behaviorScore.confidence += whatsappAnalysis.confidence;
            } else if (whatsappAnalysis.isHuman) {
                behaviorScore.isHuman = true;
                behaviorScore.reasons.push(...whatsappAnalysis.reasons);
                behaviorScore.confidence += whatsappAnalysis.confidence;
            }
            
            // ×œ×—×™×¦×” ×¢×œ ×™×¢×“ ×××™×ª×™ (WhatsApp/×˜×œ×¤×•×Ÿ) - ×‘×“×™×§×” ×‘×¡×™×¡×™×ª × ×•×¡×¤×ª
            if (type === 'click' && entry.destination && 
                ['whatsapp', 'telephone'].includes(entry.destination) && 
                !whatsappAnalysis.isBot) {
                behaviorScore.isHuman = true;
                behaviorScore.reasons.push(`Real action: ${entry.destination}`);
                behaviorScore.confidence += 30; // ×¦×™×•×Ÿ × ××•×š ×™×•×ª×¨ ×›×™ ×›×‘×¨ × ×¢×©×” × ×™×ª×•×— ××¤×•×¨×˜
            }
            
            return behaviorScore;
        }

        // × ×™×ª×•×— ×¤×¨××˜×¨×™ ×¤×™×™×¡×‘×•×§ ××ª×§×“× ×•××•×¨×—×‘ ×¢× ×”×ª××—×•×ª ×‘×‘×•×˜×™×
        function analyzeFacebookParameters(entry) {
            const result = {
                isBot: false,
                isHuman: false,
                reasons: [],
                confidence: 0
            };
            
            if (!entry.query_params) return result;
            
            let score = 0;
            const fbclid = entry.query_params.fbclid;
            
            if (fbclid) {
                // ×‘×“×™×§×ª ××•×¨×š ××¤×•×¨×˜×ª
                if (fbclid.length < 20) {
                    result.isBot = true;
                    result.reasons.push('Facebook Click ID too short (likely fake)');
                    score += 90;
                    return result;
                } else if (fbclid.length > 200) {
                    result.isBot = true;
                    result.reasons.push('Facebook Click ID too long (likely malformed)');
                    score += 80;
                    return result;
                }
                
                // ×‘×“×™×§×ª ×“×¤×•×¡×™ fbclid ××ª×§×“××ª ×•××¨×•×‘×ª ×¨×•×‘×“×™×
                const validPrefixes = [
                    'IwZXh0bgNhZW0',    // ×“×¤×•×¡ ×ª×§× ×™ ×“×¡×§×˜×•×¤
                    'IwY2xjaw',         // ×“×¤×•×¡ ××•×‘×™×™×œ iOS
                    'IwYGxsZW',         // ×“×¤×•×¡ ××•×‘×™×™×œ Android
                    'IwAR',             // ×“×¤×•×¡ ×™×©×Ÿ/legacy
                    'PAAb',             // ×“×¤×•×¡ ××¢×¨×›×ª ×¤×¨×¡×•×
                    'ARB',              // ×“×¤×•×¡ Business Manager
                    'PAA',              // ×“×¤×•×¡ ××¤×œ×™×§×¦×™×” ×¤×™×™×¡×‘×•×§
                    'IwBB',             // ×“×¤×•×¡ browser bridge
                    'VwB',              // ×“×¤×•×¡ video bridge
                    'IwCR',             // ×“×¤×•×¡ Creator Studio
                    'IwPG',             // ×“×¤×•×¡ Page Posts
                    'IwEV',             // ×“×¤×•×¡ Events
                    'IwGR',             // ×“×¤×•×¡ Groups
                    'IwMP',             // ×“×¤×•×¡ Marketplace
                    'IwSH',             // ×“×¤×•×¡ Stories/Shares
                    'IwWA',             // ×“×¤×•×¡ WhatsApp integration
                    'IwIG'              // ×“×¤×•×¡ Instagram integration
                ];
                
                let validPrefixFound = false;
                for (const prefix of validPrefixes) {
                    if (fbclid.startsWith(prefix)) {
                        validPrefixFound = true;
                        result.isHuman = true;
                        result.reasons.push(`Valid Facebook Click ID: ${prefix} pattern`);
                        score += 85;
                        break;
                    }
                }
                
                if (!validPrefixFound) {
                    // ×‘×“×™×§×ª ×“×¤×•×¡×™× ×—×©×•×“×™×
                    if (fbclid.match(/^[0-9]+$/)) {
                        result.isBot = true;
                        result.reasons.push('Fake Facebook Click ID (numbers only)');
                        score += 95;
                        return result;
                    } else if (fbclid.match(/^[a-z]+$/)) {
                        result.isBot = true;
                        result.reasons.push('Fake Facebook Click ID (lowercase only)');
                        score += 85;
                        return result;
                    } else if (fbclid.match(/^[A-Z]+$/)) {
                        result.isBot = true;
                        result.reasons.push('Fake Facebook Click ID (uppercase only)');
                        score += 85;
                        return result;
                    } else if (fbclid.includes('test') || fbclid.includes('bot') || 
                              fbclid.includes('debug') || fbclid.includes('fake')) {
                        result.isBot = true;
                        result.reasons.push('Test/Debug Facebook Click ID');
                        score += 98;
                        return result;
                    } else if (fbclid.includes('=') || fbclid.includes('&') || 
                              fbclid.includes('/') || fbclid.includes('?')) {
                        result.isBot = true;
                        result.reasons.push('Malformed Facebook Click ID (invalid chars)');
                        score += 90;
                        return result;
                    } else if (!/^[A-Za-z0-9_-]+$/.test(fbclid)) {
                        result.isBot = true;
                        result.reasons.push('Invalid characters in Facebook Click ID');
                        score += 90;
                        return result;
                    } else {
                        // ×œ× ××–×•×”×” ××‘×œ ×‘×¡×™×¡×™×ª ×ª×§×™×Ÿ
                        result.isHuman = true;
                        result.reasons.push('Unrecognized but valid Facebook Click ID format');
                        score += 60;
                    }
                }
                
                // ×‘×“×™×§×ª ×¢×§×‘×™×•×ª ×¢× referrer
                if (entry.referrer) {
                    const referrer = entry.referrer.toLowerCase();
                    const facebookDomains = [
                        'facebook.com', 'fb.com', 'm.facebook.com', 
                        'mobile.facebook.com', 'touch.facebook.com', 
                        'web.facebook.com', 'mbasic.facebook.com',
                        'l.facebook.com', 'lm.facebook.com'
                    ];
                    
                    if (facebookDomains.some(domain => referrer.includes(domain))) {
                        if (result.isHuman && !result.isBot) {
                            score += 20; // ×ª××™×›×” × ×•×¡×¤×ª
                            result.reasons.push('Consistent Facebook referrer with Click ID');
                        }
                    } else if (referrer.includes('instagram.com')) {
                        // ×¤×¨×¡×•× ×××™× ×¡×˜×’×¨× ×¢× fbclid - ×ª×§×™×Ÿ
                        if (result.isHuman && !result.isBot) {
                            score += 15;
                            result.reasons.push('Instagram referrer with Facebook Click ID');
                        }
                    } else {
                        // fbclid ×œ×œ× referrer ×¤×™×™×¡×‘×•×§ - ×—×©×•×“ ×××•×“
                        result.isBot = true;
                        result.reasons.push('Facebook Click ID without Facebook/Instagram referrer');
                        score += 85;
                        return result;
                    }
                } else {
                    // ××™×Ÿ referrer ××‘×œ ×™×© fbclid - ×—×©×•×“
                    result.isBot = true;
                    result.reasons.push('Facebook Click ID without any referrer');
                    score += 75;
                    return result;
                }
                
            }
            
            // ×‘×“×™×§×ª ×¤×¨××˜×¨×™ ref ××ª×§×“××ª
            if (entry.query_params.ref) {
                const ref = entry.query_params.ref;
                
                // ×‘×•×˜×™× × ×•×˜×™× ×œ×”×©×ª××© ×‘-ref ×¤×©×•×˜×™× ×•×‘×•×œ×˜×™×
                const suspiciousRefs = ['facebook', 'fb', 'social', 'bot', 'test', 'auto'];
                if (suspiciousRefs.includes(ref.toLowerCase())) {
                    result.isBot = true;
                    result.reasons.push(`Suspicious ref parameter: ${ref}`);
                    score += 70;
                    return result;
                }
                
                // ref ×ª×§×™× ×™× ××¤×™×™×¡×‘×•×§
                const validRefPatterns = [
                    /facebook\.com/,
                    /m\.facebook\.com/,
                    /l\.facebook\.com/,
                    /lm\.facebook\.com/,
                    /share/,
                    /messenger/
                ];
                
                if (validRefPatterns.some(pattern => pattern.test(ref))) {
                    result.isHuman = true;
                    result.reasons.push(`Valid Facebook ref: ${ref}`);
                    score += 15;
                }
            }
            
            // ×‘×“×™×§×ª ×¤×¨××˜×¨×™ UTM ××ª×§×“××ª
            const utm_source = entry.query_params.utm_source;
            const utm_medium = entry.query_params.utm_medium;
            const utm_campaign = entry.query_params.utm_campaign;
            
            if (utm_source) {
                const source = utm_source.toLowerCase();
                
                // ×‘×“×™×§×ª utm_source ×ª×§×™×Ÿ
                if (['facebook', 'fb', 'facebook.com', 'social', 'meta'].includes(source)) {
                    if (!fbclid && source !== 'social') {
                        // utm_source ×¤×™×™×¡×‘×•×§ ×œ×œ× fbclid - ×—×©×•×“
                        result.isBot = true;
                        result.reasons.push('Facebook UTM source without Click ID');
                        score += 80;
                        return result;
                    } else if (fbclid) {
                        // ×¢×§×‘×™×•×ª ×˜×•×‘×”
                        score += 15;
                        result.reasons.push('Consistent Facebook UTM and Click ID');
                    }
                }
            }
            
            if (utm_medium) {
                const medium = utm_medium.toLowerCase();
                
                // ×‘×“×™×§×ª utm_medium ×ª×§×™×Ÿ
                const validMediums = ['social', 'cpc', 'facebook', 'organic', 'referral'];
                if (validMediums.includes(medium) && fbclid) {
                    score += 10;
                    result.reasons.push('Valid Facebook UTM medium');
                }
            }
            
            // ×‘×“×™×§×ª ×¤×¨××˜×¨×™ Meta/Facebook × ×•×¡×¤×™×
            const metaParams = [
                'fb_source', 'fb_ref', 'fb_action_ids', 'fb_action_types',
                'ig_rid', 'ig_cache_key', 'fb_dtsg', '__tn__', 'eid'
            ];
            
            let hasMetaParams = false;
            for (const param of metaParams) {
                if (entry.query_params[param] !== undefined) {
                    hasMetaParams = true;
                    if (!fbclid) {
                        result.isBot = true;
                        result.reasons.push(`Facebook parameter ${param} without Click ID`);
                        score += 75;
                        return result;
                    } else {
                        score += 10;
                        result.reasons.push('Additional Meta/Facebook parameters present');
                        break;
                    }
                }
            }
            
            // ×‘×“×™×§×ª ×¤×¨××˜×¨×™ ×‘×•×˜ ×’×œ×•×™×™×
            const explicitBotParams = [
                'bot', 'crawler', 'spider', 'scraper', 'test', 'debug',
                'automated', 'bulk', 'mass', 'script', 'headless'
            ];
            
            for (const botParam of explicitBotParams) {
                if (entry.query_params[botParam] !== undefined || 
                    Object.keys(entry.query_params).some(key => key.toLowerCase().includes(botParam)) ||
                    Object.values(entry.query_params).some(value => 
                        typeof value === 'string' && value.toLowerCase().includes(botParam))) {
                    result.isBot = true;
                    result.reasons.push(`Explicit bot parameter detected: ${botParam}`);
                    score += 95;
                    return result;
                }
            }
            
            // ×‘×“×™×§×ª ×¢×•×“×£ ×¤×¨××˜×¨×™× - ×‘×•×˜×™× ×œ×¢×™×ª×™× ××•×¡×™×¤×™× ×™×•×ª×¨ ××“×™
            const paramCount = Object.keys(entry.query_params).length;
            if (paramCount > 15) {
                result.isBot = true;
                result.reasons.push('Excessive parameters count (bot-like)');
                score += 70;
            } else if (paramCount === 0 && !fbclid) {
                result.isBot = true;
                result.reasons.push('No parameters at all (suspicious)');
                score += 60;
            }
            
            // ×‘×“×™×§×ª ×¤×¨××˜×¨×™× ×¢× ×¢×¨×›×™× ×¨×™×§×™× - ×˜×›× ×™×§×ª ×‘×•×˜×™×
            const emptyParams = Object.entries(entry.query_params).filter(([key, value]) => 
                value === '' || value === null || value === undefined);
            if (emptyParams.length > 2) {
                result.isBot = true;
                result.reasons.push('Multiple empty parameters (bot technique)');
                score += 65;
            }
            
            result.confidence = Math.min(score, 100);
            return result;
        }

        // × ×™×ª×•×— ×“×¤×•×¡×™ referrer
        function analyzeReferrerPatterns(entry) {
            const result = {
                isBot: false,
                isHuman: false,
                reasons: [],
                confidence: 0
            };
            
            const referrer = entry.referrer;
            
            if (!referrer) {
                // ××™×Ÿ referrer - ×œ× ×‘×”×›×¨×— ×‘×•×˜, ××‘×œ ×—×©×•×“
                if (!entry.query_params || !entry.query_params.fbclid) {
                    result.isBot = true;
                    result.reasons.push('No referrer and no fbclid');
                    result.confidence = 60;
                }
                return result;
            }
            
            // ×‘×“×™×§×ª referrers ×©×œ ×¤×™×™×¡×‘×•×§
            const facebookDomains = [
                'facebook.com', 'm.facebook.com', 'l.facebook.com', 'lm.facebook.com',
                'www.facebook.com', 'touch.facebook.com', 'mobile.facebook.com'
            ];
            
            let isFacebookReferrer = false;
            for (let domain of facebookDomains) {
                if (referrer.includes(domain)) {
                    isFacebookReferrer = true;
                    result.isHuman = true;
                    result.reasons.push(`Valid Facebook referrer: ${domain}`);
                    result.confidence = 70;
                    break;
                }
            }
            
            // ×“×¤×•×¡×™ referrer ×—×©×•×“×™×
            if (referrer.includes('bot') || referrer.includes('crawler') || 
                referrer.includes('spider') || referrer.includes('scraper')) {
                result.isBot = true;
                result.reasons.push('Bot-related referrer');
                result.confidence = 90;
                return result;
            }
            
            // referrer ×¨×™×§ ××• ×›×œ×œ×™ ××“×™
            if (referrer === 'https://' || referrer === 'http://' || referrer.length < 10) {
                result.isBot = true;
                result.reasons.push('Invalid or empty referrer');
                result.confidence = 70;
                return result;
            }
            
            // ×‘×“×™×§×ª consistency - ×× ×™×© fbclid ××‘×œ ××™×Ÿ referrer ×©×œ ×¤×™×™×¡×‘×•×§
            if (entry.query_params && entry.query_params.fbclid && !isFacebookReferrer) {
                result.isBot = true;
                result.reasons.push('fbclid without Facebook referrer (inconsistent)');
                result.confidence = 80;
            }
            
            return result;
        }

        // ×–×™×”×•×™ ×“×¤×•×¡×™ ×‘×•×˜×™× ×©×œ WhatsApp Business ××ª×§×“× ×•××•×¨×—×‘
        function analyzeWhatsAppPatterns(entry, type, allEntries) {
            const result = {
                isBot: false,
                isHuman: false,
                reasons: [],
                confidence: 0
            };
            
            let score = 0;
            
            // ×–×™×”×•×™ IP WhatsApp ×¡×¤×¦×™×¤×™
            if (entry.ip_address) {
                const ipAnalysis = analyzeIPAddress(entry.ip_address);
                if (ipAnalysis.reason && ipAnalysis.reason.includes('WhatsApp')) {
                    result.isBot = true;
                    result.reasons.push('WhatsApp Business API IP detected');
                    score += 95;
                    return result;
                }
            }
            
            // ×‘×“×™×§×ª ×¤×¨××˜×¨×™ WhatsApp ×¡×¤×¦×™×¤×™×™×
            if (entry.query_params) {
                const params = entry.query_params;
                
                // ×¤×¨××˜×¨×™× ××¤×™×™×¡×‘×•×§ ×¢× ×™×¢×“ WhatsApp - ×—×©×•×“
                if (params.fbclid && type === 'click' && entry.destination === 'whatsapp') {
                    // ×‘×“×¨×š ×›×œ×œ ×¤×™×™×¡×‘×•×§ ×œ× ×©×•×œ×— fbclid ×œ×œ×—×™×¦×•×ª WhatsApp ×™×©×™×¨×•×ª
                    result.isBot = true;
                    result.reasons.push('Facebook Click ID with WhatsApp destination (suspicious)');
                    score += 80;
                    return result;
                }
                
                // ×¤×¨××˜×¨×™ WhatsApp Business ××¤×•×¨×©×™×
                const whatsappBusinessParams = [
                    'wa_btn_id', 'wa_ref', 'wa_source', 'wa_click_id',
                    'whatsapp_source', 'wb_ref', 'business_id'
                ];
                
                for (const param of whatsappBusinessParams) {
                    if (params[param] !== undefined) {
                        if (type === 'click' && entry.destination === 'whatsapp') {
                            result.isHuman = true;
                            result.reasons.push(`Valid WhatsApp Business parameter: ${param}`);
                            score += 20;
                        } else {
                            result.isBot = true;
                            result.reasons.push(`WhatsApp parameter without WhatsApp action: ${param}`);
                            score += 75;
                        }
                    }
                }
                
                // ×‘×“×™×§×ª ×¤×¨××˜×¨×™ ××•×˜×•××¦×™×”
                const automationParams = [
                    'automated', 'bulk_message', 'mass_send', 'bot_id',
                    'script_ref', 'auto_reply', 'broadcast_id'
                ];
                
                for (const autoParam of automationParams) {
                    if (params[autoParam] !== undefined || 
                        Object.keys(params).some(key => key.toLowerCase().includes(autoParam)) ||
                        Object.values(params).some(value => 
                            typeof value === 'string' && value.toLowerCase().includes(autoParam))) {
                        result.isBot = true;
                        result.reasons.push(`WhatsApp automation parameter detected: ${autoParam}`);
                        score += 90;
                        return result;
                    }
                }
            }
            
            // ×× ×–×” ×œ×—×™×¦×” ×¢×œ WhatsApp - × ×™×ª×•×— ××ª×§×“×
            if (type === 'click' && entry.destination === 'whatsapp') {
                
                // ×‘×“×™×§×ª ×“×¤×•×¡ ×–×× ×™× ××ª×§×“× ×¢× ×¡×˜×˜×™×¡×˜×™×§×•×ª ××•×¨×›×‘×•×ª
                if (allEntries && allEntries.length > 1) {
                    const whatsappClicks = allEntries.filter(e => 
                        e.destination === 'whatsapp' && e.ip_address === entry.ip_address
                    ).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    
                    if (whatsappClicks.length >= 3) {
                        // ×—×™×©×•×‘ ×¤×¨×§ ×–××Ÿ ××¤×•×¨×˜
                        const timeDiffs = [];
                        const timestamps = whatsappClicks.map(click => new Date(click.timestamp));
                        
                        for (let i = 1; i < timestamps.length; i++) {
                            const diff = timestamps[i] - timestamps[i-1];
                            timeDiffs.push(diff);
                        }
                        
                        if (timeDiffs.length > 0) {
                            const avgDiff = timeDiffs.reduce((a, b) => a + b, 0) / timeDiffs.length;
                            const variance = timeDiffs.reduce((sum, diff) => 
                                sum + Math.pow(diff - avgDiff, 2), 0) / timeDiffs.length;
                            const stdDev = Math.sqrt(variance);
                            const coefficient = stdDev / avgDiff; // ××§×“× ×•×¨×™××¦×™×”
                            
                            // ×“×¤×•×¡ ×§×‘×•×¢ ××“×™ - ×‘×•×˜
                            if (coefficient < 0.2 && avgDiff < 300000) { // ×¤×—×•×ª ×-5 ×“×§×•×ª ×‘×¤×¢×¨ ×§×‘×•×¢
                                result.isBot = true;
                                result.reasons.push('Highly regular WhatsApp click timing (bot pattern)');
                                score += 85;
                                return result;
                            }
                            
                            // ×“×¤×•×¡ ××”×™×¨ ××“×™
                            if (avgDiff < 30000) { // ×¤×—×•×ª ×-30 ×©× ×™×•×ª ×‘×××•×¦×¢
                                result.isBot = true;
                                result.reasons.push('Too fast WhatsApp click pattern');
                                score += 90;
                                return result;
                            }
                            
                            // ×“×¤×•×¡ ×œ×™×œ×™ ×—×©×•×“ (×‘×•×˜×™× ×¤×•×¢×œ×™× ×‘×œ×™×œ×”)
                            const nightClicks = timestamps.filter(time => {
                                const hour = time.getHours();
                                return hour >= 1 && hour <= 5; // 1:00-5:00 ×œ×™×œ×”
                            });
                            
                            if (nightClicks.length > whatsappClicks.length * 0.7) {
                                result.isBot = true;
                                result.reasons.push('Excessive night-time WhatsApp activity');
                                score += 80;
                                return result;
                            }
                        }
                    }
                    
                    // ×‘×“×™×§×ª ×ª×“×™×¨×•×ª ×™×•××™×ª - ×‘×•×˜×™× ×¢× ×“×¤×•×¡ ×—×•×–×¨
                    if (whatsappClicks.length > 10) {
                        const dailyPattern = {};
                        whatsappClicks.forEach(click => {
                            const date = new Date(click.timestamp).toDateString();
                            dailyPattern[date] = (dailyPattern[date] || 0) + 1;
                        });
                        
                        const dailyCounts = Object.values(dailyPattern);
                        const avgDaily = dailyCounts.reduce((a, b) => a + b, 0) / dailyCounts.length;
                        
                        // ×× ×™×© ×ª×“×™×¨×•×ª ×§×‘×•×¢×” ××“×™ ×œ×™×•×
                        const regularDays = dailyCounts.filter(count => 
                            Math.abs(count - avgDaily) < 2).length;
                        
                        if (regularDays > dailyCounts.length * 0.8 && avgDaily > 5) {
                            result.isBot = true;
                            result.reasons.push('Regular daily WhatsApp activity pattern');
                            score += 75;
                            return result;
                        }
                    }
                }
                
                // ×‘×“×™×§×ª referrer ×¢× ×™×¢×“ WhatsApp
                if (entry.referrer) {
                    const referrer = entry.referrer.toLowerCase();
                    
                    // referrer ××¤×™×™×¡×‘×•×§ ×œ×œ×—×™×¦×ª WhatsApp - ×™×›×•×œ ×œ×”×™×•×ª ×œ×’×™×˜×™××™
                    if (referrer.includes('facebook.com') || referrer.includes('fb.com')) {
                        result.isHuman = true;
                        result.reasons.push('Facebook referrer to WhatsApp click');
                        score += 15;
                    }
                    
                    // referrer ×—×©×•×“
                    if (referrer.includes('whatsapp-bot') || referrer.includes('wa-auto') ||
                        referrer.includes('bulk-wa') || referrer.includes('mass-whatsapp')) {
                        result.isBot = true;
                        result.reasons.push('Suspicious WhatsApp automation referrer');
                        score += 95;
                        return result;
                    }
                } else {
                    // ××™×Ÿ referrer ×œ×œ×—×™×¦×ª WhatsApp - ×§×¦×ª ×—×©×•×“
                    score += 20;
                    result.reasons.push('WhatsApp click without referrer');
                }
                
                // ×‘×“×™×§×ª User Agent ×¢× ×œ×—×™×¦×ª WhatsApp
                if (entry.user_agent) {
                    const ua = entry.user_agent.toLowerCase();
                    
                    // WhatsApp Business API ××©×ª××© ×‘×“×¨×š ×›×œ×œ ×‘-User Agents ×¡×¤×¦×™×¤×™×™×
                    if (ua.includes('whatsapp') && (ua.includes('business') || ua.includes('api'))) {
                        result.isBot = true;
                        result.reasons.push('WhatsApp Business API User Agent');
                        score += 90;
                        return result;
                    }
                    
                    // User Agents ×—×©×•×“×™× ×¢× WhatsApp
                    if ((ua.includes('python') || ua.includes('curl') || ua.includes('wget')) &&
                        type === 'click' && entry.destination === 'whatsapp') {
                        result.isBot = true;
                        result.reasons.push('Script-based WhatsApp click');
                        score += 88;
                        return result;
                    }
                }
                
                // ×œ×—×™×¦×” ×××™×ª×™×ª ×¢×œ WhatsApp - ×ª××™×›×” ×‘×¡×™×¡×™×ª
                if (score < 30) { // ×× ×œ× × ××¦××• ×“×¤×•×¡×™× ×—×©×•×“×™×
                    result.isHuman = true;
                    result.reasons.push('Genuine WhatsApp click');
                    score += 65;
                }
                
            } else if (entry.destination === 'whatsapp' && type !== 'click') {
                // ×’×™×©×” ×œ-WhatsApp ×œ×œ× ×œ×—×™×¦×” - ×—×©×•×“
                result.isBot = true;
                result.reasons.push('WhatsApp access without click action');
                score += 70;
            }
            
            // ×‘×“×™×§×ª ×©×™×œ×•×‘ ×¢× ×¤×¢×™×œ×•×ª × ×•×¡×¤×ª ×××•×ª×• IP
            if (allEntries && entry.ip_address) {
                const sameIPEntries = allEntries.filter(e => 
                    e.ip_address === entry.ip_address && e !== entry
                );
                
                if (sameIPEntries.length > 0) {
                    // ×‘×“×™×§×” ×”×× ×™×© ×¤×¢×™×œ×•×ª ××’×•×•× ×ª ××• ×¨×§ WhatsApp
                    const uniqueDestinations = [...new Set(sameIPEntries.map(e => e.destination))];
                    const whatsappOnlyRatio = sameIPEntries.filter(e => 
                        e.destination === 'whatsapp').length / sameIPEntries.length;
                    
                    if (whatsappOnlyRatio > 0.9 && sameIPEntries.length > 5) {
                        result.isBot = true;
                        result.reasons.push('IP focused exclusively on WhatsApp (suspicious)');
                        score += 85;
                    } else if (uniqueDestinations.length > 3) {
                        // ×¤×¢×™×œ×•×ª ××’×•×•× ×ª - ×¡×™××Ÿ ×œ××“× ×××™×ª×™
                        score += 10;
                        result.reasons.push('Diverse activity pattern from same IP');
                    }
                }
            }
            
            result.confidence = Math.min(score, 100);
            return result;
        }

        // ×™×¦×™×¨×ª ×”××œ×¦×•×ª ××ª×§×“××•×ª
        function generateAdvancedRecommendations(botCount, humanCount, totalEntries, phoneStats) {
            const recommendations = [];
            const botRatio = totalEntries > 0 ? botCount / totalEntries : 0;
            
            if (botRatio > 0.7) {
                recommendations.push('ğŸš¨ ×¨××ª ×‘×•×˜×™× ×§×¨×™×˜×™×ª (>70%) - ×—×§×™×¨×” ××™×™×“×™×ª × ×“×¨×©×ª');
                recommendations.push('ğŸ›¡ï¸ ×”×˜××¢×ª CAPTCHA ×•××¢×¨×›×ª ×”×’× ×” ××ª×§×“××ª');
            } else if (botRatio > 0.5) {
                recommendations.push('âš ï¸ ×¨××ª ×‘×•×˜×™× ×’×‘×•×”×” (>50%) - × ×“×¨×© ×©×™×¤×•×¨ ××¢×¨×›×ª ×”×”×’× ×”');
            } else if (botRatio > 0.3) {
                recommendations.push('ğŸ“Š ×¨××ª ×‘×•×˜×™× ×‘×™× ×•× ×™×ª (>30%) - ××¢×§×‘ ×¨×¦×™×£ × ×“×¨×©');
            } else {
                recommendations.push('âœ… ×¨××ª ×‘×•×˜×™× ×ª×§×™× ×” (<30%)');
            }
            
            // ×”××œ×¦×•×ª ×œ×¤×™ ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ
            const phoneNumbers = Object.keys(phoneStats);
            const highBotPhones = phoneNumbers.filter(phone => {
                const stats = phoneStats[phone];
                const total = stats.clicks + stats.nonClicks;
                return total > 0 && (stats.bots / total) > 0.8;
            });
            
            if (highBotPhones.length > 0) {
                recommendations.push(`ğŸ“ ×–×•×”×• ${highBotPhones.length} ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ ×¢× ×¨××ª ×‘×•×˜×™× ×’×‘×•×”×” - ×‘×“×™×§×” × ×“×¨×©×ª`);
            }
            
            return recommendations;
        }

        // ×™×¦×™×¨×ª ×”××œ×¦×•×ª
        function generateRecommendations(botCount, humanCount, totalEntries) {
            const recommendations = [];
            const botRatio = botCount / totalEntries;

            if (botRatio > 0.5) {
                recommendations.push('ğŸš¨ ×–×™×”×•×™ ×¨××ª ×‘×•×˜×™× ×’×‘×•×”×” ×××•×“ - × ×“×¨×© ×—×§×™×¨×” ××™×™×“×™×ª');
                recommendations.push('ğŸ›¡ï¸ ×”×§××ª ××¢×¨×›×ª ×”×’× ×” ×—×–×§×” ×™×•×ª×¨');
            } else if (botRatio > 0.3) {
                recommendations.push('âš ï¸ ×¨××ª ×‘×•×˜×™× ×’×‘×•×”×” - ××•××œ×¥ ×œ×—×–×§ ××ª ××¢×¨×›×ª ×”×–×™×”×•×™');
            } else if (botRatio > 0.1) {
                recommendations.push('âœ… ×¨××ª ×‘×•×˜×™× ×ª×§×™× ×” - ×”××©×š ××¢×§×‘');
            } else {
                recommendations.push('ğŸ‰ ×¨××ª ×‘×•×˜×™× × ××•×›×” ×××•×“ - ××¢×¨×›×ª ×™×¢×™×œ×”');
            }

            if (humanCount === 0) {
                recommendations.push('ğŸ¤” ×œ× ×–×•×”×• ××©×ª××©×™× ×× ×•×©×™×™× - ×‘×“×•×§ ××ª ××¢×¨×›×ª ×”×–×™×”×•×™');
            }

            return recommendations;
        }

        // ×”×¦×’×ª ×ª×•×¦××•×ª ×”× ×™×ª×•×—
        function displayAnalysisResults(results) {
            const contentDiv = document.getElementById('analysisContent');
            
            // ×ª×—×™×œ×” × ×•×¡×™×£ CSS ×œ×˜×‘×œ××•×ª ×”× ×¤×ª×—×•×ª
            addCollapsibleStyles();
            
            let html = `
                <!-- ×¡×™×›×•× ×›×œ×œ×™ ×¢×œ×™×•×Ÿ -->
                <div style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                    <h3 style="margin: 0 0 20px 0;">ğŸ“Š ×“×•×— × ×™×ª×•×— ×‘×•×˜×™× ××ª×§×“×</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; text-align: center;">
                        <div>
                            <div style="font-size: 2em; font-weight: bold;">${results.summary.totalEntries.toLocaleString()}</div>
                            <div style="opacity: 0.9;">×¡×”"×› ×›× ×™×¡×•×ª ×œ×¢××•×“</div>
                        </div>
                        <div>
                            <div style="font-size: 2em; font-weight: bold; color: #ff6b6b;">${results.summary.botCount.toLocaleString()}</div>
                            <div style="opacity: 0.9;">×‘×•×˜×™× (${(results.summary.botRatio || 0)}%)</div>
                        </div>
                        <div>
                            <div style="font-size: 2em; font-weight: bold; color: #4ecdc4;">${results.summary.humanCount.toLocaleString()}</div>
                            <div style="opacity: 0.9;">×‘× ×™ ××“× ×©× ×›× ×¡×• (${(results.summary.humanRatio || 0)}%)</div>
                        </div>
                        ${results.summary.humanClicks !== undefined ? `
                        <div style="border: 3px solid #ffd93d; border-radius: 10px; padding: 10px; background: rgba(255, 211, 61, 0.1);">
                            <div style="font-size: 2em; font-weight: bold; color: #ffd93d;">${results.summary.humanClicks.toLocaleString()}</div>
                            <div style="opacity: 0.9; font-weight: bold;">âœ… ×œ×—×¦×• ×¢×œ WhatsApp/×˜×œ×¤×•×Ÿ (×××™×ª×™×™×)</div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <!-- ×”×©×•×•××ª ×‘×•×˜×™× ××•×œ ×‘× ×™ ××“× -->
                ${results.summary.humanClicks !== undefined && results.summary.totalNonClicks !== undefined ? `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    
                    <!-- × ×™×ª×•×— ×‘×•×˜×™× -->
                    <div style="background: rgba(244, 67, 54, 0.15); border: 2px solid #F44336; padding: 20px; border-radius: 10px;">
                        <h4 style="color: #F44336; margin-bottom: 15px; text-align: center;">ğŸ¤– ×¤×¢×™×œ×•×ª ×‘×•×˜×™× (×œ× ×××™×ª×™×ª)</h4>
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2.5em; font-weight: bold; color: #F44336;">${results.summary.botCount.toLocaleString()}</div>
                            <div style="color: #ccc;">×¡×”"×› ×‘×•×˜×™× ×©×–×•×”×•</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="color: #FFB74D; font-weight: bold;">âš ï¸ × ×ª×•× ×™× ××œ×” ×œ× ×¨×œ×•×•× ×˜×™×™× ×œ×¢×¡×§</div>
                            <div style="font-size: 0.9em; color: #ccc; margin-top: 5px;">
                                ×‘×•×˜×™× ×œ× ×§×•× ×™× ××•×¦×¨×™× ×•×œ× ×”×•×¤×›×™× ×œ×œ×§×•×—×•×ª
                            </div>
                        </div>
                    </div>

                    <!-- × ×™×ª×•×— ×××™×ª×™ - ×¨×§ ×‘× ×™ ××“× -->
                    <div style="background: rgba(76, 175, 80, 0.15); border: 2px solid #4CAF50; padding: 20px; border-radius: 10px;">
                        <h4 style="color: #4CAF50; margin-bottom: 15px; text-align: center;">ğŸ‘¥ ×œ×§×•×—×•×ª ×¤×•×˜× ×¦×™××œ×™×™× ×××™×ª×™×™×</h4>
                        <div style="text-align: center; margin-bottom: 15px;">
                            <div style="font-size: 2.5em; font-weight: bold; color: #4CAF50;">${results.summary.humanCount.toLocaleString()}</div>
                            <div style="color: #ccc;">×‘× ×™ ××“× ×××™×ª×™×™×</div>
                        </div>
                        
                        <!-- ××¡×œ×•×œ ×”××¨×” ×××™×ª×™ -->
                        ${calculateRealConversionData(results.summary) ? `
                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                            <div style="text-align: center; margin-bottom: 10px; color: #FFC107; font-weight: bold;">
                                ğŸ“ˆ ×©×™×¢×•×¨ ×”××¨×” ×××™×ª×™: ${calculateRealConversionRate(results.summary)}%
                            </div>
                            <div style="font-size: 0.85em; color: #e0e0e0; text-align: center;">
                                ××ª×•×š ${getHumanVisitors(results.summary)} ××‘×§×¨×™× ×××™×ª×™×™×,<br>
                                ${getHumanClicks(results.summary)} ×œ×—×¦×• ×¢×œ WhatsApp/×˜×œ×¤×•×Ÿ
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <!-- ××¡×œ×•×œ ×”××¨×” ××¤×•×¨×˜ - ×¨×§ ×× ×©×™× ×××™×ª×™×™× -->
                <div style="background: rgba(33, 150, 243, 0.15); border: 2px solid #2196F3; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #2196F3; margin-bottom: 15px; text-align: center;">ğŸ”„ ××¡×œ×•×œ ×”××¨×” - ×œ×§×•×—×•×ª ×××™×ª×™×™× ×‘×œ×‘×“</h4>
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        
                        <!-- ×× ×©×™× ×××™×ª×™×™× ×©× ×›× ×¡×• -->
                        <div style="flex: 1; min-width: 150px; text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #90CAF9;">${getHumanVisitors(results.summary)}</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">ğŸ‘¥ ×× ×©×™× ×××™×ª×™×™× × ×›× ×¡×•</div>
                            <div style="font-size: 0.8em; color: #81C784; margin-top: 5px;">ğŸ¯ ×œ×§×•×—×•×ª ×¤×•×˜× ×¦×™××œ×™×™×</div>
                        </div>

                        <!-- ×—×¥ -->
                        <div style="color: #FFC107; font-size: 2em;">â†’</div>

                        <!-- ×¦×¤×• ××‘×œ ×¢×–×‘×• -->
                        <div style="flex: 1; min-width: 150px; text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #FFB74D;">${getHumanNonClicks(results.summary)}</div>
                            <div style="font-size: 0.9em; opacity: 0.9;">ğŸ‘€ ×¦×¤×• ××‘×œ ×¢×–×‘×•</div>
                            <div style="font-size: 0.8em; color: #FF7043; margin-top: 5px;">âŒ ×”×–×“×× ×•×™×•×ª ×©×”×•×—××¦×•</div>
                        </div>

                        <!-- ×—×¥ -->
                        <div style="color: #4CAF50; font-size: 2em;">â†’</div>

                        <!-- ×œ×—×¦×• ×¢×œ WhatsApp -->
                        <div style="flex: 1; min-width: 150px; text-align: center; padding: 15px; background: rgba(76, 175, 80, 0.2); border: 2px solid #4CAF50; border-radius: 8px;">
                            <div style="font-size: 1.5em; font-weight: bold; color: #4CAF50;">${getHumanClicks(results.summary)}</div>
                            <div style="font-size: 0.9em; font-weight: bold;">âœ… ×œ×—×¦×• ×¢×œ WhatsApp</div>
                            <div style="font-size: 0.8em; color: #66BB6A; margin-top: 5px;">ğŸ’° ×”×¤×›×• ×œ×œ×™×“×™×!</div>
                        </div>
                    </div>
                    
                    <!-- ×©×™×¢×•×¨ ×”××¨×” ×××™×ª×™ -->
                    <div style="margin-top: 20px; text-align: center; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; border: 2px solid #4CAF50;">
                        <div style="font-size: 1.4em; font-weight: bold; color: #4CAF50;">
                            ğŸ¯ ×©×™×¢×•×¨ ×”××¨×” ×××™×ª×™: ${calculateRealConversionRate(results.summary)}%
                        </div>
                        <div style="font-size: 1em; color: #81C784; margin-top: 5px; font-weight: bold;">
                            ××ª×•×š ${getHumanVisitors(results.summary)} ×× ×©×™× ×××™×ª×™×™×, ${getHumanClicks(results.summary)} ×”×¤×›×• ×œ×œ×™×“×™×
                        </div>
                        <div style="font-size: 0.85em; opacity: 0.8; margin-top: 8px; color: #e0e0e0;">
                            (×œ×œ× ×‘×•×˜×™× - ×¨×§ × ×ª×•× ×™× ×¢×¡×§×™×™× ×¨×œ×•×•× ×˜×™×™×)
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- ×’×¨×£ ×¢×•×’×” -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                    <h4 style="color: #FF9800; margin-bottom: 15px;">ğŸ¥§ ×”×ª×¤×œ×’×•×ª ×ª× ×•×¢×”</h4>
                    <div style="position: relative; height: 200px;">
                        ${createAdvancedPieChart(results.summary)}
                    </div>
                </div>

                <!-- ×›×¤×ª×•×¨×™ ×”×•×¨×“×ª ×“×•×— -->
                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center;">
                    <h4 style="color: #2196F3; margin-bottom: 15px;">ğŸ“¥ ×”×•×¨×“×ª ×“×•×— × ×™×ª×•×—</h4>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="downloadAnalysisReport('json')" style="background: linear-gradient(45deg, #4CAF50, #66BB6A); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s ease;">
                            ğŸ“„ ×”×•×¨×“ JSON
                        </button>
                        <button onclick="downloadAnalysisReport('csv')" style="background: linear-gradient(45deg, #FF9800, #FFB74D); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s ease;">
                            ğŸ“Š ×”×•×¨×“ CSV
                        </button>
                        <button onclick="downloadAnalysisReport('summary')" style="background: linear-gradient(45deg, #9C27B0, #BA68C8); color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s ease;">
                            ğŸ“‹ ×”×•×¨×“ ×¡×™×›×•× ×˜×§×¡×˜
                        </button>
                    </div>
                </div>
                
                <!-- ×˜×‘×œ××•×ª × ×ª×•× ×™× ××¤×•×¨×˜×•×ª -->
                <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
            `;

            // ×˜×‘×œ×ª ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ
            if (results.phoneNumberStats) {
                html += createCollapsibleSection(
                    'phone-stats', 
                    'ğŸ“ × ×™×ª×•×— ×œ×¤×™ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ', 
                    createPhoneStatsTable(results.phoneNumberStats)
                );
            }

            // ×˜×‘×œ×ª ×›×ª×•×‘×•×ª IP
            if (results.ipAnalysis) {
                html += createCollapsibleSection(
                    'ip-analysis', 
                    'ğŸŒ × ×™×ª×•×— ×›×ª×•×‘×•×ª IP', 
                    createIPAnalysisTable(results.ipAnalysis)
                );
            }

            // ×˜×‘×œ×ª ×™×¢×“×™ ×œ×—×™×¦×•×ª
            if (results.clickDestinations) {
                html += createCollapsibleSection(
                    'click-destinations', 
                    'ğŸ¯ ×™×¢×“×™ ×œ×—×™×¦×•×ª', 
                    createClickDestinationsTable(results.clickDestinations)
                );
            }

            // ×˜×‘×œ×ª ××§×•×¨×•×ª ×ª× ×•×¢×”
            if (results.sourceAnalysis && Object.keys(results.sourceAnalysis).length > 0) {
                html += createCollapsibleSection(
                    'source-analysis', 
                    'ğŸ“Š ××§×•×¨×•×ª ×ª× ×•×¢×”', 
                    createSourceAnalysisTable(results.sourceAnalysis)
                );
            }

            // ×”×ª×¤×œ×’×•×ª ×–×× ×™×
            if (results.timeDistribution) {
                html += createCollapsibleSection(
                    'time-distribution', 
                    'ğŸ• ×”×ª×¤×œ×’×•×ª ×œ×¤×™ ×©×¢×•×ª', 
                    createTimeDistributionChart(results.timeDistribution)
                );
            }

            // × ×™×ª×•×— ×–×× ×™ ×©×”×™×™×” ×•× ×˜×™×©×”
            html += createCollapsibleSection(
                'abandonment-analysis', 
                'â±ï¸ × ×™×ª×•×— ×–×× ×™ ×©×”×™×™×” ×•× ×˜×™×©×”', 
                createAbandonmentAnalysis(results)
            );

            // × ×™×ª×•×— × ×ª×•× ×™× ×§×™×™××™× ×œ×©×œ×‘×™ ×”××¨×”
            html += createCollapsibleSection(
                'existing-data-analysis', 
                'ğŸ” × ×™×ª×•×— ×©×œ×‘×™ ×”××¨×” ××”× ×ª×•× ×™× ×”×§×™×™××™×', 
                analyzeExistingConversionData(results)
            );

            // ×”××œ×¦×•×ª
            if (results.recommendations && results.recommendations.length > 0) {
                html += `
                    <div style="background: rgba(255,193,7,0.2); border: 1px solid #FFC107; padding: 20px; border-radius: 10px; margin-top: 20px;">
                        <h4 style="color: #FFC107; margin-bottom: 15px;">ğŸ’¡ ×”××œ×¦×•×ª ××¢×¨×›×ª</h4>
                        <ul style="text-align: right; list-style: none; padding: 0;">
                `;
                
                results.recommendations.forEach(rec => {
                    html += `<li style="margin: 10px 0; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 8px; border-right: 4px solid #FFC107;">${rec}</li>`;
                });
                
                html += `</ul></div>`;
            }

            html += `</div>`;
            
            contentDiv.innerHTML = html;
            
            // ×©××™×¨×ª ×ª×•×¦××•×ª ×”× ×™×ª×•×— ×œ××©×ª× ×” ×’×œ×•×‘×œ×™ ×œ×”×•×¨×“×”
            window.lastAnalysisResults = results;
            
            console.log('âœ… Analysis complete:', results);
        }

        // ×”×•×¨×“×ª ×“×•×— × ×™×ª×•×— ×§×‘×¦×™× ×©×”×•×¢×œ×•
        function downloadAnalysisReport(format) {
            if (!window.lastAnalysisResults) {
                showClosablePopup('âŒ ××™×Ÿ ×ª×•×¦××•×ª × ×™×ª×•×— ×–××™× ×•×ª ×œ×”×•×¨×“×”');
                return;
            }

            const results = window.lastAnalysisResults;
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            let filename, content, mimeType;

            switch (format) {
                case 'json':
                    filename = `bot_analysis_report_${timestamp}.json`;
                    content = JSON.stringify(results, null, 2);
                    mimeType = 'application/json';
                    break;

                case 'csv':
                    filename = `bot_analysis_report_${timestamp}.csv`;
                    content = generateAnalysisCSV(results);
                    mimeType = 'text/csv;charset=utf-8;';
                    break;

                case 'summary':
                    filename = `bot_analysis_summary_${timestamp}.txt`;
                    content = generateAnalysisSummary(results);
                    mimeType = 'text/plain;charset=utf-8;';
                    break;

                default:
                    showClosablePopup('âŒ ×¤×•×¨××˜ ×œ× × ×ª××š');
                    return;
            }

            // ×™×¦×™×¨×ª ×§×•×‘×¥ ×•×”×•×¨×“×”
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showClosablePopup(`ğŸ“¥ ×“×•×— ${format.toUpperCase()} ×”×•×¨×“ ×‘×”×¦×œ×—×”!`);
        }

        // ×™×¦×™×¨×ª CSV ××ª×•×¦××•×ª ×”× ×™×ª×•×—
        function generateAnalysisCSV(results) {
            let csv = '×§×˜×’×•×¨×™×”,×¢×¨×š,×¤×¨×˜×™×\n';

            // ×¡×™×›×•× ×›×œ×œ×™
            csv += `×¡×”"×› ×›× ×™×¡×•×ª ×œ×¢××•×“,${results.summary.totalEntries},×›×•×œ×œ ×‘×•×˜×™× ×•×‘× ×™ ××“×\n`;
            csv += `×‘×•×˜×™×,${results.summary.botCount},${results.summary.botRatio}%\n`;
            csv += `×‘× ×™ ××“× ×©× ×›× ×¡×•,${results.summary.humanCount},${results.summary.humanRatio}%\n`;
            
            if (results.summary.humanClicks !== undefined) {
                csv += `×œ×—×¦×• ×¢×œ WhatsApp/×˜×œ×¤×•×Ÿ,${results.summary.humanClicks},×¤×¢×•×œ×•×ª ×××™×ª×™×•×ª (×œ×œ× ×‘×•×˜×™×)\n`;
            }
            
            if (results.summary.totalNonClicks !== undefined) {
                csv += `×¦×¤×• ×‘×ª×•×›×Ÿ ××‘×œ ×¢×–×‘×•,${results.summary.totalNonClicks},×œ× ×‘×™×¦×¢×• ×¤×¢×•×œ×”\n`;
            }

            // ×©×™×¢×•×¨ ×”××¨×” (×¨×§ ×‘× ×™ ××“× ×××™×ª×™×™×)
            if (results.summary.humanClicks !== undefined && results.summary.totalNonClicks !== undefined) {
                const conversionRate = ((results.summary.humanClicks / (results.summary.humanClicks + results.summary.totalNonClicks)) * 100).toFixed(1);
                csv += `×©×™×¢×•×¨ ×”××¨×” ×××™×ª×™,${conversionRate}%,××ª×•×š ×‘× ×™ ××“× ×××™×ª×™×™× ×‘×œ×‘×“\n`;
            }

            // × ×ª×•× ×™ ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ
            if (results.phoneNumberStats) {
                csv += '\n××¡×¤×¨ ×˜×œ×¤×•×Ÿ,×§×œ×™×§×™×,×‘×§×©×•×ª ×œ×œ× ×§×œ×™×§,×‘×•×˜×™×,×‘× ×™ ××“×\n';
                Object.entries(results.phoneNumberStats).forEach(([phone, stats]) => {
                    csv += `${phone},${stats.clicks},${stats.nonClicks},${stats.bots},${stats.humans}\n`;
                });
            }

            // × ×ª×•× ×™ IP
            if (results.ipAnalysis) {
                csv += '\n×›×ª×•×‘×ª IP,××¡×¤×¨ ×¤× ×™×•×ª,×¡×•×’\n';
                Object.entries(results.ipAnalysis).forEach(([ip, data]) => {
                    const type = data.isBot ? '×‘×•×˜' : data.isHuman ? '××“×' : '×œ× ×™×“×•×¢';
                    csv += `${ip},${data.count},${type}\n`;
                });
            }

            return csv;
        }

        // ×™×¦×™×¨×ª ×¡×™×›×•× ×˜×§×¡×˜
        function generateAnalysisSummary(results) {
            let summary = 'ğŸ“Š ×“×•×— × ×™×ª×•×— ×‘×•×˜×™× ××ª×§×“×\n';
            summary += '='.repeat(40) + '\n\n';

            summary += `ğŸ“… ×ª××¨×™×š: ${new Date().toLocaleDateString('he-IL')}\n`;
            summary += `â° ×©×¢×”: ${new Date().toLocaleTimeString('he-IL')}\n\n`;

            summary += 'ğŸ“ˆ ×¡×™×›×•× ×›×œ×œ×™:\n';
            summary += '-'.repeat(20) + '\n';
            summary += `â€¢ ×¡×”"×› ×›× ×™×¡×•×ª ×œ×¢××•×“: ${results.summary.totalEntries.toLocaleString()}\n`;
            summary += `â€¢ ×‘×•×˜×™× ×–×•×”×•: ${results.summary.botCount.toLocaleString()} (${results.summary.botRatio}%)\n`;
            summary += `â€¢ ×‘× ×™ ××“× ×©× ×›× ×¡×•: ${results.summary.humanCount.toLocaleString()} (${results.summary.humanRatio}%)\n`;
            
            if (results.summary.humanClicks !== undefined) {
                summary += `â€¢ âœ… ×œ×—×¦×• ×¢×œ WhatsApp/×˜×œ×¤×•×Ÿ: ${results.summary.humanClicks.toLocaleString()} (×××™×ª×™×™× ×‘×œ×‘×“)\n`;
            }
            
            if (results.summary.totalNonClicks !== undefined) {
                summary += `â€¢ âŒ ×¦×¤×• ×‘×ª×•×›×Ÿ ××‘×œ ×¢×–×‘×•: ${results.summary.totalNonClicks.toLocaleString()}\n`;
            }

            // ×©×™×¢×•×¨ ×”××¨×” ×××™×ª×™
            if (results.summary.humanClicks !== undefined && results.summary.totalNonClicks !== undefined) {
                const conversionRate = ((results.summary.humanClicks / (results.summary.humanClicks + results.summary.totalNonClicks)) * 100).toFixed(1);
                summary += `â€¢ ğŸ“ˆ ×©×™×¢×•×¨ ×”××¨×” ×××™×ª×™: ${conversionRate}% (×¨×§ ×‘× ×™ ××“× ×××™×ª×™×™×)\n`;
                
                // × ×ª×•× ×™× × ×•×¡×¤×™×
                summary += `\nğŸ” × ×™×ª×•×— ×”×ª× ×”×’×•×ª:\n`;
                summary += '-'.repeat(20) + '\n';
                summary += `â€¢ ${results.summary.totalNonClicks} ×× ×©×™× ×¢×–×‘×• ××ª ×”×¢××•×“ ××‘×œ×™ ×œ×‘×¦×¢ ×¤×¢×•×œ×”\n`;
                summary += `â€¢ ×–××Ÿ ×©×”×™×™×” ×××•×¦×¢ ×¢×“ × ×˜×™×©×”: ×œ× ×–××™×Ÿ ×‘×§×•×‘×¥ ×–×”\n`;
                summary += `â€¢ × ×§×•×“×•×ª × ×˜×™×©×” ×¢×™×§×¨×™×•×ª: ×¦×¤×™×™×” ×‘×ª×•×›×Ÿ ×‘×œ×‘×“\n`;
                summary += `â€¢ ×”×¦×¢×” ×œ×©×™×¤×•×¨: ×—×™×–×•×§ ×§×¨×™××ª ×”×¤×¢×•×œ×” (Call to Action)\n`;
            }
            
            if (results.summary.suspiciousActivities !== undefined) {
                summary += `â€¢ ×¤×¢×™×œ×•×™×•×ª ×—×©×•×“×•×ª: ${results.summary.suspiciousActivities}\n`;
            }

            // ×”××œ×¦×•×ª
            if (results.recommendations && results.recommendations.length > 0) {
                summary += '\nğŸ’¡ ×”××œ×¦×•×ª ××¢×¨×›×ª:\n';
                summary += '-'.repeat(20) + '\n';
                results.recommendations.forEach(rec => {
                    summary += `â€¢ ${rec}\n`;
                });
            }

            // × ×ª×•× ×™× ××¤×•×¨×˜×™×
            if (results.phoneNumberStats) {
                summary += '\nğŸ“ ×¡×™×›×•× ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ:\n';
                summary += '-'.repeat(25) + '\n';
                Object.entries(results.phoneNumberStats).forEach(([phone, stats]) => {
                    summary += `${phone}: ${stats.clicks} ×§×œ×™×§×™×, ${stats.bots} ×‘×•×˜×™×, ${stats.humans} ×× ×©×™×\n`;
                });
            }

            summary += '\n' + '='.repeat(40) + '\n';
            summary += 'ğŸ¤– ××¢×¨×›×ª ×–×™×”×•×™ ×‘×•×˜×™× ××ª×§×“××ª - × ×•×¦×¨ ××•×˜×•××˜×™×ª\n';

            return summary;
        }

        // ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×—×™×©×•×‘ × ×ª×•× ×™× ×××™×ª×™×™× (×œ×œ× ×‘×•×˜×™×)
        function calculateRealConversionData(summary) {
            return summary.humanClicks !== undefined && summary.totalNonClicks !== undefined && summary.humanCount > 0;
        }

        function calculateRealConversionRate(summary) {
            const humanVisitors = getHumanVisitors(summary);
            const humanClicks = getHumanClicks(summary);
            
            if (humanVisitors === 0) return '0.0';
            return ((humanClicks / humanVisitors) * 100).toFixed(1);
        }

        function getHumanVisitors(summary) {
            // ×× ×™×— ×©×›×œ ×”×œ×§×•×—×•×ª ×”×××™×ª×™×™× ×”× ×‘× ×™ ××“× (humanCount ×›×•×œ×œ ×’× clicks ×•×’× non-clicks)
            return summary.humanCount || 0;
        }

        function getHumanClicks(summary) {
            // ××—×–×™×¨ ××ª ××¡×¤×¨ ×”×§×œ×™×§×™× ×”×××™×ª×™×™× ×©×œ ×‘× ×™ ××“× ×‘×œ×‘×“ (×œ×œ× ×‘×•×˜×™×)
            return summary.humanClicks || 0;
        }

        function getHumanNonClicks(summary) {
            // ×‘× ×™ ××“× ×©× ×›× ×¡×• ××‘×œ ×œ× ×œ×—×¦×• = ×¡×”"×› ×‘× ×™ ××“× ××™× ×•×¡ ×”×§×œ×™×§×™×
            const totalHumans = summary.humanCount || 0;
            const humanClicks = getHumanClicks(summary);
            return Math.max(0, totalHumans - humanClicks);
        }

        // ×”×•×¡×¤×ª ×¡×’× ×•× ×•×ª ×œ×˜×‘×œ××•×ª × ×¤×ª×—×•×ª
        function addCollapsibleStyles() {
            if (document.getElementById('collapsible-styles')) return;
            
            const style = document.createElement('style');
            style.id = 'collapsible-styles';
            style.textContent = `
                .collapsible-header {
                    background: rgba(255,255,255,0.15);
                    color: white;
                    cursor: pointer;
                    padding: 15px 20px;
                    border: none;
                    border-radius: 10px;
                    text-align: right;
                    outline: none;
                    font-size: 16px;
                    font-weight: bold;
                    transition: all 0.3s ease;
                    width: 100%;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                
                .collapsible-header:hover {
                    background: rgba(255,255,255,0.25);
                    transform: translateY(-2px);
                }
                
                .collapsible-header.active {
                    background: rgba(255,255,255,0.2);
                    border-bottom-left-radius: 0;
                    border-bottom-right-radius: 0;
                }
                
                .collapsible-content {
                    max-height: 0;
                    overflow: hidden;
                    transition: max-height 0.3s ease;
                    background: rgba(255,255,255,0.05);
                    border-radius: 0 0 10px 10px;
                }
                
                .collapsible-content.active {
                    max-height: 1000px;
                    padding: 20px;
                }
                
                /* ×¤×•×¤-××¤ × ×¡×’×¨ */
                .closeable-popup {
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.9);
                    color: white;
                    padding: 20px 30px;
                    border-radius: 15px;
                    border: 2px solid #4CAF50;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
                    z-index: 10000;
                    text-align: center;
                    font-size: 16px;
                    max-width: 400px;
                    animation: popup-in 0.3s ease-out;
                }
                
                .closeable-popup .close-btn {
                    position: absolute;
                    top: -10px;
                    right: -10px;
                    background: #ff4444;
                    color: white;
                    border: none;
                    border-radius: 50%;
                    width: 30px;
                    height: 30px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: bold;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s ease;
                }
                
                .closeable-popup .close-btn:hover {
                    background: #ff6666;
                    transform: scale(1.1);
                }
                
                @keyframes popup-in {
                    from {
                        opacity: 0;
                        transform: translate(-50%, -50%) scale(0.8);
                    }
                    to {
                        opacity: 1;
                        transform: translate(-50%, -50%) scale(1);
                    }
                }
                
                .data-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 10px;
                    background: rgba(255,255,255,0.1);
                    border-radius: 8px;
                    overflow: hidden;
                }
                
                .data-table th,
                .data-table td {
                    padding: 12px 15px;
                    text-align: right;
                    border-bottom: 1px solid rgba(255,255,255,0.1);
                }
                
                .data-table th {
                    background: rgba(255,255,255,0.2);
                    font-weight: bold;
                    color: #ffd700;
                }
                
                .data-table tr:hover {
                    background: rgba(255,255,255,0.1);
                }
                
                .bot-indicator {
                    background: #ff6b6b;
                    color: white;
                    padding: 4px 8px;
                    border-radius: 12px;
                    font-size: 0.8em;
                }
                
                .human-indicator {
                    background: #4ecdc4;
                    color: white;
                    padding: 4px 8px;
                    border-radius: 12px;
                    font-size: 0.8em;
                }
                
                .suspicious-indicator {
                    background: #ffa726;
                    color: white;
                    padding: 4px 8px;
                    border-radius: 12px;
                    font-size: 0.8em;
                }
            `;
            document.head.appendChild(style);
        }

        // ×™×¦×™×¨×ª ×¡×¢×™×£ × ×¤×ª×—
        function createCollapsibleSection(id, title, content) {
            return `
                <div style="margin-bottom: 15px;">
                    <button class="collapsible-header" onclick="toggleCollapsible('${id}')">
                        <span>${title}</span>
                        <span id="${id}-icon">â–¼</span>
                    </button>
                    <div id="${id}" class="collapsible-content">
                        ${content}
                    </div>
                </div>
            `;
        }

        // ×¤×•× ×§×¦×™×™×ª ×¤×ª×™×—×”/×¡×’×™×¨×ª ×¡×¢×™×¤×™×
        function toggleCollapsible(id) {
            const content = document.getElementById(id);
            const icon = document.getElementById(id + '-icon');
            const header = content.previousElementSibling;
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                header.classList.remove('active');
                icon.textContent = 'â–¼';
            } else {
                content.classList.add('active');
                header.classList.add('active');
                icon.textContent = 'â–²';
            }
        }

        // ×™×¦×™×¨×ª ×˜×‘×œ×ª ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ
        function createPhoneStatsTable(phoneStats) {
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>××¡×¤×¨ ×˜×œ×¤×•×Ÿ</th>
                            <th>×¡×”"×› ×§×œ×™×§×™×</th>
                            <th>×‘×§×©×•×ª ×›×œ×œ×™</th>
                            <th>×‘×•×˜×™×</th>
                            <th>×‘× ×™ ××“×</th>
                            <th>×—×©×•×“×™×</th>
                            <th>% ×‘×•×˜×™×</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.entries(phoneStats)
                .sort((a, b) => (b[1].clicks + b[1].nonClicks) - (a[1].clicks + a[1].nonClicks))
                .forEach(([phone, stats]) => {
                    const total = stats.clicks + stats.nonClicks;
                    const botPercentage = total > 0 ? ((stats.bots / total) * 100).toFixed(1) : '0';
                    
                    html += `
                        <tr>
                            <td><strong>${phone}</strong></td>
                            <td>${stats.clicks.toLocaleString()}</td>
                            <td>${stats.nonClicks.toLocaleString()}</td>
                            <td><span class="bot-indicator">${stats.bots}</span></td>
                            <td><span class="human-indicator">${stats.humans}</span></td>
                            <td><span class="suspicious-indicator">${stats.suspicious}</span></td>
                            <td><strong>${botPercentage}%</strong></td>
                        </tr>
                    `;
                });
            
            html += `</tbody></table>`;
            return html;
        }

        // ×™×¦×™×¨×ª ×˜×‘×œ×ª × ×™×ª×•×— IP
        function createIPAnalysisTable(ipAnalysis) {
            let html = `
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>×›×ª×•×‘×ª IP</th>
                                <th>××¡×¤×¨ ×‘×§×©×•×ª</th>
                                <th>×¡×•×’</th>
                                <th>×¡×˜×˜×•×¡</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            Object.entries(ipAnalysis)
                .sort((a, b) => b[1].count - a[1].count)
                .slice(0, 50) // ×”×¦×’×ª 50 ×”×¨××©×•× ×™×
                .forEach(([ip, data]) => {
                    const status = data.isBot ? 'bot-indicator' : data.isHuman ? 'human-indicator' : 'suspicious-indicator';
                    const statusText = data.isBot ? '×‘×•×˜' : data.isHuman ? '×× ×•×©×™' : '×—×©×•×“';
                    
                    html += `
                        <tr>
                            <td><code>${ip}</code></td>
                            <td>${data.count.toLocaleString()}</td>
                            <td>${getIPProvider(ip)}</td>
                            <td><span class="${status}">${statusText}</span></td>
                        </tr>
                    `;
                });
            
            html += `</tbody></table></div>`;
            return html;
        }

        // ×–×™×”×•×™ ×¡×¤×§ IP
        function getIPProvider(ip) {
            if (ip.match(/^66\.249\./)) return 'Google Bot';
            if (ip.match(/^(173\.252\.|69\.171\.|31\.13\.)/)) return 'Facebook Bot';
            if (ip.match(/^(40\.|52\.|13\.|20\.)/)) return 'Microsoft';
            if (ip.match(/^(2\.54\.|5\.28\.|77\.127\.)/)) return '×¡×¤×§ ×™×©×¨××œ×™';
            if (ip.match(/^(54\.|3\.|18\.)/)) return 'AWS Cloud';
            return '×œ× ××–×•×”×”';
        }

        // ×™×¦×™×¨×ª ×˜×‘×œ×ª ×™×¢×“×™ ×œ×—×™×¦×•×ª
        function createClickDestinationsTable(destinations) {
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>×™×¢×“ ×œ×—×™×¦×”</th>
                            <th>××¡×¤×¨ ×œ×—×™×¦×•×ª</th>
                            <th>××—×•×–</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const total = Object.values(destinations).reduce((sum, count) => sum + count, 0);
            
            Object.entries(destinations)
                .sort((a, b) => b[1] - a[1])
                .forEach(([destination, count]) => {
                    const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0';
                    const icon = destination === 'whatsapp' ? 'ğŸ’¬' : destination === 'telephone' ? 'ğŸ“' : 'ğŸ”—';
                    
                    html += `
                        <tr>
                            <td>${icon} ${destination}</td>
                            <td><strong>${count.toLocaleString()}</strong></td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
            
            html += `</tbody></table>`;
            return html;
        }

        // ×™×¦×™×¨×ª ×˜×‘×œ×ª ××§×•×¨×•×ª ×ª× ×•×¢×”
        function createSourceAnalysisTable(sources) {
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>××§×•×¨ ×ª× ×•×¢×”</th>
                            <th>××¡×¤×¨ ×‘×§×©×•×ª</th>
                            <th>××—×•×–</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            const total = Object.values(sources).reduce((sum, count) => sum + count, 0);
            
            Object.entries(sources)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20) // ×”×¦×’×ª 20 ×”×¨××©×•× ×™×
                .forEach(([source, count]) => {
                    const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0';
                    const displaySource = source.length > 50 ? source.substring(0, 47) + '...' : source;
                    
                    html += `
                        <tr>
                            <td>${displaySource || '×’×™×©×” ×™×©×™×¨×”'}</td>
                            <td><strong>${count.toLocaleString()}</strong></td>
                            <td>${percentage}%</td>
                        </tr>
                    `;
                });
            
            html += `</tbody></table>`;
            return html;
        }

        // ×™×¦×™×¨×ª ×’×¨×£ ×”×ª×¤×œ×’×•×ª ×–×× ×™×
        function createTimeDistributionChart(timeDistribution) {
            const maxCount = Math.max(...Object.values(timeDistribution));
            
            let html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 5px; max-width: 800px; margin: 0 auto;">
            `;
            
            for (let hour = 0; hour < 24; hour++) {
                const count = timeDistribution[hour] || 0;
                const height = maxCount > 0 ? (count / maxCount) * 100 : 0;
                const intensity = maxCount > 0 ? (count / maxCount) : 0;
                
                html += `
                    <div style="text-align: center;">
                        <div style="height: 80px; display: flex; align-items: end; justify-content: center;">
                            <div style="
                                width: 20px; 
                                height: ${height}%; 
                                background: rgba(76, 175, 80, ${0.3 + intensity * 0.7}); 
                                border-radius: 3px 3px 0 0;
                                transition: all 0.3s ease;
                            " title="${hour}:00 - ${count} ×‘×§×©×•×ª"></div>
                        </div>
                        <div style="font-size: 11px; margin-top: 5px;">${hour}</div>
                        <div style="font-size: 10px; color: #ccc;">${count}</div>
                    </div>
                `;
            }
            
            html += `</div></div>`;
            return html;
        }

        // × ×™×ª×•×— ×–×× ×™ ×©×”×™×™×” ×•× ×˜×™×©×” - ×¨×§ ×‘× ×™ ××“× ×××™×ª×™×™×
        function createAbandonmentAnalysis(results) {
            const summary = results.summary;
            
            // ×—×™×©×•×‘ × ×˜×™×©×” ×××™×ª×™×ª (×¨×§ ×‘× ×™ ××“×)
            const humanVisitors = getHumanVisitors(summary);
            const humanClicks = getHumanClicks(summary);
            const humanNonClicks = getHumanNonClicks(summary);
            const realAbandonmentRate = humanVisitors > 0 ? 
                ((humanNonClicks / humanVisitors) * 100).toFixed(1) : 0;
            
            let html = `
                <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px;">
                    <h4 style="color: #FF5722; margin-bottom: 20px; text-align: center;">ğŸ“Š × ×™×ª×•×— × ×˜×™×©×” - ×œ×§×•×—×•×ª ×××™×ª×™×™× ×‘×œ×‘×“</h4>
                    
                    <!-- ×”×ª×¨××” ×¢×œ × ×ª×•× ×™× ×××™×ª×™×™× -->
                    <div style="background: rgba(76, 175, 80, 0.1); border: 1px solid #4CAF50; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                        <div style="color: #4CAF50; font-weight: bold; margin-bottom: 5px;">âœ… × ×™×ª×•×— ××‘×•×¡×¡ ×¨×§ ×¢×œ ×‘× ×™ ××“× ×××™×ª×™×™×</div>
                        <div style="font-size: 0.9em; color: #e0e0e0;">×‘×•×˜×™× ×œ× × ×›×œ×œ×™× ×‘×—×™×©×•×‘ - ×¨×§ × ×ª×•× ×™× ×¢×¡×§×™×™× ×¨×œ×•×•× ×˜×™×™×</div>
                    </div>
                    
                    <!-- ×¡×˜×˜×™×¡×˜×™×§×•×ª × ×˜×™×©×” ×××™×ª×™×•×ª -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                        <div style="background: rgba(244, 67, 54, 0.1); border: 1px solid #F44336; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.8em; font-weight: bold; color: #F44336;">${realAbandonmentRate}%</div>
                            <div style="color: #ccc; font-size: 0.9em;">×©×™×¢×•×¨ × ×˜×™×©×” ×××™×ª×™</div>
                        </div>
                        
                        <div style="background: rgba(255, 152, 0, 0.1); border: 1px solid #FF9800; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.8em; font-weight: bold; color: #FF9800;">${humanNonClicks}</div>
                            <div style="color: #ccc; font-size: 0.9em;">×× ×©×™× ×¢×–×‘×• ×œ×œ× ×¤×¢×•×œ×”</div>
                        </div>
                        
                        <div style="background: rgba(76, 175, 80, 0.1); border: 1px solid #4CAF50; padding: 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 1.8em; font-weight: bold; color: #4CAF50;">${humanClicks}</div>
                            <div style="color: #ccc; font-size: 0.9em;">×× ×©×™× ×‘×™×¦×¢×• ×¤×¢×•×œ×”</div>
                        </div>
                    </div>

                    <!-- × ×™×ª×•×— × ×§×•×“×•×ª × ×˜×™×©×” -->
                    <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h5 style="color: #FFC107; margin-bottom: 15px;">ğŸ¯ × ×§×•×“×•×ª × ×˜×™×©×” ×¢×™×§×¨×™×•×ª</h5>
                        <div style="text-align: right;">
                            <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                                <strong style="color: #FF7043;">ğŸ“– ×¦×¤×™×™×” ×‘×ª×•×›×Ÿ ×‘×œ×‘×“:</strong> ${humanNonClicks} ×× ×©×™× ×××™×ª×™×™×
                                <div style="font-size: 0.85em; color: #ccc; margin-top: 5px;">
                                    ×œ×§×•×—×•×ª ×¤×•×˜× ×¦×™××œ×™×™× ×©×§×¨××• ××ª ×”×ª×•×›×Ÿ ××‘×œ ×œ× ×œ×—×¦×• ×¢×œ ×›×¤×ª×•×¨ WhatsApp/×˜×œ×¤×•×Ÿ
                                </div>
                            </div>
                            <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                                <strong style="color: #FF7043;">â±ï¸ ×–××Ÿ ×©×”×™×™×” ×××•×¦×¢:</strong> ×œ× ×–××™×Ÿ ×‘× ×ª×•× ×™×
                                <div style="font-size: 0.85em; color: #ccc; margin-top: 5px;">
                                    ×“×•×¨×© × ×ª×•× ×™ tracking ×–××Ÿ ××”××ª×¨ ×©×œ×š
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ×”××œ×¦×•×ª ×œ×©×™×¤×•×¨ ×”××¨×” -->
                    <div style="background: rgba(33, 150, 243, 0.1); border: 1px solid #2196F3; padding: 20px; border-radius: 8px;">
                        <h5 style="color: #2196F3; margin-bottom: 15px;">ğŸ’¡ ×”×¦×¢×•×ª ×œ×©×™×¤×•×¨ ×”××¨×”</h5>
                        <ul style="text-align: right; list-style: none; padding: 0; color: #e0e0e0;">
                            <li style="margin: 8px 0; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                ğŸ”¥ ×—×™×–×•×§ ×§×¨×™××ª ×”×¤×¢×•×œ×” (Call to Action) - ×’×¨×¡ ×›×¤×ª×•×¨ WhatsApp ×™×•×ª×¨ ×‘×•×œ×˜
                            </li>
                            <li style="margin: 8px 0; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                ğŸ“± ×”×•×¡×¤×ª ×“×—×™×¤×•×ª - "×œ×—×¥ ×¢×›×©×™×• ×œ×§×‘×œ×ª ××¢× ×” ××™×™×“×™"
                            </li>
                            <li style="margin: 8px 0; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                ğŸ ×”×•×¡×¤×ª ×ª××¨×™×¥ - "×§×‘×œ ×™×™×¢×•×¥ ×¨××©×•× ×™ ×—×™× ×"
                            </li>
                            <li style="margin: 8px 0; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                ğŸ“Š A/B Testing - × ×¡×” ×•×¨×™××¦×™×•×ª ×©×•× ×•×ª ×©×œ ×”×¢××•×“
                            </li>
                            <li style="margin: 8px 0; padding: 8px 0;">
                                ğŸ’¬ ×”×•×¡×¤×ª ×”××œ×¦×•×ª ×œ×§×•×—×•×ª ××• ××¡×¤×¨ ×œ×§×•×—×•×ª ××¨×•×¦×™×
                            </li>
                        </ul>
                    </div>

                    <!-- ×‘× ×¦××¨×§ ×”×ª×¢×©×™×™×” -->
                    <div style="background: rgba(156, 39, 176, 0.1); border: 1px solid #9C27B0; padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center;">
                        <h6 style="color: #9C27B0; margin-bottom: 10px;">ğŸ“ˆ ×”×©×•×•××” ×œ×××•×¦×¢ ×”×ª×¢×©×™×™×”</h6>
                        <div style="font-size: 0.9em; color: #e0e0e0;">
                            <div>â€¢ ×©×™×¢×•×¨ ×”××¨×” ×˜×™×¤×•×¡×™ ×œ×¢××•×“×™ × ×—×™×ª×”: 2-5%</div>
                            <div>â€¢ ×©×™×¢×•×¨ ×”××¨×” ×˜×•×‘: 5-10%</div>
                            <div>â€¢ ×©×™×¢×•×¨ ×”××¨×” ××¢×•×œ×”: 10%+</div>
                            <div style="margin-top: 10px; font-weight: bold; color: ${parseFloat(realAbandonmentRate) > 90 ? '#F44336' : parseFloat(realAbandonmentRate) > 85 ? '#FF9800' : '#4CAF50'};">
                                ×”×©×™×¢×•×¨ ×©×œ×š (${(100 - parseFloat(realAbandonmentRate)).toFixed(1)}%): ${parseFloat(realAbandonmentRate) > 90 ? '× ××•×š - ×“×•×¨×© ×©×™×¤×•×¨' : parseFloat(realAbandonmentRate) > 85 ? '×‘×™× ×•× ×™' : '×˜×•×‘!'}
                            </div>
                            <div style="font-size: 0.8em; margin-top: 5px; color: #66BB6A;">
                                (××‘×•×¡×¡ ×¢×œ ${humanVisitors} ×œ×§×•×—×•×ª ×××™×ª×™×™× - ×œ×œ× ×‘×•×˜×™×)
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        // × ×™×ª×•×— × ×ª×•× ×™× ×§×™×™××™× ×œ×–×™×”×•×™ ×©×œ×‘×™ ×”××¨×”
        function analyzeExistingConversionData(results) {
            const summary = results.summary;
            const phoneStats = results.phoneNumberStats || {};
            
            let html = `
                <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px;">
                    <h4 style="color: #2196F3; margin-bottom: 20px; text-align: center;">ğŸ” ××” × ×™×ª×Ÿ ×œ×–×”×•×ª ××”× ×ª×•× ×™× ×”×§×™×™××™×</h4>
                    
                    <!-- ×¡×§×™×¨×ª ×”× ×ª×•× ×™× ×”×–××™× ×™× -->
                    <div style="background: rgba(33, 150, 243, 0.1); border: 1px solid #2196F3; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h5 style="color: #2196F3; margin-bottom: 15px;">ğŸ“Š × ×ª×•× ×™× ×–××™× ×™× ×‘××¢×¨×›×ª</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                            
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                <div style="color: #4CAF50; font-weight: bold; margin-bottom: 8px;">âœ… ××” ×™×© ×œ× ×•:</div>
                                <ul style="color: #e0e0e0; font-size: 0.9em; margin: 0; padding-right: 20px;">
                                    <li>×›× ×™×¡×•×ª ×œ×¢××•×“ (visits)</li>
                                    <li>×œ×—×™×¦×•×ª ×¢×œ ×›×¤×ª×•×¨ WhatsApp</li>
                                    <li>××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ ×©×œ ×”×§×œ×™×§×™×</li>
                                    <li>×–×× ×™ ×”×¤×¢×•×œ×•×ª (timestamps)</li>
                                    <li>×›×ª×•×‘×•×ª IP</li>
                                    <li>××§×•×¨ ×”×ª× ×•×¢×” (referrer)</li>
                                </ul>
                            </div>
                            
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">
                                <div style="color: #FF5722; font-weight: bold; margin-bottom: 8px;">âŒ ××” ×—×¡×¨ ×œ× ×•:</div>
                                <ul style="color: #e0e0e0; font-size: 0.9em; margin: 0; padding-right: 20px;">
                                    <li>×¤×ª×™×—×ª WhatsApp ×‘×¤×•×¢×œ</li>
                                    <li>×©×œ×™×—×ª ×”×•×“×¢×” ×¨××©×•× ×”</li>
                                    <li>×§×‘×œ×ª ××¢× ×”</li>
                                    <li>××•×¨×š ×”×©×™×—×”</li>
                                    <li>×”××¨×” ×œ×¢×¡×§×”</li>
                                    <li>×–××Ÿ ×©×”×™×™×” ×‘×¢××•×“</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- × ×™×ª×•×— ×“×¤×•×¡×™ ×”×ª× ×”×’×•×ª ×§×™×™××™× -->
                    <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid #FFC107; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h5 style="color: #FFC107; margin-bottom: 15px;">ğŸ•µï¸ ×“×¤×•×¡×™× ×—×©×•×“×™× ×©× ×™×ª×Ÿ ×œ×–×”×•×ª</h5>
                        ${analyzePhonePatterns(phoneStats)}
                    </div>

                    <!-- ×”×¦×¢×•×ª ×œ×©×™×¤×•×¨ ××™×¡×•×£ × ×ª×•× ×™× -->
                    <div style="background: rgba(156, 39, 176, 0.1); border: 1px solid #9C27B0; padding: 20px; border-radius: 8px;">
                        <h5 style="color: #9C27B0; margin-bottom: 15px;">ğŸ’¡ ××™×š ×œ×©×¤×¨ ××ª ××™×¡×•×£ ×”× ×ª×•× ×™×</h5>
                        <div style="text-align: right;">
                            <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                                <strong style="color: #BA68C8;">ğŸ“± ×”×•×¡×¤×ª ××¢×§×‘ WhatsApp:</strong>
                                <div style="font-size: 0.9em; color: #e0e0e0; margin-top: 5px;">
                                    ×©×™× ×•×™ ×”×œ×™× ×§ ×œ-WhatsApp ×›×š ×©×™×¢×‘×•×¨ ×“×¨×š ×”××ª×¨ ×©×œ×š ×œ×¤× ×™ ×”×”×¤× ×™×”
                                </div>
                            </div>
                            <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                                <strong style="color: #BA68C8;">â±ï¸ ××¢×§×‘ ×–××Ÿ ×©×”×™×™×”:</strong>
                                <div style="font-size: 0.9em; color: #e0e0e0; margin-top: 5px;">
                                    ×”×•×¡×¤×ª JavaScript ×œ××¢×§×‘ ××—×¨ ×–××Ÿ ×‘×¢××•×“ ×œ×¤× ×™ ×™×¦×™××”
                                </div>
                            </div>
                            <div style="margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                                <strong style="color: #BA68C8;">ğŸ“Š UTM Parameters:</strong>
                                <div style="font-size: 0.9em; color: #e0e0e0; margin-top: 5px;">
                                    ×”×•×¡×¤×ª ×¤×¨××˜×¨×™× ×œ×–×™×”×•×™ ××“×•×™×§ ×™×•×ª×¨ ×©×œ ××§×•×¨ ×”×ª× ×•×¢×”
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        // × ×™×ª×•×— ×“×¤×•×¡×™ ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ ×œ×–×™×”×•×™ ×”×ª× ×”×’×•×™×•×ª ×—×©×•×“×•×ª
        function analyzePhonePatterns(phoneStats) {
            if (!phoneStats || Object.keys(phoneStats).length === 0) {
                return '<div style="color: #ccc; text-align: center;">××™×Ÿ × ×ª×•× ×™ ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ ×œ× ×™×ª×•×—</div>';
            }

            const phones = Object.entries(phoneStats);
            let suspiciousPatterns = [];
            let normalPatterns = [];
            
            phones.forEach(([phone, stats]) => {
                const totalActions = stats.clicks + (stats.nonClicks || 0);
                const botRatio = stats.bots / Math.max(totalActions, 1);
                
                // ×–×™×”×•×™ ×“×¤×•×¡×™× ×—×©×•×“×™×
                if (stats.clicks > 5 && botRatio < 0.1) {
                    // ×”×¨×‘×” ×§×œ×™×§×™× ××‘×œ ××¢×˜ ×‘×•×˜×™× = ×—×©×•×“ ×œ×¤×¢×™×œ×•×ª ××•×˜×•××˜×™×ª
                    suspiciousPatterns.push({
                        phone,
                        reason: '×¤×¢×™×œ×•×ª ×—×©×•×“×” - ×”×¨×‘×” ×§×œ×™×§×™× ×œ×œ× ×–×™×”×•×™ ×‘×•×˜×™×',
                        clicks: stats.clicks,
                        severity: '×’×‘×•×”'
                    });
                } else if (stats.clicks === 1 && stats.nonClicks === 0) {
                    // ×œ×—×™×¦×” ×™×—×™×“×” ×œ×œ× ×¢×™×•×Ÿ × ×•×¡×£ = ×™×›×•×œ ×œ×”×™×•×ª ×œ×—×™×¦×” ××§×¨×™×ª
                    suspiciousPatterns.push({
                        phone,
                        reason: '×œ×—×™×¦×” ×™×—×™×“×” ×œ×œ× ×¢×™×•×Ÿ × ×•×¡×£ - ×™×›×•×œ ×œ×”×™×•×ª ××§×¨×™',
                        clicks: stats.clicks,
                        severity: '× ××•×š'
                    });
                } else if (stats.clicks > 0 && stats.bots === 0 && stats.humans > 0) {
                    // ×¤×¢×™×œ×•×ª × ×•×¨××œ×™×ª
                    normalPatterns.push({
                        phone,
                        clicks: stats.clicks,
                        engagement: '×˜×•×‘'
                    });
                }
            });

            let html = '';
            
            if (suspiciousPatterns.length > 0) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h6 style="color: #FF7043; margin-bottom: 10px;">âš ï¸ ×“×¤×•×¡×™× ×—×©×•×“×™× ×©× ××¦××•:</h6>
                        <div style="max-height: 200px; overflow-y: auto;">
                `;
                
                suspiciousPatterns.forEach(pattern => {
                    const severityColor = pattern.severity === '×’×‘×•×”' ? '#F44336' : '#FF9800';
                    html += `
                        <div style="margin: 5px 0; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 5px; border-right: 3px solid ${severityColor};">
                            <div style="font-weight: bold; color: ${severityColor};">${pattern.phone}</div>
                            <div style="font-size: 0.85em; color: #ccc;">${pattern.reason} (${pattern.clicks} ×§×œ×™×§×™×)</div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }
            
            if (normalPatterns.length > 0) {
                html += `
                    <div>
                        <h6 style="color: #4CAF50; margin-bottom: 10px;">âœ… ×¤×¢×™×œ×•×ª × ×•×¨××œ×™×ª:</h6>
                        <div style="color: #81C784; font-size: 0.9em;">
                            ${normalPatterns.length} ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ ×¢× ×¤×¢×™×œ×•×ª ×ª×§×™× ×”
                        </div>
                    </div>
                `;
            }
            
            if (suspiciousPatterns.length === 0 && normalPatterns.length === 0) {
                html = '<div style="color: #ccc; text-align: center;">×œ× × ××¦××• ×“×¤×•×¡×™× ××™×•×—×“×™× ×‘× ×ª×•× ×™×</div>';
            }

            return html;
        }

        // ×™×¦×™×¨×ª ×’×¨×£ ×¢×•×’×” ××ª×§×“×
        function createAdvancedPieChart(summary) {
            const total = summary.botCount + summary.humanCount + (summary.unknownCount || 0);
            if (total === 0) return '<div style="color: #ccc;">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</div>';

            const botPerc = (summary.botCount / total) * 100;
            const humanPerc = (summary.humanCount / total) * 100;
            const unknownPerc = ((summary.unknownCount || 0) / total) * 100;
            
            return `
                <div style="display: flex; justify-content: center; align-items: center; gap: 30px; flex-wrap: wrap;">
                    <div style="width: 120px; height: 120px; border-radius: 50%; background: conic-gradient(
                        #ff6b6b 0deg ${botPerc * 3.6}deg,
                        #4ecdc4 ${botPerc * 3.6}deg ${(botPerc + humanPerc) * 3.6}deg,
                        #ffa726 ${(botPerc + humanPerc) * 3.6}deg 360deg
                    ); position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255,255,255,0.9); color: #333; width: 70px; height: 70px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px;">
                            ${total.toLocaleString()}
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div style="margin: 8px 0; display: flex; align-items: center; gap: 10px;">
                            <span style="width: 20px; height: 20px; background: #ff6b6b; border-radius: 50%; display: inline-block;"></span>
                            <span>×‘×•×˜×™×: ${summary.botCount.toLocaleString()} (${botPerc.toFixed(1)}%)</span>
                        </div>
                        <div style="margin: 8px 0; display: flex; align-items: center; gap: 10px;">
                            <span style="width: 20px; height: 20px; background: #4ecdc4; border-radius: 50%; display: inline-block;"></span>
                            <span>×‘× ×™ ××“×: ${summary.humanCount.toLocaleString()} (${humanPerc.toFixed(1)}%)</span>
                        </div>
                        ${summary.unknownCount ? `
                        <div style="margin: 8px 0; display: flex; align-items: center; gap: 10px;">
                            <span style="width: 20px; height: 20px; background: #ffa726; border-radius: 50%; display: inline-block;"></span>
                            <span>×œ× ××–×•×”×”: ${summary.unknownCount.toLocaleString()} (${unknownPerc.toFixed(1)}%)</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ×™×¦×™×¨×ª ×¢×•×’×” ×¤×©×•×˜×” (CSS)
        function createPieChart(summary) {
            const total = summary.botCount + summary.humanCount + summary.unknownCount;
            if (total === 0) return '<div>××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</div>';

            const botPerc = (summary.botCount / total) * 100;
            const humanPerc = (summary.humanCount / total) * 100;
            
            return `
                <div style="text-align: center;">
                    <div style="width: 120px; height: 120px; border-radius: 50%; background: conic-gradient(
                        #f44336 0% ${botPerc}%, 
                        #4CAF50 ${botPerc}% ${botPerc + humanPerc}%, 
                        #9E9E9E ${botPerc + humanPerc}% 100%
                    ); margin: 0 auto 20px;"></div>
                    <div style="font-size: 0.9em;">
                        <div style="color: #f44336;">ğŸ¤– ×‘×•×˜×™×: ${summary.botCount}</div>
                        <div style="color: #4CAF50;">ğŸ‘¥ ×‘× ×™ ××“×: ${summary.humanCount}</div>
                        <div style="color: #9E9E9E;">â“ ×œ× ×‘×¨×•×¨: ${summary.unknownCount}</div>
                    </div>
                </div>
            `;
        }

        // ×™×¦×™×¨×ª ×¨×©×™××ª ×”×ª×¤×œ×’×•×ª
        function createDistributionList(distribution, limit = 10) {
            const entries = Object.entries(distribution)
                .sort((a, b) => b[1] - a[1])
                .slice(0, limit);
            
            let html = '<div style="text-align: right;">';
            entries.forEach(([key, count]) => {
                const percentage = Object.values(distribution).reduce((a, b) => a + b, 0);
                const perc = ((count / percentage) * 100).toFixed(1);
                html += `
                    <div style="display: flex; justify-content: space-between; margin: 8px 0; padding: 5px; background: rgba(255,255,255,0.05); border-radius: 3px;">
                        <span><strong>${count}</strong> (${perc}%)</span>
                        <span style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${key}</span>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        // ×™×¦×™×¨×ª ×”×ª×¤×œ×’×•×ª ×–××Ÿ
        function createTimeDistribution(timeDistribution) {
            let html = '<div style="text-align: right;">';
            
            for (let hour = 0; hour < 24; hour++) {
                const count = timeDistribution[hour] || 0;
                const maxCount = Math.max(...Object.values(timeDistribution));
                const width = maxCount > 0 ? (count / maxCount) * 100 : 0;
                
                html += `
                    <div style="display: flex; align-items: center; margin: 3px 0;">
                        <span style="width: 40px; text-align: left;">${count}</span>
                        <div style="flex: 1; background: rgba(255,255,255,0.1); margin: 0 10px; border-radius: 3px; height: 20px; position: relative;">
                            <div style="background: #4CAF50; width: ${width}%; height: 100%; border-radius: 3px;"></div>
                        </div>
                        <span style="width: 50px; text-align: right;">${hour}:00</span>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×” ×¡×¤×¦×™×¤×™×ª ×©×œ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ - ×œ×¤×ª×¨×•×Ÿ ×‘×¢×™×™×ª ×”×–×™×”×•×™
        function testPhoneNumberDetection(phoneNumber, logs) {
            console.log(`×°ï¸âƒ£ ×‘×“×™×§×ª ×–×™×”×•×™ ×œ××¡×¤×¨: ${phoneNumber}`);
            
            const phoneData = logs.find(entry => entry.phone_number === phoneNumber);
            if (!phoneData) {
                return console.error(`âŒ ××¡×¤×¨ ${phoneNumber} ×œ× × ××¦× ×‘× ×ª×•× ×™×`);
            }
            
            console.log(`âœ… ××¦××ª×™ × ×ª×•× ×™× ×¢×‘×•×¨ ${phoneNumber}:`);
            console.log(`  - ${(phoneData.clicks || []).length} ×œ×—×™×¦×•×ª`);
            console.log(`  - ${(phoneData.non_click_requests || []).length} ×¦×¤×™×•×ª`);
            
            let bots = 0, humans = 0, suspicious = 0;
            
            // ×‘×“×™×§×ª ×›×œ ×œ×—×™×¦×” ×¢× ×”×œ×•×’×™×§×” ×”××©×•×¤×¨×ª
            (phoneData.clicks || []).forEach((click, index) => {
                const ipAnalysis = analyzeComplexLogEntry(click, 'click', phoneNumber);
                const behaviorAnalysis = analyzeBehaviorPatterns(click, 'click', phoneNumber, [...(phoneData.clicks || []), ...(phoneData.non_click_requests || [])]);
                const finalResult = combineAnalysisResults(ipAnalysis, behaviorAnalysis);
                
                console.log(`  ğŸ“ ×œ×—×™×¦×” #${index + 1}:`);
                console.log(`    IP: ${click.ip_address}`);
                console.log(`    ×–××Ÿ: ${click.timestamp}`);
                console.log(`    ×™×¢×“: ${click.destination}`);
                console.log(`    ×ª×•×¦××”: ${finalResult.isBot ? 'ğŸ¤– ×‘×•×˜' : finalResult.isHuman ? 'ğŸ‘¤ ×× ×•×©' : 'â“ ×—×©×•×“'}`);
                console.log(`    ×¡×™×‘×•×ª: ${finalResult.detectionMethods.join(', ')}`);
                console.log(`    ×‘×˜×—×•×Ÿ: ${finalResult.confidence}%`);
                
                if (finalResult.isBot) bots++;
                else if (finalResult.isHuman) humans++;
                if (finalResult.isSuspicious) suspicious++;
            });
            
            console.log(`\nğŸ“Š ×¡×™×›×•× ×¢×‘×•×¨ ${phoneNumber}:`);
            console.log(`  ğŸ¤– ×‘×•×˜×™×: ${bots}`);
            console.log(`  ğŸ‘¤ ×× ×©×™×: ${humans}`);
            console.log(`  â“ ×—×©×•×“×™×: ${suspicious}`);
            
            const total = (phoneData.clicks || []).length;
            if (total > 0) {
                console.log(`  ××—×•×– ×‘×•×˜×™×: ${Math.round((bots / total) * 100)}%`);
                console.log(`  ××—×•×– ×× ×©×™×: ${Math.round((humans / total) * 100)}%`);
            }
            
            return { bots, humans, suspicious, total };
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ×›×œ ×”××¡×¤×¨×™×
        function validateAllPhoneNumbers(logs) {
            console.log('ğŸ” ×‘×“×™×§×ª ×–×™×”×•×™ ×œ×›×œ ×”××¡×¤×¨×™×...');
            
            logs.forEach(entry => {
                if (entry.phone_number) {
                    testPhoneNumberDetection(entry.phone_number, logs);
                    console.log('---');
                }
            });
        }
        
        // ×§×¨×™××” ×œ×¤×•× ×§×¦×™×•×ª - × ×™×ª×Ÿ ×œ×”×©×ª××© ×‘×§×•× ×¡×•×œ
        // testPhoneNumberDetection('972524727412', currentLogsData);
        // validateAllPhoneNumbers(currentLogsData);
        
    </script>
</body>
</html>
